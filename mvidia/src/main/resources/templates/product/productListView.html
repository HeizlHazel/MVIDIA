<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA · ERP - 생산품질 · 제품 현황 조회</title>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <!-- jQuery UI (autocomplete 기능 제공) -->
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <style>
        /* 전체 컨테이너 */
        .innerOuter {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 1200px;
            margin: 0 auto;
        }

        h2 {
            margin-bottom: 20px;
            color: #333;
        }

        /* 검색 폼 */
        #searchForm {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        #searchForm input[type="text"] {
            padding: 8px 12px;
            border: 1px solid #dee0ea;
            border-radius: 6px;
            font-size: 14px;
            flex: 1;
            box-sizing: border-box;
        }

        #searchForm button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: #186AEA;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #searchForm button:hover {
            background-color: #0056d3;
        }

        /* 테이블 스타일 */
        .table-container {
            background: #fff;
            border: 1px solid #dee0ea;
            border-radius: 8px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            padding: 15px 12px;
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee0ea;
            text-align: center;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            text-align: center;
            color: #555;
            vertical-align: middle;
        }

        tr:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        .title-col {
            text-align: left !important;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .title-link {
            color: #333;
            text-decoration: none;
            font-weight: 500;
        }

        .title-link:hover {
            color: #007bff;
            text-decoration: underline;
        }

        /* 페이징 */
        #pagingArea {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #pagingArea ul {
            display: flex;
            list-style: none;
            padding: 0;
            gap: 5px;
        }

        #pagingArea li {
            display: inline-block;
        }

        #pagingArea li a {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #6c757d;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        #pagingArea li a:hover {
            background-color: #e9ecef;
            color: #007bff;
        }

        #pagingArea li.active a {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        #pagingArea li.disabled a {
            color: #adb5bd;
            pointer-events: none;
        }
        /* 상태 배지 공통 스타일 - JavaScript 동적 생성용 */
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
            min-width: 50px;
        }

        .status-normal {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-shortage {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
<div class="innerOuter">
    <h2>제품 현황 조회</h2>

    <!-- 검색 폼 -->
    <form id="searchForm" autocomplete="off">
        <input type="text" name="keyword" id="searchBox"
               placeholder="제품코드 또는 제품명을 검색하시오."
               th:value="${keyword}" list="productList">
        <datalist id="productList">
            <option th:each="p : ${list}" th:value="${p.prodCode} + ' | ' + ${p.prodName}"></option>
        </datalist>
        <button type="submit">검색</button>
    </form>

    <!-- 테이블 영역 -->
    <div class="table-container" id="tableArea" th:include="~{fragments/productTable :: prodTable}"></div>

    <!-- 페이징 - 기존 Thymeleaf 방식 삭제하고 아래로 교체 -->
    <div id="pagingArea">
        <ul class="pagination">
            <li th:classappend="${pi.currentPage == 1} ? 'disabled'">
                <a href="javascript:void(0);"
                   th:attr="data-page=${pi.currentPage > 1 ? pi.currentPage-1 : 1}">이전</a>
            </li>
            <li th:each="pageNum : ${#numbers.sequence(pi.startPage, pi.endPage)}"
                th:classappend="${pageNum == pi.currentPage} ? 'active'">
                <a href="javascript:void(0);"
                   th:attr="data-page=${pageNum}"
                   th:text="${pageNum}"></a>
            </li>
            <li th:classappend="${pi.currentPage == pi.maxPage} ? 'disabled'">
                <a href="javascript:void(0);"
                   th:attr="data-page=${pi.currentPage < pi.maxPage ? pi.currentPage+1 : pi.maxPage}">다음</a>
            </li>
        </ul>
    </div>

<script>
    // 전역 변수 - Thymeleaf 값이 제대로 안 들어올 수 있으므로 기본값 명시
    let currentKeyword = '[[${keyword}]]' || '';

    // 페이지 로드 시 실행
    document.addEventListener('DOMContentLoaded', function() {
        // currentKeyword 초기화 확인
        console.log('초기 keyword:', currentKeyword);

        // 페이지네이션 링크에 이벤트 연결
        bindPaginationEvents();
    });

    // 검색 폼 제출
    document.querySelector("#searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        let form = e.target;
        let keyword = form.keyword.value.trim();

        if(keyword.includes("|")){
            keyword = keyword.split("|")[0].trim();
        }

        currentKeyword = keyword;
        searchProducts(1, keyword);
    });

    // 검색 실행 함수
    function searchProducts(cpage, keyword) {
        console.log('searchProducts 호출:', cpage, keyword); // 디버깅용

        fetch(`/search-products.bo?cpage=${cpage}&keyword=${encodeURIComponent(keyword)}`)
            .then(resp => {
                if(!resp.ok) {
                    throw new Error('서버 응답 오류: ' + resp.status);
                }
                return resp.json();
            })
            .then(data => {
                console.log('받은 데이터:', data); // 디버깅용
                updateTable(data.list);
                updatePagination(data.pi, keyword);
            })
            .catch(error => {
                console.error('검색 중 오류 발생:', error);
                alert('검색 중 오류가 발생했습니다: ' + error.message);
            });
    }

    // 테이블 업데이트 함수
    function updateTable(list) {
        const tbody = document.querySelector('#tableArea table tbody');

        if(!tbody) {
            console.error('tbody를 찾을 수 없습니다');
            return;
        }

        tbody.innerHTML = '';

        if(list.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5">검색 결과가 없습니다.</td></tr>';
            return;
        }

        list.forEach(p => {
            let statusClass = '';
            let statusText = p.statusName || '';

            if(statusText === '정상') statusClass = 'status-normal';
            else if(statusText === '주의') statusClass = 'status-warning';
            else if(statusText === '부족') statusClass = 'status-shortage';

            const row = `
                <tr>
                    <td>${p.prodCode || ''}</td>
                    <td>${p.prodName || ''}</td>
                    <td>${p.price || ''}</td>
                    <td>${p.stock || ''}</td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            ${statusText}
                        </span>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // 페이지네이션 업데이트 함수
    // 페이지네이션 업데이트 함수 (innerHTML 방식 유지)
function updatePagination(pi, keyword) {
    const pagination = document.querySelector('#pagingArea .pagination');

    if(!pagination) {
        console.error('pagination을 찾을 수 없습니다');
        return;
    }

    let html = '';

    // 이전 버튼
    const prevDisabled = pi.currentPage === 1 ? 'disabled' : '';
    const prevPage = pi.currentPage > 1 ? pi.currentPage - 1 : 1;
    html += `<li class="${prevDisabled}"><a href="#" data-page="${prevPage}">이전</a></li>`;

    // 페이지 번호
    for(let i = pi.startPage; i <= pi.endPage; i++) {
        const activeClass = i === pi.currentPage ? 'active' : '';
        html += `<li class="${activeClass}"><a href="#" data-page="${i}">${i}</a></li>`;
    }

    // 다음 버튼
    const nextDisabled = pi.currentPage === pi.maxPage ? 'disabled' : '';
    const nextPage = pi.currentPage < pi.maxPage ? pi.currentPage + 1 : pi.maxPage;
    html += `<li class="${nextDisabled}"><a href="#" data-page="${nextPage}">다음</a></li>`;

    pagination.innerHTML = html;

    // 페이지네이션 이벤트 재연결
    bindPaginationEvents();
}

    // 페이지네이션 클릭 이벤트 연결
    function bindPaginationEvents() {
        document.querySelectorAll('#pagingArea .pagination a').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();

                // disabled 상태면 무시
                if(this.parentElement.classList.contains('disabled')) {
                    return;
                }

                const page = parseInt(this.dataset.page);
                console.log('페이지 클릭:', page, 'keyword:', currentKeyword); // 디버깅용
                searchProducts(page, currentKeyword);
            });
        });
    }

    // 제품 등록 완료 후 동일한 방식으로 갱신 트리거
    function afterProductRegistration() {
        localStorage.setItem('dashboardRefresh', Date.now());
    }
</script>
</body>
</html>
