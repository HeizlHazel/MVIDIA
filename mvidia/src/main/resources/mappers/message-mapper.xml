<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="messageMapper">

    <!-- 수신함 메시지 목록 조회 -->
    <select id="selectInboxMessages" resultType="map">
        SELECT * FROM (
        SELECT ROWNUM rnum, sub.* FROM (
        SELECT
        mb.MSG_ID as "msgId",
        mb.TITLE as "title",
        COALESCE(e.EMP_NAME, mb.SENDER_NO) as "senderName",
        mb.SEND_DATE as "sendDate",
        mr.READ_YN as "readYn",
        mr.IMPORT_YN as "importYn"
        FROM TB_MESSAGE_BOX mb
        JOIN TB_MESSAGE_RCPT mr ON mb.MSG_ID = mr.MSG_ID
        LEFT JOIN TB_EMPLOYEE e ON mb.SENDER_NO = e.EMP_NO
        WHERE mr.RECEIVER_NO = #{receiverNo}
        <if test="filter == 'unread'">
            AND mr.READ_YN = 'N'
        </if>
        <if test="filter == 'important'">
            AND mr.IMPORT_YN = 'Z'
        </if>
        ORDER BY mb.SEND_DATE DESC
        ) sub
        WHERE ROWNUM &lt;= #{offset} + #{pageSize}
        )
        WHERE rnum &gt; #{offset}
    </select>

    <!-- 수신함 메시지 개수 -->
    <select id="selectInboxMessageCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_MESSAGE_BOX mb
        JOIN TB_MESSAGE_RCPT mr ON mb.MSG_ID = mr.MSG_ID
        WHERE mr.RECEIVER_NO = #{receiverNo}
        <if test="filter == 'unread'">
            AND mr.READ_YN = 'N'
        </if>
        <if test="filter == 'important'">
            AND mr.IMPORT_YN = 'Z'
        </if>
    </select>

    <!-- 메시지 상세 조회 -->
    <select id="selectMessageDetail" resultType="map">
        SELECT
        mb.MSG_ID as "msgId",
        mb.SENDER_NO as "senderNo",
        COALESCE(e.EMP_NAME, mb.SENDER_NO, '알 수 없음') as "senderName",
        COALESCE(mb.TITLE, '제목 없음') as "title",
        COALESCE(mb.CONTENT, '내용 없음') as "content",
        mb.SEND_DATE as "sendDate",
        mr.READ_YN as "readYn",
        mr.IMPORT_YN as "importYn"
        FROM TB_MESSAGE_BOX mb
        JOIN TB_MESSAGE_RCPT mr ON mb.MSG_ID = mr.MSG_ID
        LEFT JOIN TB_EMPLOYEE e ON mb.SENDER_NO = e.EMP_NO
        WHERE mb.MSG_ID = #{msgId}
        AND mr.RECEIVER_NO = #{receiverNo}
    </select>

    <!-- 읽음 상태 업데이트 -->
    <update id="updateReadStatus">
        UPDATE TB_MESSAGE_RCPT
        SET READ_YN = 'S'
        WHERE MSG_ID = #{msgId} AND RECEIVER_NO = #{receiverNo}
    </update>


    <!-- 중요도 상태 조회 -->
    <select id="selectImportantStatus" resultType="string">
        SELECT IMPORT_YN
        FROM TB_MESSAGE_RCPT
        WHERE MSG_ID = #{msgId} AND RECEIVER_NO = #{receiverNo}
    </select>

    <!-- 중요도 상태 업데이트 -->
    <update id="updateImportantStatus">
        UPDATE TB_MESSAGE_RCPT
        SET IMPORT_YN = #{importYn}
        WHERE MSG_ID = #{msgId} AND RECEIVER_NO = #{receiverNo}
    </update>

    <!-- 메시지 삭제 -->
    <update id="deleteMessage">
        UPDATE TB_MESSAGE_RCPT
        SET DEL_YN = 'Y'
        WHERE MSG_ID = #{msgId} AND RECEIVER_NO = #{receiverNo}
    </update>

    <!-- 메시지박스 삽입 -->
    <insert id="insertMessageBox">
        INSERT INTO TB_MESSAGE_BOX (MSG_ID, SENDER_NO, TITLE, CONTENT, SEND_DATE)
        VALUES (SEQ_MSG.NEXTVAL, #{senderNo}, #{title}, #{content}, SYSDATE)
    </insert>

    <!-- 현재 메시지 ID 조회 -->
    <select id="selectCurrMessageId" resultType="string">
        SELECT 'MSG' || LPAD(SEQ_MSG.CURRVAL, 4, '0') FROM DUAL
    </select>

    <!-- 메시지 수신자 삽입 -->
    <insert id="insertMessageRcpt">
        INSERT INTO TB_MESSAGE_RCPT (MSG_ID, RECEIVER_NO, READ_YN, IMPORT_YN, DEL_YN)
        VALUES (#{msgId}, #{receiverNo}, 'N', 'N', 'N')
    </insert>

    <!-- 전체 사원 조회 -->
    <select id="findAllEmployees" resultType="com.kh.mvidia.employee.model.vo.Employee">
        SELECT EMP_NO as empNo, EMP_NAME as empName, EMP_LNAME as empLName,
        DEPT_NAME as deptName, JOB_NAME as jobName
        FROM TB_EMPLOYEE
        WHERE DEL_YN = 'N'
        ORDER BY EMP_NAME
    </select>

    <!-- 발신함 메시지 목록 조회 -->
    <select id="selectOutboxMessages" resultType="map">
        SELECT * FROM (
        SELECT ROWNUM rnum, sub.* FROM (
        SELECT
        mb.MSG_ID AS "msgId",
        mb.TITLE AS "title",
        mb.SEND_DATE AS "sendDate",
        mb.CONTENT AS "content",
        (SELECT COUNT(*) FROM TB_MESSAGE_RCPT r WHERE r.MSG_ID = mb.MSG_ID) AS "receiverCount",
        COALESCE(e.EMP_NAME, r.RECEIVER_NO) AS "firstReceiverName"
        FROM TB_MESSAGE_BOX mb
        LEFT JOIN (
        SELECT
        MSG_ID,
        RECEIVER_NO,
        ROW_NUMBER() OVER(PARTITION BY MSG_ID ORDER BY RECEIVER_NO) AS rn
        FROM TB_MESSAGE_RCPT
        ) r ON mb.MSG_ID = r.MSG_ID AND r.rn = 1
        LEFT JOIN TB_EMPLOYEE e ON r.RECEIVER_NO = e.EMP_NO
        WHERE mb.SENDER_NO = #{senderNo}
        ORDER BY mb.SEND_DATE DESC
        ) sub
        WHERE ROWNUM &lt;= #{offset} + #{pageSize}
        )
        WHERE rnum &gt; #{offset}
    </select>


    <!-- 발신함 메시지 개수 조회 -->
    <select id="selectOutboxMessageCount" resultType="int">
        SELECT COUNT(*)
        FROM TB_MESSAGE_BOX
        WHERE SENDER_NO = #{senderNo}
    </select>

    <!-- 발신 메시지 상세 조회 -->
    <select id="selectSentMessageDetail" resultType="map">
        SELECT
        mb.MSG_ID AS "msgId",
        mb.TITLE AS "title",
        mb.CONTENT AS "content",
        mb.SEND_DATE AS "sendDate"
        FROM TB_MESSAGE_BOX mb
        WHERE mb.MSG_ID = #{msgId}
    </select>

    <!-- 발신 메시지 수신자 조회 -->
    <select id="selectMessageReceivers" resultType="map">
        SELECT
        mr.RECEIVER_NO AS "empNo",
        COALESCE(e.EMP_NAME, mr.RECEIVER_NO) AS "empName"
        FROM TB_MESSAGE_RCPT mr
        LEFT JOIN TB_EMPLOYEE e ON mr.RECEIVER_NO = e.EMP_NO
        WHERE mr.MSG_ID = #{msgId}
    </select>

</mapper>
