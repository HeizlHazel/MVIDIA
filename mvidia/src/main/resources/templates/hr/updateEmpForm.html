<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>ì‚¬ì› ì •ë³´ ë³€ê²½</title>
    <style>
        .accountCreate { grid-column: 2; grid-row: 2; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); }
        .accountCreate > .widget { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, .1); }
        .form { display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 14px; }
        .profile-section { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }
        .file-input-group { flex-grow: 1; }
        .form .field { display: flex; flex-direction: column; gap: 8px; }
        .form label { font-size: 12px; color: var(--muted); }
        .form input, .form select, .form textarea { padding: 10px 12px; border-radius: 12px; border: 1px solid #dde6ec; background: #fff; outline: none; }
        .form input[readonly] { background: #f1f5f8; color: #6f7c83; }
        .form .full { grid-column: 1 / -1; }
        .form .actions { grid-column: 1 / -1; display: flex; gap: 8px; margin-top: 6px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; background-color: #0c197f; color: #fff; }
        .btn.ghost { background: transparent; color: #002B39; border: 1px solid #002B39; }
        .updated-badge { font-size: .7rem; color: #fff; background: #28a745; padding: 2px 6px; border-radius: 8px; margin-left: 5px; vertical-align: middle; }
        .rejected-badge { font-size: .7rem; color: #fff; background: #dc3545; padding: 2px 6px; border-radius: 8px; margin-left: 5px; vertical-align: middle; display: none; }
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, .4); }
        .modal-content { background: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, .2); }
        .error-msg { color: #d9534f; font-size: 10px; display: none; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="accountCreate">
        <h2 class="page-title">ğŸ– ì‚¬ì› ì •ë³´ ë³€ê²½</h2>
        <div class="widget" id="home">
            <form th:action="@{/hr/updateEmp.hr}" class="form" method="post" id="updateForm" enctype="multipart/form-data">

                <th:block th:with="profileReq=${reqList != null ? reqList.?[fieldName == 'profilePic'] : new java.util.ArrayList()}">
                    <div class="profile-section">
                        <img id="profile-preview" class="profile-pic"
                             th:src="${profileReq.isEmpty()} ? @{/images/default_profile.png} : @{/uploadFiles/{fileName}(fileName=${profileReq[0].newValue})}"
                             th:data-original-url="${profileReq.isEmpty()} ? @{/images/default_profile.png} : @{/uploadFiles/{fileName}(fileName=${profileReq[0].oldValue})}"
                             th:data-new-url="${profileReq.isEmpty()} ? @{/images/default_profile.png} : @{/uploadFiles/{fileName}(fileName=${profileReq[0].newValue})}"
                             alt="í”„ë¡œí•„"/>

                        <div class="file-input-group">
                            <div th:if="${!profileReq.isEmpty()}" style="margin-bottom:10px;">
                                <button type="button" class="btn ghost" id="originalPicBtn">ê¸°ì¡´ í”„ë¡œí•„</button>
                                <button type="button" class="btn ghost" id="newPicBtn">ë³€ê²½ë  í”„ë¡œí•„</button>
                            </div>
                            <label style="margin-right:10px;"
                                   th:text="${atch != null && atch.originName != null ? atch.originName : 'í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ ì²¨ë¶€'}">í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ ì²¨ë¶€</label>
                            <br>
                            <span>ë³€ê²½í•  í”„ë¡œí•„ ì‚¬ì§„ : </span>
                            <input name="atchFile" type="file" accept="image/*" onchange="previewProfilePic(event)"
                                   th:data-req-id="${profileReq.isEmpty()} ? null : 'profilePic'"/>
                            <span th:unless="${profileReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                            <span class="rejected-badge">ê±°ì ˆë¨</span>
                        </div>
                    </div>
                </th:block>

                <div class="field full"><label>ì‚¬ë²ˆ*</label><input name="empNo" th:value="${emp.empNo}" readonly/></div>
                <div class="field full"><label>ì´ë©”ì¼*</label><input name="email" type="email" th:value="${emp.email}" readonly/></div>

                <th:block th:with="lNameReq=${reqList != null ? reqList.?[fieldName == 'empLName'] : new java.util.ArrayList()}">
                    <div class="field field-row">
                        <label>ì„±*</label>
                        <input name="empLName" required oninput="validateName('korean')"
                               th:value="${!lNameReq.isEmpty() ? lNameReq[0].newValue : emp.empLName}"
                               th:data-req-id="${lNameReq.isEmpty()} ? null : 'empLName'"
                               th:data-original-value="${!lNameReq.isEmpty() ? lNameReq[0].newValue : emp.empLName}"/>
                        <span id="korean-name-error" class="error-msg">í•œê¸€ ì„±/ì´ë¦„ì€ í•œê¸€ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span th:if="${!lNameReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="nameReq=${reqList != null ? reqList.?[fieldName == 'empName'] : new java.util.ArrayList()}">
                    <div class="field field-row">
                        <label>ì´ë¦„*</label>
                        <input name="empName" required oninput="validateName('korean')"
                               th:value="${!nameReq.isEmpty() ? nameReq[0].newValue : emp.empName}"
                               th:data-req-id="${nameReq.isEmpty()} ? null : 'empName'"
                               th:data-original-value="${!nameReq.isEmpty() ? nameReq[0].newValue : emp.empName}"/>
                        <span id="korean-name-error-2" class="error-msg">í•œê¸€ ì„±/ì´ë¦„ì€ í•œê¸€ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span th:if="${!nameReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="engLNameReq=${reqList != null ? reqList.?[fieldName == 'empEngLName'] : new java.util.ArrayList()}">
                    <div class="field field-row">
                        <label>ì˜ë¬¸ ì„±*</label>
                        <input name="empEngLName" required oninput="validateName('english')"
                               th:value="${!engLNameReq.isEmpty() ? engLNameReq[0].newValue : emp.empEngLName}"
                               th:data-req-id="${engLNameReq.isEmpty()} ? null : 'empEngLName'"
                               th:data-original-value="${!engLNameReq.isEmpty() ? engLNameReq[0].newValue : emp.empEngLName}"/>
                        <span id="english-name-error" class="error-msg">ì˜ë¬¸ ì„±/ì´ë¦„ì€ ì•ŒíŒŒë²³ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span th:if="${!engLNameReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="engNameReq=${reqList != null ? reqList.?[fieldName == 'empEngName'] : new java.util.ArrayList()}">
                    <div class="field field-row">
                        <label>ì˜ë¬¸ ì´ë¦„*</label>
                        <input name="empEngName" required oninput="validateName('english')"
                               th:value="${!engNameReq.isEmpty() ? engNameReq[0].newValue : emp.empEngName}"
                               th:data-req-id="${engNameReq.isEmpty()} ? null : 'empEngName'"
                               th:data-original-value="${!engNameReq.isEmpty() ? engNameReq[0].newValue : emp.empEngName}"/>
                        <span id="english-name-error-2" class="error-msg">ì˜ë¬¸ ì„±/ì´ë¦„ì€ ì•ŒíŒŒë²³ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span th:if="${!engNameReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="birthdayReq=${reqList != null ? reqList.?[fieldName == 'birthday'] : new java.util.ArrayList()}">
                    <div class="field field-row">
                        <label>ìƒë…„ì›”ì¼*</label>
                        <input name="birthday" type="date" required
                               th:value="${!birthdayReq.isEmpty() ? birthdayReq[0].newValue : emp.birthday}"
                               th:data-req-id="${birthdayReq.isEmpty()} ? null : 'birthday'"
                               th:data-original-value="${!birthdayReq.isEmpty() ? birthdayReq[0].newValue : emp.birthday}"/>
                        <span th:if="${!birthdayReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <div class="field"><label>ë¶€ì„œ*</label>
                    <select name="deptCode" disabled>
                        <option value="">ì„ íƒ</option>
                        <option value="D1" th:selected="${emp.deptCode == 'D1'}">ì¸ì‚¬íŒ€</option>
                        <option value="D2" th:selected="${emp.deptCode == 'D2'}">ê²½ì˜ê´€ë¦¬íŒ€</option>
                        <option value="D3" th:selected="${emp.deptCode == 'D3'}">ìƒì‚°í’ˆì§ˆê´€ë¦¬íŒ€</option>
                        <option value="D4" th:selected="${emp.deptCode == 'D4'}">ê¸°ìˆ ì§€ì›íŒ€</option>
                    </select>
                </div>

                <div class="field"><label>ì§ê¸‰*</label>
                    <select name="jobName" disabled>
                        <option value="">ì„ íƒ</option>
                        <option th:selected="${emp.jobName.endsWith('ì‚¬ì›')}" value="1">ì‚¬ì›</option>
                        <option th:selected="${emp.jobName.endsWith('ëŒ€ë¦¬')}" value="2">ëŒ€ë¦¬</option>
                        <option th:selected="${emp.jobName.endsWith('ê³¼ì¥')}" value="3">ê³¼ì¥</option>
                        <option th:selected="${emp.jobName.endsWith('ì°¨ì¥')}" value="4">ì°¨ì¥</option>
                        <option th:selected="${emp.jobName.endsWith('ë¶€ì¥')}" value="5">ë¶€ì¥</option>
                    </select>
                </div>

                <th:block th:with="addressReq=${reqList != null ? reqList.?[fieldName == 'address'] : new java.util.ArrayList()}">
                    <div class="field field-row full">
                        <label>ì£¼ì†Œ*</label>
                        <input name="address" required
                               th:value="${!addressReq.isEmpty() ? addressReq[0].newValue : emp.address}"
                               th:data-req-id="${addressReq.isEmpty()} ? null : 'address'"
                               th:data-original-value="${!addressReq.isEmpty() ? addressReq[0].newValue : emp.address}"/>
                        <span th:if="${!addressReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="phoneReq=${reqList != null ? reqList.?[fieldName == 'phone'] : new java.util.ArrayList()}">
                    <div class="field field-row">
                        <label>ì „í™”ë²ˆí˜¸*</label>
                        <input name="phone" required placeholder="010-0000-0000" pattern="^01[016789]-\d{3,4}-\d{4}$"
                               th:value="${!phoneReq.isEmpty() ? phoneReq[0].newValue : emp.phone}"
                               th:data-req-id="${phoneReq.isEmpty()} ? null : 'phone'"
                               th:data-original-value="${!phoneReq.isEmpty() ? phoneReq[0].newValue : emp.phone}"/>
                        <span th:if="${!phoneReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="extNoReq=${reqList != null ? reqList.?[fieldName == 'extNo'] : new java.util.ArrayList()}">
                    <div class="field field-row">
                        <label>ë‚´ì„ ë²ˆí˜¸</label>
                        <input name="extNo" placeholder="1234" pattern="^\d{3,5}$"
                               th:value="${!extNoReq.isEmpty() ? extNoReq[0].newValue : emp.extNo}"
                               th:data-req-id="${extNoReq.isEmpty()} ? null : 'extNo'"
                               th:data-original-value="${!extNoReq.isEmpty() ? extNoReq[0].newValue : emp.extNo}"/>
                        <span th:if="${!extNoReq.isEmpty()}" class="updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <div class="field"><label>ì…ì‚¬ì¼*</label><input name="hireDate" type="date" th:value="${emp.hireDate}" readonly/></div>

                <input type="hidden" name="originAtchId" th:value="${(atch != null && atch.atchId != null) ? atch.atchId : ''}"/>
                <input type="hidden" name="originName" th:value="${(atch != null && atch.originName != null) ? atch.originName : ''}"/>
                <input type="hidden" name="changeName" th:value="${(atch != null && atch.changeName != null) ? atch.changeName : ''}"/>
                <input type="hidden" name="refType" th:value="${(atch != null && atch.refType != null) ? atch.refType : ''}"/>

                <th:block th:each="req : ${reqList}">
                    <input type="hidden" th:name="'reqIdMap[' + ${req.fieldName} + ']'" th:value="${req.reqId}"/>
                </th:block>

                <input type="hidden" name="managerId" th:value="${session.loginEmp.empNo}"/>

                <div class="actions">
                    <button class="btn" type="submit" id="submitBtn">ìˆ˜ì • ì‚¬í•­ ë°˜ì˜</button>
                    <button class="btn" id="resetAllBtn" type="button">ì´ˆê¸°í™”</button>
                    <a class="btn ghost" th:href="@{/hr/empAccount.hr}">ì·¨ì†Œ</a>
                </div>
            </form>

            <div id="rejectModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="rejTitle">
                <div class="modal-content">
                    <h3 id="rejTitle">ë³€ê²½ ì‚¬í•­ ê±°ì ˆ ì‚¬ìœ </h3>
                    <textarea id="rejectReason" rows="4" style="width:100%; margin-top:10px;"></textarea>
                    <div style="text-align:right; margin-top:10px;">
                        <button class="btn" id="confirmRejectBtn" type="button">í™•ì¸</button>
                        <button class="btn ghost" id="cancelRejectBtn" type="button">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            function init() {
                const form = document.getElementById('updateForm');
                if (!form) {
                    console.warn('[empModify] form not found');
                    return;
                }

                const modal = document.getElementById('rejectModal');
                const reason = document.getElementById('rejectReason');
                const confirmBtn = document.getElementById('confirmRejectBtn');
                const cancelBtn = document.getElementById('cancelRejectBtn');
                const submitBtn = document.getElementById('submitBtn');
                const resetBtn = document.getElementById('resetAllBtn');
                const profilePreview = document.getElementById('profile-preview');
                const fileInput = document.querySelector('input[name="atchFile"]');

                const reqFields = new Set(
                    Array.from(document.querySelectorAll('input[name^="reqIdMap["]'))
                    .map(h => (h.name.match(/^reqIdMap\[(.+)\]$/) || [])[1])
                    .filter(Boolean)
                );

                const pendingRejects = {};
                let lastEditedField = null;

                function resolveFieldName(el) {
                    if (el.name === 'atchFile') {
                        const profileReqElement = document.querySelector('[data-req-id="profilePic"]');
                        if (profileReqElement) return 'profilePic';
                    }
                    return el.dataset?.reqId || el.name;
                }

                function onFieldChange(event) {
                    const field = event.target;
                    const fieldName = resolveFieldName(field);
                    if (!fieldName || !reqFields.has(fieldName)) return;

                    const isValueChanged = (field.type === 'file' && field.files.length > 0) ||
                                         (field.type !== 'file' && field.value !== field.dataset.originalValue);

                    if (isValueChanged) {
                        lastEditedField = field;
                        if (modal) modal.style.display = 'block';
                    }
                }

                form.addEventListener('change', (e) => {
                    onFieldChange(e);
                }, true);

                confirmBtn && confirmBtn.addEventListener('click', () => {
                    const text = (reason?.value || '').trim();
                    if (!lastEditedField) {
                        modal.style.display = 'none';
                        return;
                    }
                    const fieldName = resolveFieldName(lastEditedField);
                    if (!fieldName || !text) {
                        if (!text) alert('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    pendingRejects[fieldName] = text;

                    const container = lastEditedField.closest('.field-row, .profile-section, .field');
                    const upd = container && container.querySelector('.updated-badge');
                    const rej = container && container.querySelector('.rejected-badge');
                    if (upd) upd.style.display = 'none';
                    if (rej) rej.style.display = 'inline';

                    if (reason) reason.value = '';
                    modal.style.display = 'none';
                });

                cancelBtn && cancelBtn.addEventListener('click', () => {
                    modal.style.display = 'none';
                    if (reason) reason.value = '';
                    if (!lastEditedField) return;

                    if (lastEditedField.type === 'file') {
                        lastEditedField.value = '';
                        if (profilePreview?.dataset.newUrl) profilePreview.src = profilePreview.dataset.newUrl;
                    } else {
                        // ì·¨ì†Œ ì‹œì—ë„ ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ ìœ ì§€
                    }
                });

                submitBtn && submitBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    form.querySelectorAll('.dyn-reject').forEach(n => n.remove());
                    const h = document.createElement('input');
                    h.type = 'hidden';
                    h.name = 'pendingRejects';
                    h.value = JSON.stringify(pendingRejects);
                    h.className = 'dyn-reject';
                    form.appendChild(h);
                    form.submit();
                });

                resetBtn && resetBtn.addEventListener('click', () => {
                    Object.keys(pendingRejects).forEach(k => delete pendingRejects[k]);

                    document.querySelectorAll('[data-req-id]').forEach(field => {
                        if (field.dataset.originalValue) {
                            field.value = field.dataset.originalValue;
                        }
                        const container = field.closest('.field-row, .profile-section, .field');
                        if (container) {
                            container.querySelector('.updated-badge')?.style.setProperty('display', 'inline', 'important');
                            container.querySelector('.rejected-badge')?.style.setProperty('display', 'none', 'important');
                        }
                    } );

                    const profileContainer = document.querySelector('.profile-section');
                    if (profileContainer) {
                        if (fileInput) fileInput.value = '';
                        if (profilePreview?.dataset.newUrl) profilePreview.src = profilePreview.dataset.newUrl;
                    }
                });

                document.getElementById('originalPicBtn')?.addEventListener('click', () => {
                    lastEditedField = fileInput;
                    if (modal) modal.style.display = 'block';

                    const originalUrl = profilePreview?.dataset.originalUrl;
                    if (originalUrl) {
                        profilePreview.src = originalUrl;
                        if (fileInput) fileInput.value = '';
                    }
                });

                document.getElementById('newPicBtn')?.addEventListener('click', () => {
                    const newUrl = profilePreview?.dataset.newUrl;
                    if (newUrl) {
                        profilePreview.src = newUrl;
                        if (fileInput) fileInput.value = '';

                        const profileContainer = document.querySelector('.profile-section');
                        if (profileContainer) {
                            const upd = profileContainer.querySelector('.updated-badge');
                            const rej = profileContainer.querySelector('.rejected-badge');
                            if (upd) upd.style.display = 'inline';
                            if (rej) rej.style.display = 'none';
                        }
                        if (pendingRejects['profilePic']) {
                            delete pendingRejects['profilePic'];
                        }
                    }
                });

                if (profilePreview?.dataset.newUrl) {
                    profilePreview.src = profilePreview.dataset.newUrl;
                }
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init, { once: true });
            } else {
                init();
            }
        })();

        function previewProfilePic(event) {
            var file = event.target.files && event.target.files[0];
            if (!file) {
                var img = document.getElementById('profile-preview');
                var newUrl = img.dataset.newUrl;
                img.src = newUrl;
                return;
            }
            var reader = new FileReader();
            reader.onload = function () {
                var img = document.getElementById('profile-preview');
                if (img) img.src = reader.result;
            };
            reader.readAsDataURL(file);
        }

        function validateName(type) {
            var kL = document.querySelector('input[name="empLName"]');
            var kN = document.querySelector('input[name="empName"]');
            var eL = document.querySelector('input[name="empEngLName"]');
            var eN = document.querySelector('input[name="empEngName"]');
            var korean = /^[ê°€-í£]+$/,
                english = /^[a-zA-Z]+$/;
            if (type === 'korean') {
                var ok1 = !kL || !kL.value || korean.test(kL.value);
                var ok2 = !kN || !kN.value || korean.test(kN.value);
                var e1 = document.getElementById('korean-name-error');
                var e2 = document.getElementById('korean-name-error-2');
                if (e1) e1.style.display = ok1 ? 'none' : 'block';
                if (e2) e2.style.display = ok2 ? 'none' : 'block';
            } else if (type === 'english') {
                var ok3 = !eL || !eL.value || english.test(eL.value);
                var ok4 = !eN || !eN.value || english.test(eN.value);
                var e3 = document.getElementById('english-name-error');
                var e4 = document.getElementById('english-name-error-2');
                if (e3) e3.style.display = ok3 ? 'none' : 'block';
                if (e4) e4.style.display = ok4 ? 'none' : 'block';
            }
        }
    </script>

    <script th:if="${alertMsg}">
        const alertMsg = '[[${alertMsg}]]';
        alertify.alert('ê³„ì • ìˆ˜ì •', alertMsg);
    </script>
</div>
</body>
</html>