<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA Â· ERP</title>
    <style>
        .content {
        background-color: #fff;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        width: 1200px;
        margin: 0 auto;
    }

    .dashboard-grid {
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:20px;
        margin-bottom:20px;
    }

    .widget {
        background:#fff;
        border-radius:10px;
        padding:20px;
        box-shadow:0 2px 10px rgba(0,0,0,.1);
    }
    .widget-header {
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:15px;
        padding-bottom:10px;
        border-bottom:2px solid #f0f0f0;
    }
    .widget-title {
        font-size:18px;
        font-weight:700;
        color:#333
    }

    .view-more {
        color:#0c197f;
        cursor:pointer;
        text-decoration:none;
        font-size:14px
    }
    .view-more:hover {text-decoration:underline}

    .notice-item,
    .message-item {
        padding:8px 0;
        border-bottom:1px solid #eee
    }
    .notice-item:hover,
    .message-item:hover {
        background:#f6f6f6;
        border-radius:10px;
        cursor:pointer;
    }
    .notice-item:last-child,
    .message-item:last-child {border-bottom:none}

    .btn{
        background:#0c197f;
        color:#fff;
        border:none;
        padding:10px 16px;
        border-radius:6px;
        cursor:pointer;
        margin:5px;
        transition:.2s;
        line-height: 1;
    }
    .btn2 {background:#4169e1;}
    .btn3 {background:#4f6ec9;}
    .btn4 {background:#1b2ba1;}
    .btn:hover {background:#0050be; color: #fff;}


    /* ë‚ ì”¨ ìŠ¤íƒ€ì¼ */
    .weather-mini {
        display: flex;
        align-items: center;
        gap: 8px;
        background: linear-gradient(135deg, #74b9ff, #0984e3);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 13px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        transition: all 0.3s ease;
    }

    .weather-mini:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }

    .weather-icon-mini {
        font-size: 16px;
    }

    .weather-temp-mini {
        font-weight: bold;
        font-size: 14px;
    }

#attendPreview .preview-table {
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
  font-size: 12.5px;          /* ë³¸ë¬¸ ê°€ë…ì„± í°íŠ¸ í¬ê¸° */
  line-height: 1.5;
  font-variant-numeric: tabular-nums; /* ì‹œê°„/ìˆ«ì ì •ë ¬ ê³ ì •í­ */
  table-layout: fixed;        /* ë§ì¤„ì„ ì²˜ë¦¬ë¥¼ ìœ„í•´ ê³ ì • ë ˆì´ì•„ì›ƒ */
}

#attendPreview .preview-table thead th {
  position: sticky;
  top: 0;
  z-index: 1;
  background: #f7fafc;        /* í—¤ë” ë°°ê²½ */
  color: #223;
  font-weight: 700;
  font-size: 12.5px;
  padding: 8px 10px;
  border-bottom: 2px solid #e5edf4;
}

#attendPreview .preview-table tbody td {
  padding: 8px 10px;
  border-bottom: 1px solid #eef3f7;
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}
    </style>
</head>
<body>
<!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="content" th:if="${session.loginEmp.deptCode != 'D1'}">

        <!-- HOME -->
        <div class="page active" id="home">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 th:text="'ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”, ' + ${session.loginEmp.empLName} + ${session.loginEmp.empName} + 'ë‹˜'" style="margin: 0;"></h3>
                <div id="weather-mini" class="weather-mini">
                    <span style="font-size: 12px; color: #666;">ë‚ ì”¨ ë¡œë”© ì¤‘...</span>
                </div>
            </div>
<!--            <h3 th:text="'ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”, ' + ${session.loginEmp.empLName} + ${session.loginEmp.empName} + 'ë‹˜'"></h3>-->
            <div class="dashboard-grid">
                <div class="widget">
                    <div class="widget-header">
                        <div class="widget-title">ğŸ‘¥ ê³„ì • í˜„í™©</div>
                    </div>
                    <div class="notice-item">í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ìˆ˜: 12ëª…</div>
                    <div class="notice-item">ìµœê·¼ 14ì¼ ê°€ì…ì ìˆ˜: 4ëª…</div>
                    <div class="notice-item">ì ê¸ˆëœ ê³„ì • ë°œìƒ: 2ëª…</div>
                    <div class="notice-item">ì „ì²´ ë“±ë¡ ê³„ì • ìˆ˜: 30ëª…</div>
                </div>

                <div class="widget">
                    <div class="widget-header">
                        <div class="widget-title">â­ ì¤‘ìš” ìª½ì§€í•¨</div>
                        <a class="view-more" onclick="|location.href='@{/message/inbox}}'|">ìì„¸íˆ ë³´ê¸°</a>
                    </div>
                    <div class="message-item" onclick="openMessage('IMP-1')">ğŸ“ ì›”ë§ ë³´ê³ ì„œ ì œì¶œ ìš”ì²­</div>
                    <div class="message-item" onclick="openMessage('IMP-2')">ğŸ”’ ë³´ì•ˆ ì •ì±… ë³€ê²½ ì•ˆë‚´</div>
                    <div class="message-item" onclick="openMessage('IMP-3')">ğŸ“Š 4ë¶„ê¸° ì‹¤ì  ê²€í†  íšŒì˜</div>
                    <div class="message-item" onclick="openMessage('IMP-4')">âœ… í”„ë¡œì íŠ¸ ìŠ¹ì¸ ì™„ë£Œ</div>
                    <div class="message-item" onclick="openMessage('IMP-5')">ğŸ¯ ëª©í‘œ ì„¤ì • ë¯¸íŒ… ì¼ì •</div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="widget">
                    <div class="widget-header">
                        <div class="widget-title">ğŸ“ ìµœê·¼ í™œë™ ë¡œê·¸</div>
                        <a class="view-more" onclick="showPage('calendar')">ìì„¸íˆ ë³´ê¸°</a>
                    </div>
                    <div class="notice-item">2025-09-05 - ê³„ì • ì ê¸ˆ í•´ì œ(ì‚¬ë²ˆ)</div>
                    <div class="notice-item">2025-09-02 - ê³„ì • ê¶Œí•œ ë¶€ì—¬(ì‚¬ë²ˆ)</div>
                    <div class="notice-item">2025-08-30 - ë¶€ì„œ ë©”ë‰´ ìˆ˜ì •(ìƒì‚°í’ˆì§ˆíŒ€)</div>
                </div>

                <div class="widget">
                    <div class="widget-header"><div class="widget-title">âš¡ ë¹ ë¥¸ ì‘ì—…</div></div>
                    <!-- ê¸°ìˆ ì§€ì›íŒ€ ë¡œê·¸ì¸ ì‹œ ë³´ì´ëŠ” ë©”ë‰´ -->
                    <button class="btn btn2" th:onclick="|location.href='@{/approvalbox}'|">ë‚´ ì „ì ê²°ì¬</button>
                    <button class="btn btn3" th:onclick="|location.href='@{/permlog}'|">ê¶Œí•œ ë³€ê²½ ë¡œê·¸</button><br>
                    <button class="btn" th:onclick="|location.href='@{/permission}'|">ê³„ì • ê¶Œí•œ ê´€ë¦¬</button>
                    <button class="btn btn4" th:onclick="|location.href='@{/approvelog}'|">ì „ìê²°ì¬ ë¡œê·¸</button>
                </div>
            </div>
        </div>
    </div>

<div class="content" th:unless="${session.loginEmp.deptCode != 'D1'}">

    <!-- HOME -->
    <div class="page active" id="home">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 th:text="'ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”, ' + ${session.loginEmp.empLName} + ${session.loginEmp.empName} + 'ë‹˜'" style="margin: 0;"></h3>
            <div id="weather-mini" class="weather-mini">
                <span style="font-size: 12px; color: #666;">ë‚ ì”¨ ë¡œë”© ì¤‘...</span>
            </div>
        </div>
        <!--            <h3 th:text="'ğŸ‘‹ ì•ˆë…•í•˜ì„¸ìš”, ' + ${session.loginEmp.empLName} + ${session.loginEmp.empName} + 'ë‹˜'"></h3>-->
        <div class="dashboard-grid">
            <div class="widget" id="vacationPreview">
                <div class="card-header-action">
                    <h4 style="margin:0 0 8px">íœ´ê°€ ì‹ ì²­ (ìµœê·¼ 5ê±´)</h4>
                    <a class="btn card-footer-action" href="/hr/vacationList.hr?cpage=1">ì •ë³´ ë”ë³´ê¸°</a>
                </div>
                <table class="preview-table" >
                    <thead>
                    <tr>
                        <th>ì‚¬ë²ˆ</th>
                        <th>ì´ë¦„</th>
                        <th>ì¢…ë¥˜</th>
                        <th>ê¸°ê°„</th>
                        <th>ì‚¬ìœ </th>
                        <th>ìƒíƒœ</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>

            <div class="widget">
                <div class="widget-header">
                    <div class="widget-title">â­ ì¤‘ìš” ìª½ì§€í•¨</div>
                    <a class="view-more" onclick="|location.href='@{/message/inbox}}'|">ìì„¸íˆ ë³´ê¸°</a>
                </div>
                <div class="message-item" onclick="openMessage('IMP-1')">ğŸ“ ì›”ë§ ë³´ê³ ì„œ ì œì¶œ ìš”ì²­</div>
                <div class="message-item" onclick="openMessage('IMP-2')">ğŸ”’ ë³´ì•ˆ ì •ì±… ë³€ê²½ ì•ˆë‚´</div>
                <div class="message-item" onclick="openMessage('IMP-3')">ğŸ“Š 4ë¶„ê¸° ì‹¤ì  ê²€í†  íšŒì˜</div>
                <div class="message-item" onclick="openMessage('IMP-4')">âœ… í”„ë¡œì íŠ¸ ìŠ¹ì¸ ì™„ë£Œ</div>
                <div class="message-item" onclick="openMessage('IMP-5')">ğŸ¯ ëª©í‘œ ì„¤ì • ë¯¸íŒ… ì¼ì •</div>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="widget" id="vacationPreview">
                <div class="widget-header">
                    <div class="card-header-action">
                        <h4 style="margin:0 0 8px">ê·¼íƒœ ì •ë³´ (ìµœê·¼ 5ê±´)</h4>
                        <a class="btn card-footer-action" href="/hr/attendanceList.hr?cpage=1">ì •ë³´ ë”ë³´ê¸°</a>
                    </div>
                        <table class="preview-table">
                            <thead>
                            <tr>
                                <th>ì‚¬ë²ˆ</th>
                                <th>ì´ë¦„</th>
                                <th>ì¼ì</th>
                                <th>ì¶œê·¼</th>
                                <th>í‡´ê·¼</th>
                                <th>ìƒíƒœ</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                </div>
            </div>

            <div class="widget">
                <div class="widget-header"><div class="widget-title">âš¡ ë¹ ë¥¸ ì‘ì—…</div></div>
                <!-- ê¸°ìˆ ì§€ì›íŒ€ ë¡œê·¸ì¸ ì‹œ ë³´ì´ëŠ” ë©”ë‰´ -->
                <button class="btn btn2" th:onclick="|location.href='@{/approvalbox}'|">ë‚´ ì „ì ê²°ì¬</button>
                <button class="btn btn3" th:onclick="|location.href='@{/attManage/requestVacation.attManage}'|">íœ´ê°€ ì‹ ì²­</button><br>
                <button class="btn" th:onclick="|location.href='@{/attManage/attendanceRecordCheck.attManage}'|">ì¶œí‡´ê·¼ ê¸°ë¡ ì¡°íšŒ</button>
                <button class="btn btn4" th:onclick="|location.href='@{/hr/integratedAttendance.hr}'|">ê·¼íƒœ/íœ´ê°€ í†µí•© ê´€ë¦¬</button>
            </div>
        </div>
    </div>
</div>


<script>
    // ë‚ ì”¨ API ì„¤ì •
    const WEATHER_API_KEY = '73fc43235f2be6fbe8103ffb75ab9482';
    const CITY = 'Gangnam-gu,Seoul,KR';

    // ë‚ ì”¨ ì•„ì´ì½˜ ë§¤í•‘
    const weatherIcons = {
        '01d': 'â˜€ï¸', '01n': 'ğŸŒ™',
        '02d': 'â›…', '02n': 'â˜ï¸',
        '03d': 'â˜ï¸', '03n': 'â˜ï¸',
        '04d': 'â˜ï¸', '04n': 'â˜ï¸',
        '09d': 'ğŸŒ§ï¸', '09n': 'ğŸŒ§ï¸',
        '10d': 'ğŸŒ¦ï¸', '10n': 'ğŸŒ§ï¸',
        '11d': 'â›ˆï¸', '11n': 'â›ˆï¸',
        '13d': 'ğŸŒ¨ï¸', '13n': 'ğŸŒ¨ï¸',
        '50d': 'ğŸŒ«ï¸', '50n': 'ğŸŒ«ï¸'
    };

    async function loadWeather() {
        try {
            const response = await fetch(
                `https://api.openweathermap.org/data/2.5/weather?q=${CITY}&appid=${WEATHER_API_KEY}&units=metric&lang=kr`
            );

            if (!response.ok) {
                throw new Error('ë‚ ì”¨ API ì‘ë‹µ ì˜¤ë¥˜');
            }

            const data = await response.json();

            const icon = weatherIcons[data.weather[0].icon] || 'ğŸŒ¤ï¸';

            const weatherHtml = `
                <span class="weather-icon-mini">${icon}</span>
                <span class="weather-temp-mini">${Math.round(data.main.temp)}Â°C</span>
                <span style="font-size: 11px; opacity: 0.9;">${data.weather[0].description}</span>
            `;

            document.getElementById('weather-mini').innerHTML = weatherHtml;

        } catch (error) {
            console.error('ë‚ ì”¨ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('weather-mini').innerHTML = `
                <span style="font-size: 12px; opacity: 0.8;">ğŸŒ¤ï¸ ë‚ ì”¨ ì •ë³´ ì—†ìŒ</span>
            `;
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë‚ ì”¨ ì •ë³´ ë¡œë“œ
    document.addEventListener('DOMContentLoaded', function() {
        loadWeather();

        // 10ë¶„ë§ˆë‹¤ ë‚ ì”¨ ì •ë³´ ê°±ì‹ 
        setInterval(loadWeather, 10 * 60 * 1000);
    });

    $(document).ready(function() {
        fetchRecentVacations();
        fetchRecentAttendances();
    });

    // ìµœê·¼ íœ´ê°€ ì‹ ì²­ 5ê±´ì„ AJAXë¡œ ê°€ì ¸ì™€ í…Œì´ë¸”ì— ì‚½ì…í•˜ëŠ” í•¨ìˆ˜
    function fetchRecentVacations() {
        $.ajax({
            url: '/hr/vacations/recent5',
            type: 'GET',
            success: function(response) {
                const tbody = $('#vacationPreview tbody');
                tbody.empty();
                if (response.length > 0) {
                    response.forEach(va => {
                        const row = `
                            <tr>
                                <td>${va.empNo}</td>
                                <td>${va.empName}</td>
                                <td>${va.vaName}</td>
                                <td>${va.vaStart}~${va.vaEnd}</td>
                                <td style="width:150px">${va.vaReason}</td>>
                                <td><span class="chip">${va.vaStatusName}</span></td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                } else {
                    const emptyRow = `<tr><td colspan="4" class="muted" style="text-align: center;">ì‹ ì²­ ë‚´ì—­ì´ ì—†ì–´ìš”.</td></tr>`;
                    tbody.append(emptyRow);
                }
            },
            error: function(xhr) {
                console.error("ìµœê·¼ íœ´ê°€ ì‹ ì²­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ", xhr.responseText);
                const tbody = $('#vacationPreview tbody');
                tbody.html(`<tr><td colspan="4" class="muted" style="text-align: center;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`);
            }
        });
    }

    // ìµœê·¼ ê·¼íƒœ ê¸°ë¡ 5ê±´ì„ AJAXë¡œ ê°€ì ¸ì™€ í…Œì´ë¸”ì— ì‚½ì…í•˜ëŠ” í•¨ìˆ˜
    function fetchRecentAttendances() {
        $.ajax({
            url: '/hr/attendances/recent5',
            type: 'GET',
            success: function(response) {
                const tbody = $('#attendPreview tbody');
                tbody.empty();
                if (response.length > 0) {
                    response.forEach(attend => {
                        const row = `
                            <tr>
                                <td>${attend.empNo}</td>
                                <td>${attend.empName}</td>
                                <td>${attend.attDate}</td>
                                <td>${attend.arrivingTime || '-'}</td>
                                <td>${attend.leavingTime || '-'}</td>
                                <td><span class="chip">${attend.attStatusName}</span></td>
                            </tr>
                        `;
                        tbody.append(row);
                    });
                } else {
                    const emptyRow = `<tr><td colspan="5" class="muted" style="text-align: center;">ê·¼íƒœ ë‚´ì—­ì´ ì—†ì–´ìš”.</td></tr>`;
                    tbody.append(emptyRow);
                }
            },
            error: function(xhr) {
                console.error("ìµœê·¼ ê·¼íƒœ ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ", xhr.responseText);
                const tbody = $('#attendPreview tbody');
                tbody.html(`<tr><td colspan="5" class="muted" style="text-align: center;">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</td></tr>`);
            }
        });
    }

</script>
</body>
</html>