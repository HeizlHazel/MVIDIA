<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8" />
    <title>MVIDIA Â· ERP - ì¸ì‚¬ê´€ë¦¬ Â· ì¦ëª…ì„œ ì¡°íšŒ/ ë°œê¸‰</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/alertify.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/alertify.min.css"/>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/themes/default.min.css"/>

    <style>
        body{font-family:"Malgun Gothic","Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f0f2f5}
        .certificate{grid-column:2;grid-row:2;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px; width: 1200px; margin: 0 auto; }
        .stack{display:flex;gap:10px;flex-wrap:wrap}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background-color:#0c197f;color:#fff;cursor:pointer}
        .btn:hover{background:#00BDA7}
        .btn.ghost{background:transparent;color:#002B39;border:1px solid #002B39}
        .certificate-page{display:none}
        .certificate-document{max-width:210mm;margin:0 auto;padding:20mm;border:1px solid #e5e7eb;background:#fff;box-shadow:0 0 10px rgba(0,0,0,.1)}
        @page{size:A4;margin:20mm}
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center}
        .modal-content{background:#fff;padding:24px;border-radius:12px;max-width:420px;width:90%}
        .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;padding-bottom:12px;margin-bottom:16px}
        .close-btn{background:none;border:0;font-size:24px;cursor:pointer}
        .emp-info{display:none;margin-top:15px;padding:15px;border-radius:8px;background:#f0f4f7}
        .error-message{display:none;color:#ef4444;margin-top:10px}
        @media print {body * { visibility: hidden !important; } #certificate-container, #certificate-container * { visibility: visible !important; }header, aside, .modal-overlay { display: none !important; } #certificate-container .actions { display: none !important; } #certificate-container { position: absolute; left: 0; top: 0; width: 100%; margin: 0 !important; padding: 0 !important;} @page { size: A4; margin: 20mm; }}
    </style>
    <script th:inline="javascript">
        window.CONFIRMER = {
         empName:  /*[[${confirmer?.empName}]]*/ null,
         empLName: /*[[${confirmer?.empLName}]]*/ null,
         jobName:  /*[[${confirmer?.jobName}]]*/ null
       };
    </script>
</head>
<body>
<section layout:fragment="content">
    <div class="certificate" id="main-content">
        <h3>ğŸ“° ì¦ëª…ì„œ ì¡°íšŒ/ ë°œê¸‰</h3>
        <br>
        <div class="stack no-print" >
            <button type="button" class="btn" data-open-cert="employment">ì¬ì§ ì¦ëª…ì„œ</button>
            <button type="button" class="btn" data-open-cert="career">ê²½ë ¥ ì¦ëª…ì„œ</button>
            <a class="btn ghost" href="/mainPage">ë©”ì¸ìœ¼ë¡œ</a>
        </div>
    </div>

    <div id="certificate-container" class="certificate-page"></div>

    <div class="modal-overlay" id="commonModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="close-btn" onclick="closeModal()" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex gap-2 items-center">
                    <input id="empNo" class="rounded-lg px-4 py-2 border w-full" type="text"
                           placeholder="ì‚¬ë²ˆ ì…ë ¥ (ì˜ˆ: 22010001)" maxlength="8" />
                </div>

                <div class="emp-info" id="empInfo">
                    <p><strong>ì´ë¦„:</strong> <span id="empName"></span></p>
                    <p><strong>ì§ê¸‰:</strong> <span id="empRank"></span></p>
                    <p><strong>ë¶€ì„œ:</strong> <span id="empDept"></span></p>
                    <button class="btn mt-3" id="btnConfirmIssue" type="button">ë°œê¸‰ ì§„í–‰</button>
                </div>

                <p class="error-message" id="errorMsg"></p>
            </div>
        </div>
    </div>


    <script>
        // ===== ì „ì—­ =====
        let CURRENT_TYPE = ''; // employment | career | payslip
        let LAST_EMP_OBJ = null; // ì§ì „ ì¡°íšŒ ì‚¬ì›ì •ë³´ ìºì‹œ

        // ëª¨ë‹¬ ì˜¤í”ˆ íŠ¸ë¦¬ê±°
        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('[data-open-cert]');
          if(!btn) return;
          e.preventDefault();
          openModal(btn.getAttribute('data-open-cert'));
        });

          function todayYMD(){
            const t = new Date();
            const y = t.getFullYear();
            const m = String(t.getMonth()+1).padStart(2,'0');
            const d = String(t.getDate()).padStart(2,'0');
            return `${y}-${m}-${d}`;
          }

        function openModal(type){
          CURRENT_TYPE = type;
          $('#empNo').val('');
          $('#empInfo').hide();
          $('#empName, #empRank, #empDept').text('');
          $('#errorMsg').hide().text('');
          LAST_EMP_OBJ = null;

          if(type==='employment'){
            $('#modalTitle').text('ì¬ì§ ì¦ëª…ì„œ ë°œê¸‰');
            $('#empInfo').show();
          }else {
            $('#modalTitle').text('ê²½ë ¥ ì¦ëª…ì„œ ë°œê¸‰');
            $('#empInfo').show();
          }
          $('#commonModal').css('display','flex').attr('aria-hidden','false');
          setTimeout(()=>$('#empNo').trigger('focus'),0);
        }
        function closeModal(){
          $('#commonModal').css('display','none').attr('aria-hidden','true');
           $('#empNo').val('');
          $('#empInfo').hide();
          $('#empName, #empRank, #empDept').text('');
          $('#errorMsg').hide().text('');
          LAST_EMP_OBJ = null;
        }

        // ì‚¬ë²ˆ ì…ë ¥ â†’ ì¦‰ì‹œ ì¡°íšŒ(/hr/checkEmpNoCer.hr)
        $('#empNo').on('input', function(){
          const empNo = $(this).val().trim();
          const $err = $('#errorMsg');
          $err.hide().text('');

          if(empNo.length === 8){
            $.ajax({
              url:'/hr/checkEmpNo.hr',
              type:'GET',
              data:{empNo},
              success: (res)=>{
                if(res){
                  // ì§ê¸‰ ë§ˆì§€ë§‰ ë‘ ê¸€ìë§Œ
                  const jobShort = (res.jobName||'').slice(-2);
                  $('#empName').text(res.empName||'');
                  $('#empRank').text(jobShort);
                  $('#empDept').text(res.deptName||'');
                  LAST_EMP_OBJ = res;
                  if(CURRENT_TYPE==='payslip') $('#payslipInfo').show();
                  else $('#empInfo').show();
                }else{
                  $('#empInfo, #payslipInfo').hide();
                  $err.text('ì‚¬ë²ˆì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.').show();
                }
              },
              error: ()=> $err.text('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.').show()
            });
          }else if(empNo.length>8){
            $err.text('ì‚¬ë²ˆì´ 8ìë¦¬ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.').show();
          }else{
            $('#empInfo, #payslipInfo').hide();
          }
        });

        // ë°œê¸‰ ì§„í–‰ â†’ ë¯¸ë¦¬ë³´ê¸° ë Œë”
        $('#btnConfirmIssue').on('click', function(){
          const empNo = $('#empNo').val().trim();
          if(!empNo || empNo.length!==8){ return $('#errorMsg').text('ì‚¬ë²ˆì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.').show(); }
          if(!LAST_EMP_OBJ){ return $('#errorMsg').text('ì‚¬ë²ˆì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.').show(); }

          renderCertificatePage(LAST_EMP_OBJ, CURRENT_TYPE);
          closeModal();
        });


        // ===== í…œí”Œë¦¿ =====
        function employmentTemplate(d){
          const comName = 'ì£¼ì‹íšŒì‚¬ ì— ë¹„ë””ì•„';
          const comAddress = 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123'
          const ceoName = 'ê¹€ëŒ€í‘œ'
          const bizRegNo = '123-45-67890'
          const comPhone = '02-123-4567'
          const name       = d.empName || '';
          const empNo      = d.empNo || '';
          const dept       = d.deptName || '';
          const position   = (d.jobName || '').slice(-2);
          const hireDate   = d.hireDate || '';
          const issueDate  = new Date().toLocaleDateString('ko-KR', { year:'numeric', month:'long', day:'numeric' });

          return `
            <div class="actions flex justify-end gap-2 mb-2 no-print">
              <button class="btn" onclick="issueCertificate('employment','${empNo}')">ë°œê¸‰</button>
              <button class="btn" onclick="window.print()">ì¸ì‡„</button>
              <button class="btn" onclick="goBack()">ëŒì•„ê°€ê¸°</button>
            </div>

            <section class="certificate-document relative p-8">
              <h1 class="text-center text-3xl md:text-4xl font-bold tracking-wider text-[#002B39] mb-10">
                ì¬&nbsp;ì§&nbsp;ì¦&nbsp;ëª…&nbsp;ì„œ
              </h1>

              <table class="w-full border-collapse">
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left w-1/4">ì„±ëª…</th><td class="border border-gray-300 p-3">${name}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì‚¬ë²ˆ</th><td class="border border-gray-300 p-3">${empNo}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì†Œì†</th><td class="border border-gray-300 p-3">${dept}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì§ìœ„</th><td class="border border-gray-300 p-3">${position}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ê¸°ê°„</th><td class="border border-gray-300 p-3">${hireDate} ~ ${todayYMD()}</td></tr>
              </table>

              <div class="mt-8 text-sm leading-relaxed">
                ìƒê¸°ì™€ ê°™ì´ ì¬ì§ ì¤‘ì„ì„ ì¦ëª…í•¨<br>
                ìš©&nbsp;&nbsp;ë„ : ë°œ ê¸‰
              </div>

              <div class="mt-12 text-center">
                <div class="mb-4 text-lg font-semibold">${issueDate}</div>
                <div class="text-sm leading-relaxed">
                  ì£¼&nbsp;&nbsp;&nbsp;&nbsp;ì†Œ : ${comAddress}<br>
                  íšŒ ì‚¬ ëª… : ${comName}<br>
                  ëŒ€ í‘œ ì´ ì‚¬ : ${ceoName} (ì¸)
                </div>
              </div>
                <img src="/images/mvidia_seal.png" alt="íšŒì‚¬ ì§ì¸" class="absolute right-8 bottom-8" style="width: 64px; height: 64px;">
            </section>
          `;
        }

        function careerTemplate(d){
          const comName = 'ì£¼ì‹íšŒì‚¬ ì— ë¹„ë””ì•„';
          const comAddress = 'ì„œìš¸íŠ¹ë³„ì‹œ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 123'
          const ceoName = 'ê¹€ëŒ€í‘œ'
          const bizRegNo = '123-45-67890'
          const comPhone = '02-123-4567'
          const CF = window.CONFIRMER || {};
          const confirmerName     = `${CF.empLName || ''}${CF.empName || ''}`;
          const confirmerPosition = CF.jobName ? String(CF.jobName).slice(-2) : '';
          const name       = d.empName || '';
          const empNo      = d.empNo || '';
          const phone      = d.phone || '';
          const address    = d.address || '';
          const hireDate = d.hireDate || '';
          const issueDate  = new Date().toLocaleDateString('ko-KR', { year:'numeric', month:'long', day:'numeric' });


          const rows = `
            <tr>
              <td class="border border-gray-300 p-3 text-center">${hireDate} ~ ${todayYMD()}</td>
              <td class="border border-gray-300 p-3 text-center">${d.deptName || ''}</td>
              <td class="border border-gray-300 p-3 text-center">${d.jobName || ''}</td>
            </tr>
          `;

          return `
            <div class="actions flex justify-end gap-2 mb-2 no-print">
              <button class="btn" onclick="issueCertificate('career','${empNo}')">ë°œê¸‰</button>
              <button class="btn" onclick="window.print()">ì¸ì‡„</button>
              <button class="btn" onclick="goBack()">ëŒì•„ê°€ê¸°</button>
            </div>

            <section class="certificate-document relative p-8">
              <h1 class="text-center text-3xl md:text-4xl font-bold tracking-wider text-[#002B39] mb-10">
                ê²½&nbsp;ë ¥&nbsp;ì¦&nbsp;ëª…&nbsp;ì„œ
              </h1>

              <div class="font-bold text-lg text-[#002B39] mt-4 mb-2">ì¸ì  ì‚¬í•­</div>
              <table class="w-full border-collapse">
                <tr><th class="border border-gray-300 p-3 bg-gray-50 w-1/4 text-left">ì„±ëª…</th><td class="border border-gray-300 p-3">${name}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì‚¬ë²ˆ</th><td class="border border-gray-300 p-3">${empNo}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì „í™”ë²ˆí˜¸</th><td class="border border-gray-300 p-3">${phone}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì£¼ì†Œ</th><td class="border border-gray-300 p-3">${address}</td></tr>
              </table>

              <div class="font-bold text-lg text-[#002B39] mt-8 mb-2">ì—…ì²´ ì •ë³´</div>
              <table class="w-full border-collapse">
                <tr><th class="border border-gray-300 p-3 bg-gray-50 w-1/4 text-left">ì—…ì²´ëª…</th><td class="border border-gray-300 p-3">${comName}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸</th><td class="border border-gray-300 p-3">${bizRegNo}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì „í™”ë²ˆí˜¸</th><td class="border border-gray-300 p-3">${comPhone}</td></tr>
                <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ì£¼ì†Œ</th><td class="border border-gray-300 p-3">${comAddress}</td></tr>
              </table>

              <div class="font-bold text-lg text-[#002B39] mt-8 mb-2">ê²½ë ¥ ì‚¬í•­</div>
              <table class="w-full border-collapse">
                <thead>
                  <tr>
                    <th class="border border-gray-300 p-3 bg-gray-50 text-center">ê·¼ë¬´ê¸°ê°„</th>
                    <th class="border border-gray-300 p-3 bg-gray-50 text-center">ê·¼ë¬´ë¶€ì„œ</th>
                    <th class="border border-gray-300 p-3 bg-gray-50 text-center">ë‹´ë‹¹ì—…ë¬´</th>
                  </tr>
                </thead>
                <tbody>${rows}</tbody>
              </table>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                <table class="w-full border-collapse">
                  <tr><th class="border border-gray-300 p-3 bg-gray-50 w-1/3 text-left">í™•ì¸ì ì§ìœ„</th><td class="border border-gray-300 p-3">${confirmerPosition}</td></tr>
                  <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">í™•ì¸ì ì„±ëª…</th><td class="border border-gray-300 p-3">${confirmerName}</td></tr>
                  <tr><th class="border border-gray-300 p-3 bg-gray-50 text-left">ìš©ë„</th><td class="border border-gray-300 p-3">ë°œê¸‰</td></tr>
                </table>

                <div class="flex items-start justify-center gap-6 flex-wrap mt-4 text-sm leading-relaxed">
                  <div class="text-center">
                    <div class="font-semibold mb-2">${issueDate}</div>
                    <div>íšŒì‚¬ëª… : ${comName}</div>
                    <div>ëŒ€í‘œ : ${ceoName} (ì¸)</div>
                  </div>
                    <img src="/images/mvidia_seal.png" alt="íšŒì‚¬ ì§ì¸" class="absolute right-8 bottom-8" style="width: 64px; height: 64px;">
                </div>
              </div>
            </section>
          `;
        }

        // ë Œë”/ë°œê¸‰
        function renderCertificatePage(data, type){
          const html = (type==='employment') ? employmentTemplate(data)
                     : (type==='career')    ? careerTemplate(data) : '';
          $('#certificate-container').show().html(html);
          $('#main-content').hide();
        }
        function renderPayslipPage(data){
          $('#certificate-container').show().html(payslipTemplate(data));
          $('#main-content').hide();
        }
        window.goBack = function(){
          $('#certificate-container').hide().empty();
          $('#main-content').show();
        };

        window.issueCertificate = function(type, empNo){
          $.ajax({
            url:'/api/certificate/issue',
            method:'POST',
            contentType:'application/json',
            data: JSON.stringify({ type, empNo }),
            success:(res)=>{
              const msg = res?.message || 'ì¦ëª…ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë°œê¸‰ë˜ì–´ ë…¸ì…˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
              const extra = res?.issueNo ? `<br/>ë°œê¸‰ë²ˆí˜¸: <b>${res.issueNo}</b>` : '';
              alertify.alert('ë°œê¸‰ ì™„ë£Œ', msg + extra);
            },
            error:(xhr)=>{
              const m = xhr.responseJSON?.message || 'ì˜¤ë¥˜';
              alertify.alert('ì¦ëª…ì„œ ë°œê¸‰ ì‹¤íŒ¨', m);
            }
          });
        };
    </script>
</section>
</body>
</html>