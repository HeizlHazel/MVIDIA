<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8" />
    <title>ğŸ“° ì¦ëª…ì„œ ì¡°íšŒ/ ë°œê¸‰</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- alertify -->
    <script src="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/alertify.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/alertify.min.css"/>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/alertifyjs@1.14.0/build/css/themes/default.min.css"/>

    <style>
        body{font-family:"Malgun Gothic","Apple SD Gothic Neo",system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f0f2f5}
        .certificate{grid-column:2;grid-row:2;background:#fff;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1);padding:20px}
        .stack{display:flex;gap:10px;flex-wrap:wrap}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background-color:#0c197f;color:#fff;cursor:pointer}
        .btn:hover{background:#00BDA7}
        .btn.ghost{background:transparent;color:#002B39;border:1px solid #002B39}
        .certificate-page{display:none}
        .certificate-document{max-width:210mm;margin:0 auto;padding:20mm;border:1px solid #e5e7eb;background:#fff;box-shadow:0 0 10px rgba(0,0,0,.1)}
        @page{size:A4;margin:20mm}
        @media print{.actions{display:none}.certificate-document{border:none;padding:0;box-shadow:none}}
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center}
        .modal-content{background:#fff;padding:24px;border-radius:12px;max-width:420px;width:90%}
        .modal-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e2e8f0;padding-bottom:12px;margin-bottom:16px}
        .close-btn{background:none;border:0;font-size:24px;cursor:pointer}
        .emp-info{display:none;margin-top:15px;padding:15px;border-radius:8px;background:#f0f4f7}
        .error-message{display:none;color:#ef4444;margin-top:10px}
    </style>
</head>
<body>
<section layout:fragment="content">
    <div class="certificate" id="main-content">
        <h2 class="text-xl mb-3">ğŸ“° ì¦ëª…ì„œ ì¡°íšŒ/ ë°œê¸‰</h2>
        <div class="stack">
            <button type="button" class="btn" data-open-cert="employment">ì¬ì§ ì¦ëª…ì„œ</button>
            <button type="button" class="btn" data-open-cert="career">ê²½ë ¥ ì¦ëª…ì„œ</button>
            <button type="button" class="btn" data-open-cert="payslip">ê¸‰ì—¬ ëª…ì„¸ì„œ</button>
            <a class="btn ghost" href="/mainPage">ë©”ì¸ìœ¼ë¡œ</a>
        </div>
    </div>

    <div id="certificate-container" class="certificate-page"></div>

    <!-- ê³µí†µ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="commonModal" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="close-btn" onclick="closeModal()" aria-label="ë‹«ê¸°">&times;</button>
            </div>
            <div class="modal-body">
                <div class="flex gap-2 items-center">
                    <input id="empNo" class="rounded-lg px-4 py-2 border w-full" type="text"
                           placeholder="ì‚¬ë²ˆ ì…ë ¥ (ì˜ˆ: 22010001)" maxlength="8" />
                </div>

                <!-- ì¬ì§/ê²½ë ¥ìš© ì¸ì ì •ë³´ -->
                <div class="emp-info" id="empInfo">
                    <p><strong>ì´ë¦„:</strong> <span id="empName"></span></p>
                    <p><strong>ì§ê¸‰:</strong> <span id="empRank"></span></p>
                    <p><strong>ë¶€ì„œ:</strong> <span id="empDept"></span></p>
                    <button class="btn mt-3" id="btnConfirmIssue" type="button">ë°œê¸‰ ì§„í–‰</button>
                </div>

                <!-- ê¸‰ì—¬ëª…ì„¸ì„œìš© ê°„ë‹¨ì •ë³´ -->
                <div class="emp-info" id="payslipInfo">
                    <p><strong>ì¡°íšŒë…„ì›”:</strong> <span id="payslipDate"></span></p>
                    <button class="btn mt-3" id="btnConfirmPayslip" type="button">ì¡°íšŒ ì§„í–‰</button>
                </div>

                <p class="error-message" id="errorMsg"></p>
            </div>
        </div>
    </div>

    <script>
        // ===== ì „ì—­ =====
        let CURRENT_TYPE = ''; // employment | career | payslip
        let LAST_EMP_OBJ = null; // ì§ì „ ì¡°íšŒ ì‚¬ì›ì •ë³´ ìºì‹œ

        // ëª¨ë‹¬ ì˜¤í”ˆ íŠ¸ë¦¬ê±°
        document.addEventListener('click', (e)=>{
          const btn = e.target.closest('[data-open-cert]');
          if(!btn) return;
          e.preventDefault();
          openModal(btn.getAttribute('data-open-cert'));
        });

        function openModal(type){
          CURRENT_TYPE = type;
          $('#empNo').val('');
          $('#empInfo, #payslipInfo').hide();
          $('#errorMsg').hide().text('');
          LAST_EMP_OBJ = null;

          if(type==='employment'){
            $('#modalTitle').text('ì¬ì§ ì¦ëª…ì„œ ë°œê¸‰');
            $('#empInfo').show();
          }else if(type==='career'){
            $('#modalTitle').text('ê²½ë ¥ ì¦ëª…ì„œ ë°œê¸‰');
            $('#empInfo').show();
          }else{
            $('#modalTitle').text('ê¸‰ì—¬ ëª…ì„¸ì„œ ì¡°íšŒ');
            $('#payslipInfo').show();
            $('#payslipDate').text(new Date().toISOString().slice(0,7)); // yyyy-MM
          }
          $('#commonModal').css('display','flex').attr('aria-hidden','false');
          setTimeout(()=>$('#empNo').trigger('focus'),0);
        }
        function closeModal(){
          $('#commonModal').css('display','none').attr('aria-hidden','true');
        }

        // ì‚¬ë²ˆ ì…ë ¥ â†’ ì¦‰ì‹œ ì¡°íšŒ(/hr/checkEmpNo.hr)
        $('#empNo').on('input', function(){
          const empNo = $(this).val().trim();
          const $err = $('#errorMsg');
          $err.hide().text('');

          if(empNo.length === 8){
            $.ajax({
              url:'/hr/checkEmpNo.hr',
              type:'GET',
              data:{empNo},
              success: (res)=>{
                if(res){
                  // ì§ê¸‰ ë§ˆì§€ë§‰ ë‘ ê¸€ìë§Œ
                  const jobShort = (res.jobName||'').slice(-2);
                  $('#empName').text(res.empName||'');
                  $('#empRank').text(jobShort);
                  $('#empDept').text(res.deptName||'');
                  LAST_EMP_OBJ = res;
                  if(CURRENT_TYPE==='payslip') $('#payslipInfo').show();
                  else $('#empInfo').show();
                }else{
                  $('#empInfo, #payslipInfo').hide();
                  $err.text('ì‚¬ë²ˆì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.').show();
                }
              },
              error: ()=> $err.text('ì„œë²„ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.').show()
            });
          }else if(empNo.length>8){
            $err.text('ì‚¬ë²ˆì´ 8ìë¦¬ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.').show();
          }else{
            $('#empInfo, #payslipInfo').hide();
          }
        });

        // ë°œê¸‰ ì§„í–‰ â†’ ë¯¸ë¦¬ë³´ê¸° ë Œë”
        $('#btnConfirmIssue').on('click', function(){
          const empNo = $('#empNo').val().trim();
          if(!empNo || empNo.length!==8){ return $('#errorMsg').text('ì‚¬ë²ˆì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.').show(); }
          if(!LAST_EMP_OBJ){ return $('#errorMsg').text('ì‚¬ë²ˆì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.').show(); }

          renderCertificatePage(LAST_EMP_OBJ, CURRENT_TYPE);
          closeModal();
        });

        // ê¸‰ì—¬ëª…ì„¸ì„œ ì¡°íšŒ
        $('#btnConfirmPayslip').on('click', function(){
          const empNo = $('#empNo').val().trim();
          if(!empNo || empNo.length!==8){ return $('#errorMsg').text('ì‚¬ë²ˆì„ ì •í™•íˆ ì…ë ¥í•˜ì„¸ìš”.').show(); }

          $.ajax({
            url:'/api/certificate/payslip',
            type:'GET',
            data:{empNo},
            success:(data)=>{
              if(!data){ return alertify.alert('ê¸‰ì—¬ ëª…ì„¸ì„œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); }
              renderPayslipPage(data);
              closeModal();
            },
            error: (xhr)=> alertify.alert('ê¸‰ì—¬ ëª…ì„¸ì„œ ì¡°íšŒ ì‹¤íŒ¨: ' + (xhr.responseJSON?.message || 'ì˜¤ë¥˜'))
          });
        });

        // ===== í…œí”Œë¦¿ =====
        function employmentTemplate(d){
          return `
            <div class="actions flex justify-end gap-2 mb-2">
              <button class="btn" onclick="issueCertificate('employment','${d.empNo||''}')">ë°œê¸‰</button>
              <button class="btn" onclick="window.print()">ì¸ì‡„</button>
              <button class="btn" onclick="goBack()">ëŒì•„ê°€ê¸°</button>
            </div>
            <section class="certificate-document p-8">
              <h1 class="text-center text-3xl font-bold mb-8">ì¬ì§ì¦ëª…ì„œ</h1>
              <table class="w-full border-collapse">
                <tr><th class="border p-3 bg-gray-50 text-left w-1/4">ì„±ëª…</th><td class="border p-3">${d.empName||''}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ì‚¬ë²ˆ</th><td class="border p-3">${d.empNo||''}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ì§ìœ„</th><td class="border p-3">${(d.jobName||'').slice(-2)}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ë¶€ì„œ</th><td class="border p-3">${d.deptName||''}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ì…ì‚¬ì¼</th><td class="border p-3">${d.hireDate||''}</td></tr>
              </table>
              <div class="mt-10 text-center text-lg">${new Date().toLocaleDateString('ko-KR')}</div>
            </section>
          `;
        }

        function careerTemplate(d){
          return `
            <div class="actions flex justify-end gap-2 mb-2">
              <button class="btn" onclick="issueCertificate('career','${d.empNo||''}')">ë°œê¸‰</button>
              <button class="btn" onclick="window.print()">ì¸ì‡„</button>
              <button class="btn" onclick="goBack()">ëŒì•„ê°€ê¸°</button>
            </div>
            <section class="certificate-document p-8">
              <h1 class="text-center text-3xl font-bold mb-8">ê²½ë ¥ì¦ëª…ì„œ</h1>
              <table class="w-full border-collapse">
                <tr><th class="border p-3 bg-gray-50 text-left w-1/4">ì„±ëª…</th><td class="border p-3">${d.empName||''}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ì‚¬ë²ˆ</th><td class="border p-3">${d.empNo||''}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ì§ìœ„</th><td class="border p-3">${(d.jobName||'').slice(-2)}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ë¶€ì„œ</th><td class="border p-3">${d.deptName||''}</td></tr>
              </table>
              <div class="mt-10 text-center text-lg">${new Date().toLocaleDateString('ko-KR')}</div>
            </section>
          `;
        }

        function payslipTemplate(d){
          const cur = (n)=> (Number(n||0)).toLocaleString('ko-KR')+'ì›';
          return `
            <div class="actions flex justify-end gap-2 mb-2">
              <button class="btn" onclick="goBack()">ëŒì•„ê°€ê¸°</button>
              <button class="btn" onclick="window.print()">ì¸ì‡„</button>
            </div>
            <section class="certificate-document p-8">
              <h1 class="text-center text-3xl font-bold mb-8">ê¸‰ì—¬ ëª…ì„¸ì„œ</h1>
              <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                <div><b>ì´ë¦„:</b> ${d.name||''}</div>
                <div><b>ì‚¬ë²ˆ:</b> ${d.empNo||''}</div>
                <div><b>ì§€ê¸‰ì¼:</b> ${d.payDate||''}</div>
                <div><b>ì§ê¸‰:</b> ${d.position||''}</div>
              </div>
              <h2 class="font-bold text-lg mt-8 mb-2">ì§€ê¸‰ ë‚´ì—­</h2>
              <table class="w-full border-collapse">
                <tr><th class="border p-3 bg-gray-50 text-left">ê¸°ë³¸ê¸‰</th><td class="border p-3 text-right">${cur(d.baseSalary)}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ì‹ëŒ€</th><td class="border p-3 text-right">${cur(d.mealAllowance)}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ì„±ê³¼ê¸‰</th><td class="border p-3 text-right">${cur(d.bonus)}</td></tr>
                <tr><th class="border p-3 font-bold text-left">ì´ ì§€ê¸‰ì•¡</th><td class="border p-3 font-bold text-right">${cur(d.totalPay)}</td></tr>
              </table>
              <h2 class="font-bold text-lg mt-8 mb-2">ê³µì œ ë‚´ì—­</h2>
              <table class="w-full border-collapse">
                <tr><th class="border p-3 bg-gray-50 text-left">êµ­ë¯¼ì—°ê¸ˆ</th><td class="border p-3 text-right">${cur(d.nationalPension)}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ê±´ê°•ë³´í—˜</th><td class="border p-3 text-right">${cur(d.healthInsurance)}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ê³ ìš©ë³´í—˜</th><td class="border p-3 text-right">${cur(d.employmentInsurance)}</td></tr>
                <tr><th class="border p-3 bg-gray-50 text-left">ì†Œë“ì„¸</th><td class="border p-3 text-right">${cur(d.incomeTax)}</td></tr>
                <tr><th class="border p-3 font-bold text-left">ì´ ê³µì œì•¡</th><td class="border p-3 font-bold text-right">${cur(d.totalDeduction)}</td></tr>
              </table>
              <div class="mt-8 text-center text-2xl font-bold">ì‹¤ìˆ˜ë ¹ì•¡: ${cur(d.netPay)}</div>
            </section>
          `;
        }

        // ë Œë”/ë°œê¸‰
        function renderCertificatePage(data, type){
          const html = (type==='employment') ? employmentTemplate(data)
                     : (type==='career')    ? careerTemplate(data) : '';
          $('#certificate-container').show().html(html);
          $('#main-content').hide();
        }
        function renderPayslipPage(data){
          $('#certificate-container').show().html(payslipTemplate(data));
          $('#main-content').hide();
        }
        window.goBack = function(){
          $('#certificate-container').hide().empty();
          $('#main-content').show();
        };

        window.issueCertificate = function(type, empNo){
          $.ajax({
            url:'/api/certificate/issue',
            method:'POST',
            contentType:'application/json',
            data: JSON.stringify({ type, empNo }),
            success:(res)=>{
              const msg = res?.message || 'ì¦ëª…ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë°œê¸‰ë˜ì–´ ë…¸ì…˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
              const extra = res?.issueNo ? `<br/>ë°œê¸‰ë²ˆí˜¸: <b>${res.issueNo}</b>` : '';
              alertify.alert('ë°œê¸‰ ì™„ë£Œ', msg + extra);
            },
            error:(xhr)=>{
              const m = xhr.responseJSON?.message || 'ì˜¤ë¥˜';
              alertify.alert('ì¦ëª…ì„œ ë°œê¸‰ ì‹¤íŒ¨', m);
            }
          });
        };
    </script>
</section>
</body>
</html>
