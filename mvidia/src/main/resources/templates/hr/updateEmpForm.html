<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA Â· ERP - ì¸ì‚¬ê´€ë¦¬ Â· ì‚¬ì› ì •ë³´ ë³€ê²½</title>
    <style>
        .accountCreate { grid-column: 2; grid-row: 2; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); width: 1200px; margin: 0 auto; }
        .accountCreate > .widget { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, .1); }
        .form { display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 14px; }
        .profile-section { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }
        .file-input-group { flex-grow: 1; }
        .form .field { display: flex; flex-direction: column; gap: 8px; }
        .form label { font-size: 12px; color: var(--muted); }
        .form input, .form select, .form textarea { padding: 10px 12px; border-radius: 12px; border: 1px solid #dde6ec; background: #fff; outline: none; }
        .form input[readonly] { background: #f1f5f8; color: #6f7c83; }
        .form .full { grid-column: 1 / -1; }
        .form .actions { grid-column: 1 / -1; display: flex; gap: 8px; margin-top: 6px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; background-color: #0c197f; color: #fff; }
        .btn.ghost { background: transparent; color: #002B39; border: 1px solid #002B39; }
        .badge { font-size: .7rem; color: #fff; padding: 2px 6px; border-radius: 8px; margin-left: 5px; vertical-align: middle; }
        .updated-badge { background: #28a745; }
        .error-msg { color: #d9534f; font-size: 10px; display: none; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="accountCreate">
        <div class="widget" id="home">
            <h3>ğŸ– ì‚¬ì› ì •ë³´ ë³€ê²½</h3>
            <br>

            <form th:action="@{/hr/updateEmp.hr}" class="form" method="post" id="updateForm" enctype="multipart/form-data">

                <!-- í”„ë¡œí•„: W ìƒíƒœ ìš”ì²­ì´ ìˆì„ ë•Œë§Œ 'ë³€ê²½ë¨' -->
                <th:block th:with="
        profileReq=${reqList != null ? reqList.?[fieldName == 'profilePic'] : null},
        hasProfileReq=${profileReq != null and !#lists.isEmpty(profileReq)}">

                    <div class="profile-section">
                        <img id="profile-preview" class="profile-pic"
                             th:src="${hasProfileReq} ? @{/uploadFiles/{f}(f=${profileReq[0].newValue})}
                                     : (${atch != null and atch.changeName != null}
                                          ? @{/uploadFiles/{f}(f=${atch.changeName})}
                                          : @{/images/default_profile.png})"
                             alt="í”„ë¡œí•„"/>

                        <div class="file-input-group">
                            <label style="margin-right:10px;"
                                   th:text="${atch != null && atch.originName != null ? atch.originName : 'í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ ì²¨ë¶€'}">
                                í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ ì²¨ë¶€
                            </label>
                            <br>
                            <span>ë³€ê²½í•  í”„ë¡œí•„ ì‚¬ì§„ : </span>
                            <input name="atchFile" type="file" accept="image/*" onchange="previewProfilePic(event)"/>
                            <span class="badge updated-badge" th:if="${hasProfileReq}">â­ ë³€ê²½ë¨</span>
                        </div>
                    </div>
                </th:block>

                <div class="field full">
                    <label>ì‚¬ë²ˆ*</label>
                    <input name="empNo" th:value="${emp != null ? emp.empNo : ''}" readonly/>
                </div>

                <div class="field full">
                    <label>ì´ë©”ì¼*</label>
                    <input name="email" type="email" th:value="${emp != null ? emp.email : ''}" readonly/>
                </div>

                <!-- ì„± -->
                <th:block th:with="lNameReq=${reqList != null ? reqList.?[fieldName == 'empLName'] : null}">
                    <div class="field">
                        <label>ì„±*</label>
                        <input name="empLName"
                               required oninput="validateKorean(this)"
                               th:value="${lNameReq != null and !lNameReq.isEmpty() ? lNameReq[0].newValue : (emp != null ? emp.empLName : '')}"/>
                        <span class="error-msg">í•œê¸€ ì„±/ì´ë¦„ì€ í•œê¸€ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span class="badge updated-badge" th:if="${lNameReq != null and !lNameReq.isEmpty()}">â­ ë³€ê²½ë¨</span>
                    </div>
                </th:block>

                <!-- ì´ë¦„ -->
                <th:block th:with="nameReq=${reqList != null ? reqList.?[fieldName == 'empName'] : null}">
                    <div class="field">
                        <label>ì´ë¦„*</label>
                        <input name="empName"
                               required oninput="validateKorean(this)"
                               th:value="${nameReq != null and !nameReq.isEmpty() ? nameReq[0].newValue : (emp != null ? emp.empName : '')}"/>
                        <span class="error-msg">í•œê¸€ ì„±/ì´ë¦„ì€ í•œê¸€ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span class="badge updated-badge" th:if="${nameReq != null and !nameReq.isEmpty()}">â­ ë³€ê²½ë¨</span>
                    </div>
                </th:block>

                <!-- ì˜ë¬¸ ì„± -->
                <th:block th:with="engLNameReq=${reqList != null ? reqList.?[fieldName == 'empEngLName'] : null}">
                    <div class="field">
                        <label>ì˜ë¬¸ ì„±*</label>
                        <input name="empEngLName"
                               required oninput="validateEnglish(this)"
                               th:value="${engLNameReq != null and !engLNameReq.isEmpty() ? engLNameReq[0].newValue : (emp != null ? emp.empEngLName : '')}"/>
                        <span class="error-msg">ì˜ë¬¸ ì„±/ì´ë¦„ì€ ì•ŒíŒŒë²³ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span class="badge updated-badge" th:if="${engLNameReq != null and !engLNameReq.isEmpty()}">â­ ë³€ê²½ë¨</span>
                    </div>
                </th:block>

                <!-- ì˜ë¬¸ ì´ë¦„ -->
                <th:block th:with="engNameReq=${reqList != null ? reqList.?[fieldName == 'empEngName'] : null}">
                    <div class="field">
                        <label>ì˜ë¬¸ ì´ë¦„*</label>
                        <input name="empEngName"
                               required oninput="validateEnglish(this)"
                               th:value="${engNameReq != null and !engNameReq.isEmpty() ? engNameReq[0].newValue : (emp != null ? emp.empEngName : '')}"/>
                        <span class="error-msg">ì˜ë¬¸ ì„±/ì´ë¦„ì€ ì•ŒíŒŒë²³ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span class="badge updated-badge" th:if="${engNameReq != null and !engNameReq.isEmpty()}">â­ ë³€ê²½ë¨</span>
                    </div>
                </th:block>

                <!-- ìƒë…„ì›”ì¼ -->
                <th:block th:with="birthdayReq=${reqList != null ? reqList.?[fieldName == 'birthday'] : null}">
                    <div class="field">
                        <label>ìƒë…„ì›”ì¼*</label>
                        <input name="birthday" type="date" required
                               th:value="${birthdayReq != null and !birthdayReq.isEmpty() ? birthdayReq[0].newValue : (emp != null ? emp.birthday : '')}"/>
                        <span class="badge updated-badge" th:if="${birthdayReq != null and !birthdayReq.isEmpty()}">â­ ë³€ê²½ë¨</span>
                    </div>
                </th:block>

                <!-- ë¶€ì„œ(í‘œì‹œëŠ” í•˜ë˜ 'ë³€ê²½ë¨' ë°°ì§€ ì œì™¸) -->
                <div class="field">
                    <label>ë¶€ì„œ*</label>
                    <select name="deptCode" required>
                        <option value="">ì„ íƒ</option>
                        <option value="D1" th:selected="${emp != null and emp.deptCode == 'D1'}">ì¸ì‚¬íŒ€</option>
                        <option value="D2" th:selected="${emp != null and emp.deptCode == 'D2'}">ê²½ì˜ê´€ë¦¬íŒ€</option>
                        <option value="D3" th:selected="${emp != null and emp.deptCode == 'D3'}">ìƒì‚°í’ˆì§ˆê´€ë¦¬íŒ€</option>
                        <option value="D4" th:selected="${emp != null and emp.deptCode == 'D4'}">ê¸°ìˆ ì§€ì›íŒ€</option>
                    </select>
                </div>

                <!-- ì§ê¸‰(í‘œì‹œëŠ” í•˜ë˜ 'ë³€ê²½ë¨' ë°°ì§€ ì œì™¸) -->
                <div class="field">
                    <label>ì§ê¸‰*</label>
                    <select name="jobNo" required>
                        <option value="">ì„ íƒ</option>
                        <option value="5" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ì‚¬ì›')}">ì‚¬ì›</option>
                        <option value="4" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ëŒ€ë¦¬')}">ëŒ€ë¦¬</option>
                        <option value="3" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ê³¼ì¥')}">ê³¼ì¥</option>
                        <option value="2" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ì°¨ì¥')}">ì°¨ì¥</option>
                        <option value="1" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ë¶€ì¥')}">ë¶€ì¥</option>
                    </select>
                </div>

                <!-- ì£¼ì†Œ -->
                <th:block th:with="addressReq=${reqList != null ? reqList.?[fieldName == 'address'] : null}">
                    <div class="field full">
                        <label>ì£¼ì†Œ*</label>
                        <input name="address" required
                               th:value="${addressReq != null and !addressReq.isEmpty() ? addressReq[0].newValue : (emp != null ? emp.address : '')}"/>
                        <span class="badge updated-badge" th:if="${addressReq != null and !addressReq.isEmpty()}">â­ ë³€ê²½ë¨</span>
                    </div>
                </th:block>

                <!-- ì „í™”ë²ˆí˜¸ -->
                <th:block th:with="phoneReq=${reqList != null ? reqList.?[fieldName == 'phone'] : null}">
                    <div class="field">
                        <label>ì „í™”ë²ˆí˜¸*</label>
                        <input name="phone" required placeholder="010-0000-0000" pattern="^01[016789]-?\d{3,4}-?\d{4}$"
                               th:value="${phoneReq != null and !phoneReq.isEmpty()? phoneReq[0].newValue : (emp != null ? emp.phone : '')}"/>
                        <span class="badge updated-badge" th:if="${phoneReq != null and !phoneReq.isEmpty()}">â­ ë³€ê²½ë¨</span>
                    </div>
                </th:block>

                <!-- ë‚´ì„ ë²ˆí˜¸ -->
                <th:block th:with="extNoReq=${reqList != null ? reqList.?[fieldName == 'extNo'] : null}">
                    <div class="field">
                        <label>ë‚´ì„ ë²ˆí˜¸</label>
                        <input name="extNo" placeholder="1234" pattern="^\d{3,5}$"
                               th:value="${extNoReq != null and !extNoReq.isEmpty()? extNoReq[0].newValue : (emp != null ? emp.extNo : '')}"/>
                        <span class="badge updated-badge" th:if="${extNoReq != null and !extNoReq.isEmpty()}">â­ ë³€ê²½ë¨</span>
                    </div>
                </th:block>

                <div class="field"><label>ì…ì‚¬ì¼*</label><input name="hireDate" type="date" th:value="${emp != null ? emp.hireDate : ''}" readonly/></div>

                <!-- ìˆ¨ê¹€ê°’ë“¤ (reqIdMapì€ ê·¸ëŒ€ë¡œ ìœ ì§€) -->
                <input type="hidden" name="originAtchId" th:value="${(atch != null && atch.atchId != null) ? atch.atchId : ''}"/>
                <input type="hidden" name="originName"   th:value="${(atch != null && atch.originName != null) ? atch.originName : ''}"/>
                <input type="hidden" name="changeName"   th:value="${(atch != null && atch.changeName != null) ? atch.changeName : ''}"/>
                <input type="hidden" name="refType"      th:value="${(atch != null && atch.refType != null) ? atch.refType : ''}"/>
                <input type="hidden" id="jobCode" name="jobCode">

                <th:block th:each="req : ${reqList}">
                    <input type="hidden" th:name="'reqIdMap[' + ${req.fieldName} + ']'" th:value="${req.reqId}"/>
                </th:block>

                <input type="hidden" name="managerId" th:value="${session != null and session.loginEmp != null ? session.loginEmp.empNo : ''}"/>

                <div class="actions">
                    <button class="btn" type="submit" id="submitBtn">ìˆ˜ì • ì‚¬í•­ ë°˜ì˜</button>
                    <button class="btn" id="resetAllBtn" type="button">ì´ˆê¸°í™”</button>
                    <a class="btn ghost" th:href="@{/hr/empAccount.hr}">ì·¨ì†Œ</a>
                </div>
            </form>

        </div>
    </div>

    <!-- í”„ë¡œí•„ íŒŒì¼ ì„ íƒ ë¯¸ë¦¬ë³´ê¸° + ë°°ì§€ í‘œì‹œ -->
    <script th:inline="javascript">
        function previewProfilePic(event) {
          const reader = new FileReader();
          const output = document.getElementById('profile-preview');
          const file = event.target.files[0];
          const badge = document.getElementById('badge-profile-updated');

          if (file) {
            reader.onload = function(){ output.src = reader.result; };
            reader.readAsDataURL(file);
            if (badge) badge.style.display = 'inline';
          } else {
            // íŒŒì¼ ì…ë ¥ì„ ë¹„ì› ìœ¼ë©´ (ìš”ì²­ ì´ë¯¸ì§€ or ê¸°ì¡´ ì´ë¯¸ì§€)ë¡œ ë³µê·€
            const fallback = output.dataset.newUrl || output.dataset.originalUrl;
            output.src = fallback;
            if (badge) {
              const hasProfileReq = /*[[${(reqList != null && #lists.size(reqList.?[fieldName == 'profilePic']) > 0)}]]*/ false;
              badge.style.display = hasProfileReq ? 'inline' : 'none';
            }
          }
        }
    </script>

    <script>
        function validateKorean(input){
          const re=/^[ê°€-í£]+$/;
          const e=input.parentNode.querySelector('.error-msg');
          e.style.display=(input.value && !re.test(input.value))?'block':'none';
        }
        function validateEnglish(input){
          const re=/^[a-zA-Z]+$/;
          const e=input.parentNode.querySelector('.error-msg');
          e.style.display=(input.value && !re.test(input.value))?'block':'none';
        }

        $(document).ready(function(){
          $('select[name="deptCode"], select[name="jobNo"]').on('change', updateJobCode);
          updateJobCode();

          function updateJobCode(){
            const deptCode=$('select[name="deptCode"]').val();
            const jobNo=$('select[name="jobNo"]').val();
            let deptInitial="";
            switch(deptCode){case 'D1':deptInitial='J1';break;case 'D2':deptInitial='J2';break;case 'D3':deptInitial='J3';break;case 'D4':deptInitial='J4';break;}
            if(deptInitial && jobNo){ $('#jobCode').val(deptInitial+jobNo); }
            else { $('#jobCode').val("[[${emp != null ? emp.jobCode : ''}]]"); }
          }

          // ì´ˆê¸°í™” ë²„íŠ¼
          $('#resetAllBtn').on('click', function(){
            // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
            const fileInput = document.querySelector('input[name="atchFile"]');
            const preview = document.getElementById('profile-preview');
            const badge = document.getElementById('badge-profile-updated');
            if(fileInput){ fileInput.value=''; }
            if(preview){ preview.src = preview.dataset.newUrl || preview.dataset.originalUrl; }
            if(badge){
              const hasReq = Boolean($('#updateForm [name^="reqIdMap[profilePic]"]').length);
              badge.style.display = hasReq ? 'inline' : 'none';
            }

            // ê° í•„ë“œ ì›ë³¸ìœ¼ë¡œ ë³µêµ¬
            $('#updateForm [data-original-value]').each(function(){
              $(this).val(this.dataset.originalValue);
            });
          });
        });
    </script>

    <script th:if="${alertMsg}">
        const alertMsg = '[[${alertMsg}]]';
        alertify.alert('ê³„ì • ìˆ˜ì •', alertMsg);
    </script>
</div>
</body>
</html>
