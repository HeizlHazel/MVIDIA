<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA Â· ERP - ì¸ì‚¬ê´€ë¦¬Â· íœ´ê°€ ì‹ ì²­ ëª©ë¡</title>
    <style>
        .hr-Vacation { grid-column: 2; grid-row: 2; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);  width: 1200px; margin: 0 auto; }
        .hr-Vacation > .widget { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, .1); }
        .search-container { display: flex; align-items: center; margin-bottom: 15px; }
        .search-container input, .search-container select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-right: 10px; }
        .search-container button { padding: 8px 12px; border: none; border-radius: 5px; background-color: #0c197f; color: #fff; cursor: pointer; }
        .hr-Vacation .action-buttons { display: none; }
        .hr-Vacation .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; background-color: #0c197f; color: #fff; }
        .hr-Vacation .btn:hover{background:#0050be; color:#fff}
        .hr-Vacation .ghost{ display: inline-flex; align-items: center; gap: 8px; padding: 5px 14px; margin-bottom:5px; border-radius: 12px; background: transparent; color: #002B39; border: 1px solid #002B39; text-decoration:none;}
        .hr-Vacation .ghost:hover{ background:#e7f3f7; }
        .hr-Vacation .va-cancel-btn{ display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; background: #fff; color: #002B39; border: 1px solid #002B39; margin-left:5px }
        .hr-Vacation .va-cancel-btn:hover{background:#e7f3f7; }
    </style>
</head>
<body>
<div class="hr-Vacation">
    <div class="widget" id="home">
        <h3>ğŸ“‘ íœ´ê°€ ì‹ ì²­ ëª©ë¡</h3>
        <br>
        <div class="stack">
            <a class="ghost" href="/hr/integratedAttendance.hr"><i class="bi bi-arrow-return-left"></i> í†µí•© ê´€ë¦¬í˜ì´ì§€ë¡œ</a>
        </div>

        <div class="search-container">
            <input type="text" id="vacationSearchKeyword" placeholder="ì‚¬ë²ˆ, ì´ë¦„, ì‚¬ìœ  ë“±" th:value="${param.keyword}">
            <select id="vacationSearchStatus">
                <option value="" th:selected="${param.status == null or param.status[0] == ''}">ìƒíƒœ ì „ì²´</option>
                <option value="W" th:selected="${param.status != null and param.status[0] == 'W'}">ëŒ€ê¸°</option>
                <option value="A" th:selected="${param.status != null and param.status[0] == 'A'}">ìŠ¹ì¸</option>
                <option value="D" th:selected="${param.status != null and param.status[0] == 'D'}">ë°˜ë ¤</option>
            </select>
            <select id="vacationSearchType">
                <option value="" th:selected="${param.type == null or param.type[0] == ''}">íœ´ê°€ ì¢…ë¥˜ ì „ì²´</option>
                <option value="HDL" th:selected="${param.type != null and param.type[0] == 'HDL'}">ë°˜ì°¨</option>
                <option value="AL" th:selected="${param.type != null and param.type[0] == 'AL'}">ì—°ì°¨</option>
                <option value="SL" th:selected="${param.type != null and param.type[0] == 'SL'}">ë³‘ê°€</option>
                <option value="FO" th:selected="${param.type != null and param.type[0] == 'FO'}">ê²½ì¡°ì‚¬</option>
                <option value="ML" th:selected="${param.type != null and param.type[0] == 'ML'}">ì¶œì‚°</option>
                <option value="RL" th:selected="${param.type != null and param.type[0] == 'RL'}">í¬ìƒ</option>
            </select>

            <button id="vacationSearchBtn">ê²€ìƒ‰</button>
        </div>

        <table class="table mt16">
            <thead><tr><th>#</th><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ì¢…ë¥˜</th><th>ê¸°ê°„</th><th>ì‚¬ìœ </th><th>ìƒíƒœ</th><th>ì¡°ì¹˜</th></tr></thead>
            <tbody id="vacationList">
            <tr th:if="${#lists.isEmpty(vaList)}">
                <td colspan="7" style="text-align: center;">ì¡°íšŒëœ íœ´ê°€ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            <tr th:unless="${#lists.isEmpty(vaList)}" th:each="va : ${vaList}">
                <td th:text="${vaStat.count}"></td>
                <td th:text="${va.empNo}"></td>
                <td th:text="${va.empName}"></td>
                <td>
                    <select class="va-type-select" th:data-original-type="${va.vaCategory}">
                        <option value="HDL" th:selected="${va.vaCategory eq 'HDL'}">ë°˜ì°¨</option>
                        <option value="AL" th:selected="${va.vaCategory eq 'AL'}" >ì—°ì°¨</option>
                        <option value="SL" th:selected="${va.vaCategory eq 'SL'}" >ë³‘ê°€</option>
                        <option value="FO" th:selected="${va.vaCategory eq 'FO'}" >ê²½ì¡°ì‚¬</option>
                        <option value="ML" th:selected="${va.vaCategory eq 'ML'}" >ì¶œì‚°</option>
                        <option value="RL" th:selected="${va.vaCategory eq 'RL'}" >í¬ìƒ</option>
                    </select>
                </td>
                <td th:text="${va.vaStart} + ' ~ ' + ${va.vaEnd}"></td>
                <td th:text="${va.vaReason}"></td>
                <td>
                    <select class="va-status-select" th:data-original-status="${va.vaStatus}">
                        <option value="W" th:selected="${va.vaStatus eq 'W'}" >ëŒ€ê¸°</option>
                        <option value="A" th:selected="${va.vaStatus eq 'A'}" >ìŠ¹ì¸</option>
                        <option value="D" th:selected="${va.vaStatus eq 'D'}">ê±°ì ˆ</option>
                    </select>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="va-update-btn btn" th:data-id="${va.vaId}">ë³€ê²½</button>
                        <button class="va-cancel-btn" th:data-id="${va.vaId}">ì·¨ì†Œ</button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="stack mt8" id="vacationPager" th:if="${pi.listCount > 0}" align="center">
            <a th:if="${pi.currentPage > 1}"
               th:href="@{/hr/vacationList.hr(
                                                  cpage=${pi.currentPage-1},
                                                  keyword=${param.keyword},
                                                  status=${param.status})}">&lt;</a>
            <span th:each="p : ${#numbers.sequence(pi.startPage, pi.endPage)}">
                <a  th:href="@{/hr/vacationList.hr(
                    cpage=${p},
                    keyword=${param.keyword},
                    status=${param.status})}"
                    th:text="${p}"
                    th:class="${pi.currentPage eq p ? 'active' : ''}"></a>
            </span>
            <a  th:href="@{/hr/vacationList.hr(
                cpage=${pi.currentPage+1},
                keyword=${param.keyword},
                status=${param.status})}"
                th:if="${pi.currentPage < pi.maxPage}">&gt;</a>
        </div>
    </div>
</div>
<script th:inline="javascript">
    const contextPath = [[@{/}]];

    // ìƒíƒœ ë³€ê²½ ê°ì§€ ë° ë²„íŠ¼ í‘œì‹œ
    $(document).on('change', '.va-status-select, .va-type-select', function() {
        const row = $(this).closest('tr');
        row.find('.action-buttons').css('display', 'flex');
    });

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
    $(document).on('click', '.va-cancel-btn', function() {
        const row = $(this).closest('tr');
        const statusSelect = row.find('.va-status-select');
        const typeSelect = row.find('.va-type-select');

        // ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
        statusSelect.val(statusSelect.data('original-status'));
        typeSelect.val(typeSelect.data('original-type'));

        // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        row.find('.action-buttons').css('display', 'none');
    });

    // ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì‹œ
    $(document).on('click', '.va-update-btn', function() {
        const vaId = $(this).data('id');
        const row = $(this).closest('tr');
        const newStatus = row.find('.va-status-select').val();
        const newType = row.find('.va-type-select').val();

        $.ajax({
            url: contextPath + 'hr/vacations/update',
            type: 'POST',
            data: { vaId: vaId, vaStatus: newStatus, vaCategory: newType },
            success: function(response) {
                if (response.success) {
                    alert('íœ´ê°€ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” UI ì—…ë°ì´íŠ¸
                    row.find('.va-status-select').data('original-status', newStatus);
                    row.find('.va-type-select').data('original-type', newType);
                    row.find('.action-buttons').css('display', 'none');
                } else {
                    alertify.alert('íœ´ê°€ ì •ë³´ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.message);
                }
            },
            error: function(xhr) {
                console.error("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ", xhr.responseText);
                alertify.alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ
    $('#vacationSearchBtn').on('click', function() {
        const keyword = $('#vacationSearchKeyword').val();
        const status = $('#vacationSearchStatus').val();
        const type = $('#vacationSearchType').val();

        window.location.href = contextPath + 'hr/vacationList.hr?cpage=1&keyword=' + encodeURIComponent(keyword) + '&status=' + encodeURIComponent(status) + '&type=' + encodeURIComponent(type);
    });
</script>
</body>
</html>