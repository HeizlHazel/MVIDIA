<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="adminMapper">

    <resultMap id="employeeResultSet" type="Employee">
        <result column="emp_no" property="empNo" />
        <result column="emp_lname" property="empLName" />
        <result column="emp_name" property="empName" />
        <result column="dept_name" property="deptName" />
        <result column="dept_code" property="deptCode"/>
        <result column="job_name" property="jobName"/>
    </resultMap>

    <resultMap id="permissionResultSet" type="Permission">
        <result column="perm_name" property="permName" />
        <result column="perm_code" property="permCode" />
        <result column="is_granted" property="isGranted" />
        <result column="user_id" property="userId" />
    </resultMap>

    <resultMap id="systemLogResultSet" type="SystemLog">
        <result column="log_id" property="logId" />
        <result column="log_type" property="logType" />
        <result column="target_id" property="targetId" />
        <result column="target_name" property="targetName" />
        <result column="actor_id" property="actorId" />
        <result column="action" property="action" />
        <result column="created_at" property="createdAt" />
        <result column="dept_name" property="deptName" />
    </resultMap>

    <select id="selectEmployee" resultMap="employeeResultSet">
        select
               emp_no
             , emp_lname
             , emp_name
             , dept_name
          from tb_employee
          join tb_department using(dept_code)
         where emp_no = #{empNo}
    </select>

    <select id="selectPermissionList" resultMap="permissionResultSet">
        select
               p.perm_name
             , p.perm_code
             , nvl(ep.is_granted, 'N') as is_granted
          from tb_permission p
     left join tb_emp_permission ep
            on p.perm_code = ep.perm_code
           and ep.user_id = #{empNo}
         order
            by p.perm_code
    </select>

    <select id="empPermissionRowExists" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM tb_emp_permission
        WHERE user_id = #{userId}
        AND perm_code = #{permCode}
    </select>


    <update id="deleteEmpPermission">
        update tb_emp_permission
           set is_granted = #{isGranted}
         where user_id = #{userId}
           and perm_code = #{permCode}
    </update>

    <update id="updateEmpPermission">
        update tb_emp_permission
        set is_granted = #{isGranted}
        where user_id = #{userId}
        and perm_code = #{permCode}
    </update>

    <insert id="insertEmpPermission">
        insert
          into tb_emp_permission
          (
            user_id
          , perm_code
          , is_granted
          )
        values
          (
            #{userId}
          , #{permCode}
          , #{isGranted}
          )
    </insert>

    <select id="getEmpPermission" resultMap="permissionResultSet">
        select perm_code
        from tb_emp_permission
        where user_id = #{userId}
        and is_granted = 'Y'
    </select>

    <insert id="insertApprovalLog" parameterType="map">
        insert
          into tb_system_log
          (
           log_type
          , target_id
          , target_name
          , actor_id
          , action
          , reason
          , notion_doc_id
          )
        values
          (
            #{logType}
          , #{targetId}
          , #{targetName}
          , #{actorId}
          , #{action}
          , #{reason}
          , #{notionDocId}
          )
    </insert>

    <insert id="insertPermissionLog" parameterType="map">
        insert
          into tb_system_log
          (
            log_type
          , target_id
          , target_name
          , actor_id
          , action
          , reason
          )
        values
          (
            #{logType}
          , #{targetId}
          , #{targetName}
          , #{actorId}
          , #{action}
          , #{reason}
          )
    </insert>

    <select id="selectPermissionLogListCount" resultType="_int">
        select count(*)
          from tb_system_log
         where log_type = 'PERMISSION'
    </select>

    <select id="selectPermissionLogList" resultType="map" parameterType="map">
        select * from (
            select
                l.log_id,
                l.target_name,
                l.action,
                TO_CHAR(l.created_at, 'YYYY-MM-DD HH24:MI:SS') as created_at,
                (actor.emp_lname || actor.emp_name) as actor_name,
                (target.emp_lname || target.emp_name) as target_emp_name,
                d.dept_name,
                ROW_NUMBER() OVER (ORDER BY l.created_at DESC, l.log_id DESC) as rn
            from tb_system_log l
            join tb_employee actor ON l.actor_id = actor.emp_no
            left join tb_employee target ON l.target_id = target.emp_no
            left join tb_department d ON target.dept_code = d.dept_code
            where l.log_type = 'PERMISSION'
        )
        where rn between #{startRow} and #{endRow}
    </select>

    <select id="selectApprovalLogListCount" resultType="_int">
        select count(*)
        from tb_system_log
        where log_type = 'APPROVAL'
    </select>

    <select id="selectApprovalLogList" resultType="map" parameterType="map">
        select * from (
        select
            l.LOG_ID,
            l.TARGET_ID,
            l.TARGET_NAME,
            l.ACTION,
            TO_CHAR(l.CREATED_AT, 'YYYY-MM-DD HH24:MI:SS') as CREATED_AT,
            (applicant.EMP_LNAME || applicant.EMP_NAME) as APPLICANT_NAME,
            (actor.EMP_LNAME || actor.EMP_NAME) as ACTOR_NAME,
            ROW_NUMBER() OVER (ORDER BY l.CREATED_AT DESC, l.LOG_ID DESC) as RN
        from tb_system_log l
        left join tb_employee applicant ON l.TARGET_ID = applicant.EMP_NO
        left join tb_employee actor ON l.ACTOR_ID = actor.EMP_NO
        where l.LOG_TYPE = 'APPROVAL'
        )
        where rn between #{startRow} and #{endRow}
    </select>

    <select id="selectManagerEmployees" resultMap="employeeResultSet">
        SELECT
            e.emp_no,
            e.emp_lname || e.emp_name emp_name,
            e.dept_code,
            j.job_name
        from tb_employee e
        join tb_job j on e.job_code = j.job_code
        where e.emp_status = 'H'
        and e.job_code like '%1'
        order by e.emp_name
    </select>
</mapper>
