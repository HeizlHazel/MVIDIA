<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>ChartListView</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);}
        .modal-content { background: #fff; margin: 10% auto; padding: 20px; border-radius: 12px; width: 900px;}
        .close { float: right; font-size: 24px; cursor: pointer;}
        input[type=number] { width: 60px; }
        select { width: 100%; }
        table { width: 100%; margin-top: 10px; border-collapse: collapse; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
        th { background-color: #f0f0f0; }
        .submit-btn { margin-top: 10px; padding: 5px 10px; }
        .card-container { display:flex; gap:10px; flex-wrap:wrap; }
        .schedule-card { border:1px solid #ccc; padding:10px; border-radius:8px; width:250px; }
        .card-chart { height:150px; }
    </style>
</head>
<body>
<h1>ğŸ› ï¸ ì‘ì—…ì§„í–‰í˜„í™©</h1>

<h5>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì¼ì • ì „ì²´ ì§„í–‰ë„</h5>
<div class="chart-container">
    <canvas id="progressChart"></canvas>
</div>

<script th:inline="javascript">
    const progTop5 = /*[[${progTop5}]]*/ [];
    const labels = progTop5.map(p => p.taskId);
    const dataValues = progTop5.map(p => p.progRate);

    new Chart(document.getElementById('progressChart'), {
        type: 'bar',
        data: { labels: labels, datasets: [{ label: 'ì§„í–‰ë¥  (%)', data: dataValues, backgroundColor: '#36A2EB' }] },
        options: { responsive:true, plugins:{ legend:{display:false} }, scales:{ y:{ beginAtZero:true, max:100, ticks:{callback: v=>v+'%'} } } }
    });
</script>

<a th:href="@{/schrList.bo}">ë”ë³´ê¸°</a>

<h3>ì¢…ë£Œ ì„ë°• ì¼ì • TOP 5</h3>
<div class="card-container">
    <div th:each="item,index : ${schrTop5}" class="schedule-card">
        <h4 th:text="${item.schName}">ì¼ì •ëª…</h4>
        <p><b>ì—…ì²´ëª…:</b> <span th:text="${item.bpPartner}">ì—…ì²´ëª…</span></p>
        <p><b>ì§„í–‰ë¥ :</b>
            <span th:text="${item.totalCount>0 ? (item.doneCount*100/item.totalCount) + '%' : '0%'}">0%</span>
        </p>
        <p><b>ì‹œì‘ì¼:</b> <span th:text="${#dates.format(item.startDate,'yyyy-MM-dd')}">2025-01-01</span></p>
        <p><b>ì¢…ë£Œì¼:</b> <span th:text="${#dates.format(item.endDate,'yyyy-MM-dd')}">2025-01-05</span></p>

        <!-- ì¹´ë“œë³„ ëˆ„ì ë§‰ëŒ€ -->
        <canvas th:attr="id='statusChartCard'+${index}" class="card-chart"></canvas>
        <!-- ì¹´ë“œë³„ ë„ë„› -->
        <canvas th:attr="id='defDonutCard'+${index}" class="card-chart"></canvas>
    </div>
</div>

<script th:inline="javascript">
    const schrTop5Donut = /*[[${schrTop5Donut}]]*/ [];

    /* ì¹´ë“œë³„ ì°¨íŠ¸ ìƒì„± */
    /* schrTop5: ëˆ„ì ë§‰ëŒ€ ë°ì´í„° / schrTop5Donut: ë„ë„› ë°ì´í„° */
    schrTop5.forEach((item, index)=>{
        // ëˆ„ì ë§‰ëŒ€
        const ctxBar = document.getElementById('statusChartCard'+index).getContext('2d');
        new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: ['ì™„ë£Œ(C)','ì§„í–‰ì¤‘(P)','ì§€ì—°(S)','ì˜ˆì •(W)'],
                datasets: [{
                    label: item.schName,
                    data: [item.doneCount, item.ingCount, item.delayCount, item.waitCount],
                    backgroundColor:['rgba(75,192,192,0.8)','rgba(54,162,235,0.8)','rgba(255,206,86,0.8)','rgba(201,203,207,0.8)']
                }]
            },
            options: {
                responsive:true,
                plugins:{ legend:{display:false}, datalabels:{
                    color:'black', anchor:'center', align:'center', formatter:(value)=> value > 0 ? value+'ê°œ' : '' }
                },
                scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
            },
            plugins:[ChartDataLabels]
        });

        // ë„ë„›
        const donutData = schrTop5Donut[index] || { defType: [], defCountType: [] };
        const ctxDonut = document.getElementById('defDonutCard'+index).getContext('2d');
        new Chart(ctxDonut, {
            type:'doughnut',
            data:{
                labels: donutData.defType,
                datasets:[{
                    data: donutData.defCountType,
                    backgroundColor:['#FF6384','#36A2EB','#FFCE56','#4BC0C0','#9966FF']
                }]
            },
            options:{ responsive:true, cutout:'60%', plugins:{ legend:{ position:'bottom' } } }
        });
    });
</script>

</body>
</html>
