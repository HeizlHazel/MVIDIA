<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA Â· ERP - ADMIN Â· ì „ìê²°ì¬ ì²˜ë¦¬ ë¡œê·¸</title>
    <style>
        /* ê°œë³„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .innerOuter {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 1200px;
            margin: 0 auto;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .refresh-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .refresh-btn:hover {
            background: #0056b3;
        }

        /* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ */
        .table-container {
            background: #fff;
            border: 1px solid #dee0ea;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .log-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
            font-size: 14px;
        }

        .log-table thead {
            background-color: #f8f9fa;
        }

        .log-table thead th {
            padding: 15px 12px;
            text-align: center;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee0ea;
            font-size: 14px;
        }

        .log-table tbody td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #f0f0f0;
            color: #555;
            vertical-align: middle;
        }

        .log-table tbody tr:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        .log-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* ì•¡ì…˜ ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .action-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .action-approve {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .action-reject {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f1b2b7;
        }

        /* ë¬¸ì„œëª… ìŠ¤íƒ€ì¼ */
        .document-name {
            font-weight: 500;
            color: #495057;
            text-align: left;
        }

        /* ë‚ ì§œ ìŠ¤íƒ€ì¼ */
        .date-cell {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #495057;
        }

        /* í˜ì´ì§• ìŠ¤íƒ€ì¼ */
        .pagination-container {
            display: flex;
            justify-content: center;
            margin: 30px 0;
        }

        .pagination {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            gap: 5px;
        }

        .pagination li {
            display: inline-block;
        }

        .pagination .page-link {
            display: block;
            padding: 8px 12px;
            text-decoration: none;
            color: #6c757d;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .pagination .page-link:hover {
            background-color: #e9ecef;
            color: #007bff;
        }

        .pagination .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }

        .pagination .page-item.disabled .page-link {
            color: #adb5bd;
            pointer-events: none;
            cursor: not-allowed;
        }

        /* ë°ì´í„° ì—†ìŒ ìƒíƒœ */
        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1250px) {
            .innerOuter {
                width: 95%;
                margin: 0 2.5%;
            }
        }

        @media (max-width: 768px) {
            .log-table {
                font-size: 12px;
            }

            .log-table thead th,
            .log-table tbody td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
<div class="content">
    <div class="innerOuter">
        <div class="header-section">
            <h3>ğŸ“‹ ì „ìê²°ì¬ ì²˜ë¦¬ ë¡œê·¸</h3>
            <button class="refresh-btn" onclick="refreshLogs()">ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <!-- í…Œì´ë¸” ì»¨í…Œì´ë„ˆ -->
        <div class="table-container">
            <table class="log-table">
                <thead>
                <tr>
                    <th width="10%">ë²ˆí˜¸</th>
                    <th width="12%">ìƒíƒœ</th>
                    <th width="25%">ë¬¸ì„œëª…</th>
                    <th width="18%">ì‹ ì²­ì</th>
                    <th width="12%">ê²°ì¬ì</th>
                    <th width="23%">ê²°ì¬ì¼ì‹œ</th>
                </tr>
                </thead>
                <tbody id="logTableBody">
                <!-- ë°ì´í„°ê°€ ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
                <tr>
                    <td colspan="6" class="no-data">ì „ìê²°ì¬ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- í˜ì´ì§• -->
        <div id="paginationContainer" class="pagination-container" style="display: none;">
            <ul id="pagination" class="pagination">
                <!-- í˜ì´ì§• ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </ul>
        </div>

        <!-- í†µê³„ ì •ë³´ -->
        <div id="statsInfo" style="text-align: center; margin-top: 20px; color: #6c757d; display: none;">
            <small>ì´ <span id="totalCount">0</span>ê±´ì˜ ì „ìê²°ì¬ ë¡œê·¸ê°€ ìˆìŠµë‹ˆë‹¤.</small>
        </div>
    </div>
</div>
<script th:inline="javascript">
    // ì „ì—­ ë³€ìˆ˜
    let currentPage = 1;
    let pageInfo = null;

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ì „ìê²°ì¬ ë¡œê·¸ í˜ì´ì§€ ë¡œë“œ');

        // Thymeleafì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„° ì‚¬ìš© (ì•ˆì „í•œ ë°©ì‹)
        let logList = [];
        let pageInfoData = {};
        let totalCount = 0;
        let currentPageNum = 1;

        try {
            // ì„œë²„ì—ì„œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ ì•ˆì „í•˜ê²Œ íŒŒì‹±
            logList = [[${jsLogList}]] || [];
            totalCount = [[${jsTotalCount}]] || 0;
            currentPageNum = [[${jsCurrentPage}]] || 1;
        } catch (e) {
            console.error('ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
            logList = [];
            totalCount = 0;
            currentPageNum = 1;
        }

        console.log('ë°›ì€ ë°ì´í„°:', {
            logListLength: logList.length,
            totalCount: totalCount,
            currentPageNum: currentPageNum
        });

        // ë°ì´í„° ë Œë”ë§
        if (logList && logList.length > 0) {
            console.log('ë°ì´í„°ê°€ ìˆìŒ, í…Œì´ë¸” ë Œë”ë§ ì‹œì‘');
            renderLogTable(logList, currentPageNum, totalCount);
            if (pageInfoData && pageInfoData.maxPage) {
                renderPagination(pageInfoData);
            }
            showStats(totalCount);
        } else {
            console.log('ë°ì´í„°ê°€ ì—†ìŒ');
            showNoData();
        }
    });

    // í…Œì´ë¸” ë Œë”ë§
    function renderLogTable(logList, currentPage, totalCount) {
        console.log('renderLogTable í˜¸ì¶œ:', logList.length + 'ê±´');

        const tbody = document.getElementById('logTableBody');
        tbody.innerHTML = '';

        logList.forEach((log, index) => {
            const row = document.createElement('tr');
            // ë²ˆí˜¸ ê³„ì‚°: ì „ì²´ì—ì„œ ì—­ìˆœìœ¼ë¡œ (ìµœì‹ ì´ í° ë²ˆí˜¸)
            const rowNumber = totalCount - ((currentPage - 1) * 10 + index);

            row.innerHTML = `
                <td>${rowNumber}</td>
                <td>
                    <span class="action-badge ${log.ACTION === 'APPROVE' ? 'action-approve' : 'action-reject'}">
                        ${log.ACTION === 'APPROVE' ? 'ìŠ¹ì¸' : 'ë°˜ë ¤'}
                    </span>
                </td>
                <td class="document-name">${escapeHtml(log.TARGET_NAME) || 'ë¬¸ì„œëª… ì—†ìŒ'}</td>
                <td>${escapeHtml(log.APPLICANT_NAME) || 'ì‹ ì²­ì ì—†ìŒ'}</td>
                <td>${escapeHtml(log.ACTOR_NAME) || 'ê²°ì¬ì ì—†ìŒ'}</td>
                <td class="date-cell">${log.CREATED_AT || 'ë‚ ì§œ ì—†ìŒ'}</td>
            `;
            tbody.appendChild(row);
        });
    }

    // í˜ì´ì§• ë Œë”ë§
    function renderPagination(pageInfo) {
        if (!pageInfo || pageInfo.maxPage <= 1) {
            document.getElementById('paginationContainer').style.display = 'none';
            return;
        }

        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';

        // ì´ì „ ë²„íŠ¼
        const prevLi = document.createElement('li');
        prevLi.className = pageInfo.currentPage <= 1 ? 'page-item disabled' : 'page-item';
        prevLi.innerHTML = `<a class="page-link" href="${pageInfo.currentPage > 1 ? '/approvelog?currentPage=' + (pageInfo.currentPage - 1) : '#'}">ì´ì „</a>`;
        pagination.appendChild(prevLi);

        // í˜ì´ì§€ ë²ˆí˜¸ë“¤
        for (let i = pageInfo.startPage; i <= pageInfo.endPage; i++) {
            const pageLi = document.createElement('li');
            pageLi.className = i === pageInfo.currentPage ? 'page-item active' : 'page-item';
            pageLi.innerHTML = `<a class="page-link" href="/approvelog?currentPage=${i}">${i}</a>`;
            pagination.appendChild(pageLi);
        }

        // ë‹¤ìŒ ë²„íŠ¼
        const nextLi = document.createElement('li');
        nextLi.className = pageInfo.currentPage >= pageInfo.maxPage ? 'page-item disabled' : 'page-item';
        nextLi.innerHTML = `<a class="page-link" href="${pageInfo.currentPage < pageInfo.maxPage ? '/approvelog?currentPage=' + (pageInfo.currentPage + 1) : '#'}">ë‹¤ìŒ</a>`;
        pagination.appendChild(nextLi);

        document.getElementById('paginationContainer').style.display = 'flex';
    }

    // ë°ì´í„° ì—†ìŒ í‘œì‹œ
    function showNoData(message = 'ì „ìê²°ì¬ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.') {
        const tbody = document.getElementById('logTableBody');
        tbody.innerHTML = `<tr><td colspan="6" class="no-data">${message}</td></tr>`;
        document.getElementById('paginationContainer').style.display = 'none';
    }

    // í†µê³„ ì •ë³´ í‘œì‹œ
    function showStats(totalCount) {
        document.getElementById('totalCount').textContent = totalCount;
        document.getElementById('statsInfo').style.display = 'block';
    }

    // ìƒˆë¡œê³ ì¹¨
    function refreshLogs() {
        location.reload();
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜ (ë” ì•ˆì „í•˜ê²Œ ìˆ˜ì •)
    function escapeHtml(text) {
        if (!text) return '';
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;')
            .replace(/\//g, '&#x2F;');
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateStr) {
        if (!dateStr) return '';
        try {
            const date = new Date(dateStr);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return dateStr;
        }
    }
</script>
</body>
</html>