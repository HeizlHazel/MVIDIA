<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>ChartListView</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0; top: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
        background: #fff;
        margin: 10% auto;
        padding: 20px;
        border-radius: 12px;
        width: 900px;
        }
        .close {
        float: right;
        font-size: 24px;
        cursor: pointer;
        }
            input[type=number] { width: 60px; }
    select { width: 100%; }
    table { width: 100%; margin-top: 10px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }
    th { background-color: #f0f0f0; }
    .submit-btn { margin-top: 10px; padding: 5px 10px; }
    </style>
</head>
<body>
<h1>ğŸ› ï¸ ì‘ì—…ì§„í–‰í˜„í™©</h1>



<h5>í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì¼ì • ì „ì²´ ì§„í–‰ë„</h5>
<div class="chart-container">
    <canvas id="progressChart"></canvas>
</div>

<script th:inline="javascript">

    // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ë³€í™˜
    const progTop5Data = /*[[${progTop5}]]*/ [];

    const labels = progTop5Data.map(p => p.taskId);
    const dataValues = progTop5Data.map(p => p.progRate);

    const ctx = document.getElementById('progressChart');

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels, // ì¼ì •ëª…
        datasets: [{
          label: 'ì§„í–‰ë¥  (%)',
          data: dataValues, // ìƒ˜í”Œ ì§„í–‰ë¥ 
          backgroundColor: '#36A2EB'
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { display: false }, // ìƒë‹¨ ë²”ë¡€ ìˆ¨ê¹€
          tooltip: {
            callbacks: {
              label: (context) => context.raw + '%'
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: (value) => value + '%'
            }
          }
        }
      }
    });
</script>

<!-- ê°œë³„ ì¼ì • ìƒì„¸ ì§„í–‰ë¥   -->
<a th:href="@{/schrList.bo}">ë”ë³´ê¸°</a>

<div class="chart-section">
    <h3>ëˆ„ì  ì§„í–‰ í˜„í™©</h3>
    <canvas id="statusChart"></canvas>
</div>

<script>
    // ì´ˆê¸° ë°ì´í„° (ì˜ˆì‹œ)
    let scheduleData = [
      { schr_id: ${shcr_id}, doneCount: 2, progressCount: 5, delayCount: 2, planCount: 1, totalCount: ${total_count} }
    ];

    const ctx = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: scheduleData.map(d => d.schr_id),
        datasets: [
          { label: 'ì™„ë£Œ(C)', data: scheduleData.map(d=>d.doneCount), backgroundColor:'rgba(75,192,192,0.8)' },
          { label: 'ì§„í–‰ì¤‘(P)', data: scheduleData.map(d=>d.progressCount), backgroundColor:'rgba(54,162,235,0.8)' },
          { label: 'ì§€ì—°(S)', data: scheduleData.map(d=>d.delayCount), backgroundColor:'rgba(255,206,86,0.8)' },
          { label: 'ëŒ€ê¸°(W)', data: scheduleData.map(d=>d.planCount), backgroundColor:'rgba(201,203,207,0.8)' }
        ]
      },
      options: {
        indexAxis: 'y',
        scales: {
        y: { stacked: true },
        x: { stacked: true }
        },
        responsive:true,
        plugins:{
          title:{ display:true, text:'ìƒíƒœë³„ ëˆ„ì  ê²€ì‚¬ ê±´ìˆ˜' },
          legend:{
              position:'bottom',
              labels:{
                  usePointStyle: true,
                  pointStyle: 'circle',
                  boxWidth: 8,
                  boxHeight: 8,
                  padding: 10,
                  textAlign: 'center',
                  font:{size: 11}
              }
          },
          datalabels:{
            color:'black',
            anchor:'center',
            align:'center',
            offset: 2,
            formatter:(value, context)=>{
              const idx = context.dataIndex;
              const total = scheduleData[idx].totalCount;
              const done = scheduleData[idx].doneCount;
              const progRate = total>0?Math.round(done*100/total):0;
              return progRate+'%';
            }
          }
        },
        scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, ticks:{precision:0} } }
      },
      plugins:[ChartDataLabels]
    });

    // ì¼ì • ì„ íƒ ì‹œ total/def í‘œì‹œ
    document.getElementById('schrSelect').addEventListener('change', function(){
      const selected = this.selectedOptions[0];
      if(selected && selected.value){
        document.getElementById('totalCount').innerText = selected.dataset.total;
        document.getElementById('defCount').innerText = selected.dataset.def;
        // ê¸°ë³¸ ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('doneInput').value = 0;
        document.getElementById('progressInput').value = 0;
        document.getElementById('delayInput').value = 0;
        document.getElementById('planInput').value = 0;
      } else {
        document.getElementById('totalCount').innerText = '-';
        document.getElementById('defCount').innerText = '-';
      }
    });

    // ê°’ ë„£ê¸° ë²„íŠ¼
    document.getElementById('updateBtn').addEventListener('click', ()=>{
      const schrId = document.getElementById('schrSelect').value;
      if(!schrId) return alert("ì¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

      const done = parseInt(document.getElementById('doneInput').value)||0;
      const progress = parseInt(document.getElementById('progressInput').value)||0;
      const delay = parseInt(document.getElementById('delayInput').value)||0;
      const plan = parseInt(document.getElementById('planInput').value)||0;

      // ì„ íƒí•œ ì¼ì • ë°ì´í„° ì—…ë°ì´íŠ¸
      const idx = scheduleData.findIndex(d=>d.schr_id===schrId);
      if(idx>=0){
        scheduleData[idx].doneCount = done;
        scheduleData[idx].progressCount = progress;
        scheduleData[idx].delayCount = delay;
        scheduleData[idx].planCount = plan;
      } else {
        scheduleData.push({ schr_id: schrId, doneCount: done, progressCount: progress, delayCount: delay, planCount: plan, totalCount: parseInt(document.getElementById('totalCount').innerText) });
      }

      // ì°¨íŠ¸ ë°ì´í„° ê°±ì‹ 
      statusChart.data.datasets[0].data = scheduleData.map(d=>d.doneCount);
      statusChart.data.datasets[1].data = scheduleData.map(d=>d.progressCount);
      statusChart.data.datasets[2].data = scheduleData.map(d=>d.delayCount);
      statusChart.data.datasets[3].data = scheduleData.map(d=>d.planCount);
      statusChart.update();
    });

  <!-- ë¶ˆëŸ‰ë¥  ë„ë„› ì°¨íŠ¸ ë¶€ë¶„ -->
  <div class="donut-chart-container" style="--defect-rate: 72deg;">
      <div class="donut-chart-label">20%</div>
  </div>
  <!-- ì¶”í›„ ê°€ëŠ¥í•˜ë©´ ì‚¬ìš©í•˜ê¸° ìƒì„¸ë³´ê¸°-> ëª¨ë‹¬ì°½
  ì¼ì • ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”© (onclick or addEventListener)
  í•´ë‹¹ ì¼ì • ID(schrId) Ajaxë¡œ ì¡°íšŒ â†’ ìƒì„¸ ë°ì´í„° ê°€ì ¸ì™€ì„œ ëª¨ë‹¬ì°½ ì¶œë ¥

  document.querySelectorAll(".schedule-item").forEach(item => {
    item.addEventListener("click", function() {
      const schId = this.dataset.schId;
      fetch(`/progress/detail/${schId}`)
        .then(res => res.json())
        .then(data => {
          // ëª¨ë‹¬ì°½ì— ë°ì´í„° ì±„ìš°ê¸°
          document.getElementById("modal-title").innerText = data.schNo;
          document.getElementById("modal-body").innerText = JSON.stringify(data);
          $("#detailModal").modal("show");
        });
    });
  });
  -->


  <!--/*
      ì¢…ë£Œì„ë°•ìˆœ 5ê°œ ì¼ì •ë§Œ í‘œì‹œ
      <div th:each="schedule : ${schrTopList}">
          <p>
              <span th:text="${schedule.bpPartner}"></span>
              | ì§„í–‰ë¥ : <span th:text="${#numbers.formatDecimal(schedule.totalCount > 0 ? schedule.defCount*100.0/schedule.totalCount : 0, 0, 2)}"></span>%
          </p>
      </div>



       ì°¨íŠ¸ ì˜ì—­
      <canvas id="myChart"></canvas>

      <script>
          const ctx = document.getElementById('myChart');

          const labels = [
              /* Thymeleaf ë°˜ë³µë¬¸ìœ¼ë¡œ ì œí’ˆëª…/ì½”ë“œ ì‚½ì… */
              /* ì˜ˆì‹œ */
              <th:block th:each="p : ${progTop5}">'[[${p.itemCode}]]',</th:block>
          ];
          const dataValues = [
              <th:block th:each="p : ${progTop5}">[[${p.progRate}]],</th:block>
          ];

          new Chart(ctx, {
              type: 'bar',
              data: {
                  labels: labels,
                  datasets: [{
                      label: 'ì‘ì—… ì§„í–‰ë¥ ',
                      data: dataValues,
                      backgroundColor: '#186aea'
                  }]
              },
              options: { responsive: true }
          });
    </script>
    */-->





<!--------------------------------------------------------------------------------------------------------------------->
<!-- ì¼ì • ì„ íƒ ë° ìƒíƒœ ì…ë ¥ -->
<!-- ë²„íŠ¼ -->
<button id="openModalBtn" class="submit-btn">ì„ì‹œ ì…ë ¥</button>
<!-- ëª¨ë‹¬ -->
<div id="inputModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>

        <h3>ì¼ì • ì„ íƒ ë° ìƒíƒœ ì…ë ¥</h3>
        <label for="schrSelect"><b>í’ˆì§ˆ ì ê²€ ì¼ì • ì„ íƒ:</b></label>
        <select id="schrSelect">
            <option value="">--------------------------- ì¼ì • ì„ íƒ ----------------------------</option>
            <option th:each="s: ${schrList}"
                    th:value="${s.schrId}"
                    th:data-total="${s.totalCount}"
                    th:data-def="${s.defCount}"
                    th:text="${s.schNo} + ' : (' + ${s.itemCode} + ')'"></option>
        </select>

        <table>
            <tr>
                <th>ì „ì²´</th><th>ë¶ˆëŸ‰</th>
            </tr>
            <tr>
                <td id="totalCount">-</td>
                <td id="defCount">-</td>
            </tr>
        </table>

        <table>
            <tr>
                <th style="background-color: rgba(75,192,192,0.8)">ì™„ë£Œ(C)</th>
                <th style="background-color: rgba(54,162,235,0.8)">ì§„í–‰ì¤‘(P)</th><br>
                <th style="background-color: rgba(255,206,86,0.8)">ì§€ì—°(S)</th>
                <th style="background-color: rgba(201,203,207,0.8)">ëŒ€ê¸°(W)</th>
            </tr>
            <tr>
                <td><input type="number" id="doneInput" value="0" min="0"></td>
                <td><input type="number" id="progressInput" value="0" min="0"></td>
                <td><input type="number" id="delayInput" value="0" min="0"></td>
                <td><input type="number" id="stayInput" value="0" min="0"></td>
            </tr>
        </table>

        <button class="submit-btn" id="updateBtn">ê°’ ë„£ê¸°</button>
    </div>
</div>

<!-- JS -->
<script>
    const modal = document.getElementById("inputModal");
    const openBtn = document.getElementById("openModalBtn");
    const closeBtn = document.querySelector(".close");

    // ì—´ê¸°
    openBtn.onclick = () => modal.style.display = "block";

    // ë‹«ê¸° (X ë²„íŠ¼)
    closeBtn.onclick = () => modal.style.display = "none";

    // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = (e) => {
      if (e.target === modal) modal.style.display = "none";
    };
</script>

</body>
</html>