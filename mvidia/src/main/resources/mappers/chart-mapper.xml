<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="chartMapper">

    <resultMap id="ChartResultSet" type="ScheduleRegistration">
        <result column="schr_id" property="schrId" />
        <result column="sch_no" property="schNo" />
        <result column="cat_code" property="catCode" />
        <result column="bp_partner" property="bpPartner" />
        <result column="emp_no" property="empNo" />
        <result column="start_date" property="startDate" />
        <result column="end_date" property="endDate" />
        <result column="color_id" property="colorId" />
        <result column="details" property="details" />
        <result column="total_count" property="totalCount" />
        <result column="def_count" property="defCount" />
        <result column="task_code" property="taskCode" />
        <result column="item_code" property="itemCode" />
    </resultMap>

    <resultMap id="ProgressResultSet" type="ProgressChart">
        <result column="task_code" property="taskCode" />
        <result column="task_id" property="taskId" />
        <result column="item_code" property="itemCode" />
        <result column="start_date" property="startDate" />
        <result column="end_date" property="endDate" />
        <result column="prog_rate" property="progRate" />
    </resultMap>

    <!-- 품질점검 일정 (전체검사 수 / 불량검사 수 )-->
    <select id="selectScheduleRegistration" resultMap="ChartResultSet">
        select
               schr_id
             , sch_no
             , cat_code
             , bp_partner
             , emp_no
             , start_date
             , end_date
             , color_id
             , details
             , total_count
             , def_count
             , task_code
             , item_code
          from tb_schedule_registration
    </select>

    <select id="selectProgressChart" resultMap="ProgressResultSet">
        select
               task_code
             , task_id
             , item_code
             , start_date
             , end_date
             , prog_rate
          from tb_progress_chart
    </select>

    <!-- 개별 일정 top5 -->
    <select id="selectTop5Schr" resultMap="ChartResultSet">
        select *
          from (
               select
                      s.schr_id
                    , p.task_code
                    , p.item_code
                    , s.start_date
                    , s.end_date
                    , sum(case when q.check_status = 'C' then q.def_count else 0 end) as doneCount
                    , sum(case when q.check_status = 'P' then q.def_count else 0 end) as progressCount
                    , sum(case when q.check_status = 'S' then q.def_count else 0 end) as delayCount
                    , sum(case when q.check_status = 'W' then q.def_count else 0 end) as planCount
                 from tb_progress_chart p
                 join tb_schedule_registration s on p.task_id = s.schr_id
                 left
                 join tb_quality_check q on s.schr_id = q.schr_id
                group
                   by s.schr_id, p.task_code, p.item_code, s.start_date, s.end_date
                order
                   by s.end_date
               )
         where rownum &lt;= 5
    </select>

    <!-- 현재 진행 중인 일정 진행률 top5 -->
    <select id="selectTop5Prog" resultMap="ProgressResultSet">
        select *
          from (
               select
                      p.task_code
                    , p.task_id
                    , p.item_code
                    , s.schr_id
                    , s.start_date
                    , s.end_date
                    , case when s.total_count > 0
                      then round( nvl(sum(case when q.check_status='C' then 1 else 0 end),0) * 100.0 / s.total_count, 2 )
                      else 0
                      end as prog_rate
                 from tb_progress_chart p
                 join tb_schedule_registration s on p.task_id = s.schr_id
                 left
                 join tb_quality_check q on s.schr_id = q.schr_id
                group
                   by p.task_code, p.task_id, p.item_code, s.schr_id, s.start_date, s.end_date, s.total_count
                order
                   by s.end_date
               )
         where rownum &lt;= 5
    </select>

    <!-- 개별 일정 전체 (더보기 클릭-> 페이지 이동) -->
    <select id="selectAllSchr" resultMap="ChartResultSet">
        select
               s.schr_id
             , s.sch_no
             , p.task_code
             , p.item_code
             , s.start_date
             , s.end_date
             , sum(case when q.check_status = 'C' then q.def_count else 0 end) as doneCount
             , sum(case when q.check_status = 'P' then q.def_count else 0 end) as progressCount
             , sum(case when q.check_status = 'S' then q.def_count else 0 end) as delayCount
             , sum(case when q.check_status = 'W' then q.def_count else 0 end) as planCount
          from tb_progress_chart p
          join tb_schedule_registration s on p.task_id = s.schr_id
          left
          join tb_quality_check q on s.schr_id = q.schr_id
         group
            by s.schr_id, s.sch_no, p.task_code, p.item_code, s.start_date, s.end_date
         order
            by s.end_date
    </select>
 </mapper>