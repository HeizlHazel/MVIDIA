<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA · ERP - 마이페이지 · 개인 정보 수정 요청</title>
    <style>
        .profileUpdatePage > .widget {background:#fff;border-radius:10px;padding:20px;box-shadow:0 2px 10px rgba(0,0,0,.1);width:1200px;margin:0 auto}
        .form-group{margin-bottom:15px}
        .form-group label{display:block;margin-bottom:6px;font-weight:700}
        .form-group input,.form-group select,.form-group textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
        .profile-section{display:flex;align-items:center;gap:20px;margin-bottom:15px}
        .profile-pic{width:80px;height:80px;border-radius:50%;object-fit:cover;border:1px solid #ddd}
        .file-input-group{flex-grow:1}
        .error-message{color:#d9534f;font-size:12px;margin-top:5px;display:none}
        .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background-color:#0c197f;color:#fff;border:none;cursor:pointer;transition:background-color .2s}
        .btn:hover{background:#0050be}
        .btn:disabled{background-color:#ccc;cursor:not-allowed}
        .btn-secondary{background-color:#6c757d}
        .btn-secondary:hover{background-color:#5a6268}
    </style>
</head>
<body>
<div class="profileUpdatePage" id="profile-edit-request">
    <div class="widget" id="home">
        <h3>✏️ 개인정보 수정 요청</h3>
        <br>

        <form id="editReqForm" action="/updateInfo.emp" method="post" enctype="multipart/form-data">
            <!-- 프로필 사진 -->
            <div class="profile-section">
                <th:block th:with="pf=${(atch != null and atch.fileStatus == 'U') ? atch.changeName : null}">
                    <img id="profile-preview" class="profile-pic"
                         th:src="${#strings.isEmpty(pf)} ? @{/images/default_profile.png}
                                                         : @{/uploadFiles/{f}(f=${pf})}"
                         alt="프로필">
                </th:block>
                <div class="file-input-group">
                    <label style="margin-right:10px;"
                           th:text="${atch != null ? atch.originName : '프로필 사진 미 첨부'}">프로필 사진 미 첨부</label><br>
                    <span>변경할 프로필 사진 : </span>
                    <input name="atchFile" type="file" accept="image/*" onchange="previewProfilePic(event)">
                </div>
            </div>

            <!-- 한글 성/이름 (필수) -->
            <div class="form-group">
                <label>성 (한글)</label>
                <input name="empLName" th:value="${session.loginEmp.empLName}" type="text" placeholder="변경할 성">
                <div class="error-message" id="empLName-kor-err">한글로 입력해주세요.</div>
            </div>
            <div class="form-group">
                <label>이름 (한글)</label>
                <input name="empName" th:value="${session.loginEmp.empName}" type="text" placeholder="변경할 이름">
                <div class="error-message" id="empName-kor-err">한글로 입력해주세요.</div>
            </div>

            <!-- 영문 성/이름 (선택) -->
            <div class="form-group">
                <label>영문 성 (선택)</label>
                <input name="empEngLName" th:value="${session.loginEmp.empEngLName}" type="text" placeholder="변경할 영문성">
                <div class="error-message" id="empEngLName-eng-err">영문 알파벳만 입력해주세요.</div>
            </div>
            <div class="form-group">
                <label>영문 이름 (선택)</label>
                <input name="empEngName" th:value="${session.loginEmp.empEngName}" type="text" placeholder="변경할 영문이름">
                <div class="error-message" id="empEngName-eng-err">영문 알파벳만 입력해주세요.</div>
            </div>

            <!-- 기타 필수 -->
            <div class="form-group"><label>생년월일</label><input name="birthday" th:value="${session.loginEmp.birthday}" type="date"></div>
            <div class="form-group"><label>주소</label><input name="address" th:value="${session.loginEmp.address}" type="text" placeholder="변경할 주소"></div>
            <div class="form-group">
                <label>전화번호</label>
                <input name="phone" th:value="${session.loginEmp.phone}" type="tel" placeholder="예) 010-1234-5678">
                <div class="error-message" id="phone-dup-error">중복된 전화번호 입니다.</div>
            </div>
            <div class="form-group"><label>내선번호</label><input name="extNo" th:value="${session.loginEmp.extNo}" type="tel" placeholder="변경할 내선번호"></div>

            <input type="hidden" name="originAtchNo" th:value="${atch?.atchId}" />
            <input type="hidden" name="oldValue" th:value="${atch != null ? atch.changeName : ''}" />
            <input type="hidden" name="empNo" th:value="${session.loginEmp.empNo}" />

            <button type="button" class="btn" id="submitBtn" onclick="submitProfileEditRequest()">수정 요청 제출</button>
            <button type="button" class="btn btn-secondary" onclick="window.location.href='/myPage/profile'">취소</button>
        </form>
    </div>
</div>

<script th:inline="javascript">
    const PHONE_CHECK_URL = '/checkPhone';
    const PHONE_PATTERN = /^01[0-9]-?\d{3,4}-?\d{4}$/;

    let initialFormState = {};
    let isPhoneUnique = true;
    let isKoreanLNameValid = true;
    let isKoreanNameValid  = true;
    let isEnglishLNameValid = true;
    let isEnglishNameValid  = true;

    const fieldLabels = {
      empLName:'성', empName:'이름', empEngLName:'영문성', empEngName:'영문이름',
      birthday:'생년월일', address:'주소', phone:'전화번호', extNo:'내선번호'
    };

    document.addEventListener('DOMContentLoaded', () => {
      initialFormState = getFormValues();

      bindValidationHandlers();

      // ✅ 초기 유효성 한 번 계산
      validateNamesPerField();
      updateSubmitState();
    });

    function getFormValues() {
      const values = {};
      document.querySelectorAll('#editReqForm input:not([type="file"])').forEach(el=>{
        values[el.name] = el.value || '';
      });
      values['atchFile'] = (document.querySelector('input[name="atchFile"]').value || '');
      return values;
    }

    // === 필수값(영문 성/이름 제외) ===
    function areRequiredFilled() {
      const required = ['empLName','empName','birthday','address','phone'];
      return required.every(n => (document.querySelector(`input[name="${n}"]`)?.value || '').trim() !== '');
    }

    function updateSubmitState() {
      const btn = document.getElementById('submitBtn');
      const phoneVal = (document.querySelector('input[name="phone"]').value || '').trim();
      const phonePatternOK = PHONE_PATTERN.test(phoneVal);

      // 전화번호 에러 표시
      const dupEl = document.getElementById('phone-dup-error');
      if (!phonePatternOK) {
        dupEl.textContent = '전화번호 형식이 올바르지 않습니다. 예) 010-1234-5678';
        dupEl.style.display = 'block';
      } else if (!isPhoneUnique) {
        dupEl.textContent = '중복된 전화번호 입니다.';
        dupEl.style.display = 'block';
      } else {
        dupEl.style.display = 'none';
      }

      const canSubmit =
        areRequiredFilled() &&
        isKoreanLNameValid &&
        isKoreanNameValid &&
        isEnglishLNameValid &&
        isEnglishNameValid &&
        phonePatternOK &&
        isPhoneUnique;

      btn.disabled = !canSubmit;
    }

    function validateNamesPerField() {
      const kor = /^[가-힣]+$/;
      const eng = /^[a-zA-Z]+$/;

      const v = name => (document.querySelector(`input[name="${name}"]`)?.value || '').trim();

      const l = v('empLName'), n = v('empName');
      const el = v('empEngLName'), en = v('empEngName');

      isKoreanLNameValid = !l || kor.test(l);
      isKoreanNameValid  = !n || kor.test(n);
      isEnglishLNameValid = !el || eng.test(el);
      isEnglishNameValid  = !en || eng.test(en);

      // 에러 DOM 토글
      document.getElementById('empLName-kor-err').style.display = (l && !isKoreanLNameValid) ? 'block':'none';
      document.getElementById('empName-kor-err').style.display  = (n && !isKoreanNameValid)  ? 'block':'none';
      document.getElementById('empEngLName-eng-err').style.display = (el && !isEnglishLNameValid) ? 'block':'none';
      document.getElementById('empEngName-eng-err').style.display  = (en && !isEnglishNameValid)  ? 'block':'none';
    }

    function bindValidationHandlers() {
      // 이름류
      ['empLName','empName','empEngLName','empEngName'].forEach(n=>{
        const el = document.querySelector(`input[name="${n}"]`);
        if (el) el.addEventListener('input', ()=>{ validateNamesPerField(); updateSubmitState(); });
      });

      // 기타 필수
      ['birthday','address'].forEach(n=>{
        const el = document.querySelector(`input[name="${n}"]`);
        if (el) el.addEventListener('input', updateSubmitState);
      });

      // 전화번호: 패턴 + 중복체크 디바운스
      const phoneEl = document.querySelector('input[name="phone"]');
      if (phoneEl) {
        let t = null;
        phoneEl.addEventListener('input', ()=>{
          updateSubmitState();
          clearTimeout(t);
          t = setTimeout(checkPhoneDuplicate, 350);
        });
      }
    }

    function checkPhoneDuplicate() {
      const phone = (document.querySelector('input[name="phone"]').value || '').trim();
      if (!PHONE_PATTERN.test(phone)) { isPhoneUnique = true; updateSubmitState(); return; }

      fetch(`${PHONE_CHECK_URL}?phone=${encodeURIComponent(phone)}`)
        .then(r=>r.json())
        .then(data => { isPhoneUnique = !data.exists; updateSubmitState(); })
        .catch(()=>{ isPhoneUnique = true; updateSubmitState(); });
    }

    function submitProfileEditRequest() {
      updateSubmitState();
      if (document.getElementById('submitBtn').disabled) {
        alertify.alert('알림','필수 항목을 모두 채우고, 오류를 해결해 주세요.');
        return;
      }

      const now = getFormValues();
      const changed = [];
      Object.keys(initialFormState).forEach(k=>{
        if (k !== 'atchFile' && initialFormState[k] !== now[k]) {
          changed.push({ name:k, from:initialFormState[k], to:now[k] });
        }
      });
      const fileChanged = !!document.querySelector('input[name="atchFile"]').files.length;

      if (changed.length === 0 && !fileChanged) {
        alertify.alert('알림','변경 사항이 없습니다.', ()=>{ location.href='/myPage/profile'; });
        return;
      }

      let msg = '변경 내용을 전송하시겠습니까?<br><br>';
      changed.forEach(f=>{
        const label = fieldLabels[f.name] || f.name;
        msg += `${label}: ${f.from} => ${f.to}<br>`;
      });
      if (fileChanged) msg += '프로필 사진: 변경됨<br>';

      alertify.confirm('변경 내용 확인', msg,
        ()=> document.getElementById('editReqForm').submit(),
        ()=> alertify.error('요청이 취소되었습니다.')
      );
    }

    function previewProfilePic(e){
      const file = e.target.files[0];
      const img = document.getElementById('profile-preview');
      if (!file){ return; }
      const reader = new FileReader();
      reader.onload = ()=> img.src = reader.result;
      reader.readAsDataURL(file);
    }
</script>
</body>
</html>
