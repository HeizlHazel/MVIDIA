<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:fragment="menubar">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        .sb {
            width:250px;
            min-height:100vh;
            background:linear-gradient(to bottom,#002B39,#003661,#186AEA);
            padding-top:60px;
            position:fixed;
            left:0;
            top:0;
            z-index:999
        }

        .menu {
            list-style:none;
            margin:0;
            padding:0
        }

        .menu>li {position:relative}

        .link {
            display:flex;
            align-items:center;
            gap:10px;
            padding:12px;
            border-radius:12px;
            color:#e7f2f7;
            cursor:pointer
        }

        .link:hover {background:#013547}

        .submenu {
            display:none;
            margin:6px 0 10px 8px;
            border-left:2px solid rgba(255,255,255,.1);
            padding-left:8px
        }

        .submenu a {
            display:block;
            padding:8px 10px;
            border-radius:10px;
            color:#e7f2f7;
            text-decoration:none
        }

        .submenu a:hover {background:rgba(255,255,255,.08)}

        /* ì—´ë¦° ìƒíƒœì˜ ì„œë¸Œë©”ë‰´ í‘œì‹œ */
        .menu>li.open>.submenu {
            display:block;
            animation: slideDown 0.3s ease;
        }

        /* í™œì„± ë©”ë‰´ ê°•ì¡° */
        .menu a.active,
        .menu .link.active,
        .menu .submenu a.active {
            background: rgba(255,255,255,0.25) !important;
            color: #fff !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div th:fragment="menubar" class="sb">
        <ul class="menu" id="sideMenu">
            <li>
                <a class="link" th:href="@{/}">ğŸ  HOME</a>
            </li>

            <li>
                <div class="link" data-toggle>ğŸ‘¤ ë§ˆì´í˜ì´ì§€</div>
                <div class="submenu">
                    <a th:href="@{/mypage/profile}">ê°œì¸ì •ë³´ ì¡°íšŒ</a>
                    <a th:href="@{/mypage/update}">ê°œì¸ì •ë³´ ìˆ˜ì • ìš”ì²­</a>
                </div>
            </li>

            <li>
                <div class="link" data-toggle>ğŸ•’ ê·¼íƒœê´€ë¦¬</div>
                <div class="submenu">
                    <a th:href="@{/attend/main}">ê·¼íƒœ ë©”ì¸</a>
                    <a th:href="@{/attend/vacation}">íœ´ê°€ ì‹ ì²­</a>
                </div>
            </li>

            <li>
                <a class="link" th:href="@{/approval}">ğŸ“ ì „ìê²°ì¬</a>
            </li>

            <li>
                <div class="link" data-toggle>âœ‰ï¸ ìª½ì§€</div>
                <div class="submenu">
                    <a th:href="@{/message/inbox}">ìˆ˜ì‹ í•¨</a>
                    <a th:href="@{/message/outbox}">ë°œì‹ í•¨</a>
                    <a th:href="@{/message/compose}">ìª½ì§€ ë³´ë‚´ê¸°</a>
                </div>
            </li>

            <li>
                <div class="link" data-toggle>ğŸ§­ ì¸ì‚¬ê´€ë¦¬</div>
                <div class="submenu">
                    <a th:href="@{/hr/main}">ì¸ì‚¬ê´€ë¦¬ ë©”ì¸</a>
                    <a th:href="@{/hr/accounts}">ì‚¬ì› ê³„ì • ìƒì„±/ìˆ˜ì •/ì‚­ì œ</a>
                    <a th:href="@{/hr/integrated}">ì¸ì‚¬ í†µí•© ê´€ë¦¬</a>
                    <a th:href="@{/hr/attendance}">ê·¼íƒœ/íœ´ê°€ í†µí•©</a>
                    <a th:href="@{/hr/cert}">ì¦ëª…ì„œ ì¡°íšŒ/ë°œê¸‰</a>
                </div>
            </li>

            <!-- ì§ì±…ë³„ ë…¸ì¶œ ì˜ˆì‹œ: ë¶€ì¥ ì´ìƒì¼ ë•Œë§Œ ì¡°ì§ë„ -->
            <li sec:authorize="hasAnyRole('MANAGER','ADMIN')">
                <a class="link" th:href="@{/org}">ğŸ§© ì¡°ì§ë„</a>
            </li>

            <!-- ê¸°ìˆ ì§€ì›íŒ€ ì†Œì†ì¸ ê²½ìš° ë…¸ì¶œë˜ëŠ” ë©”ë‰´ -->
            <li>
                <div class="link" data-toggle>âš™ ì‹œìŠ¤í…œ ê´€ë¦¬</div>
                <div class="submenu">
                    <a th:href="@{/admin}">ì‹œìŠ¤í…œ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</a>
                    <a th:href="@{/permission}">ê³„ì • ê¶Œí•œ ê´€ë¦¬</a>
                    <a th:href="@{/unlock}">ì‚¬ìš©ì ê³„ì • ì ê¸ˆ í•´ì œ</a>
                    <a th:href="@{/dept}">ë¶€ì„œ ìƒì„±/ìˆ˜ì •/ì‚­ì œ</a>
                    <a th:href="@{/ui}">ERP UI ì„¤ì •</a>
                </div>
            </li>
        </ul>
    </div>


    <script th:inline="javascript">
        (function () {
          const menu = document.getElementById('sideMenu');
          if (!menu) return;

          // í˜„ì¬ URL ê¸°ë°˜ìœ¼ë¡œ í™œì„± ë©”ë‰´ ì„¤ì • ë° ì„œë¸Œë©”ë‰´ ìë™ ì—´ê¸°
          function setActiveMenu() {
            const currentPath = window.location.pathname;
            console.log('í˜„ì¬ ê²½ë¡œ:', currentPath);

            // ëª¨ë“  active í´ë˜ìŠ¤ ë° open ìƒíƒœ ì œê±° (í™œì„± ë©”ë‰´ ì œì™¸)
            menu.querySelectorAll('.active, .has-active-child').forEach(el => {
              el.classList.remove('active', 'has-active-child');
            });

            // ë¨¼ì € ëª¨ë“  ë©”ë‰´ë¥¼ ë‹«ìŒ
            menu.querySelectorAll('li.open').forEach(li => {
              li.classList.remove('open');
              const toggle = li.querySelector(':scope > .link[data-toggle]');
              if (toggle) {
                toggle.setAttribute('aria-expanded', 'false');
              }
            });

            // ëª¨ë“  ë§í¬ ê²€ì‚¬
            const allLinks = menu.querySelectorAll('a[href]');
            let foundActive = false;

            allLinks.forEach(link => {
              const href = link.getAttribute('href');
              if (!href) return;

              // Thymeleafê°€ ë Œë”ë§í•œ ì‹¤ì œ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
              // th:hrefëŠ” ë Œë”ë§ í›„ href ì†ì„±ì´ ë¨
              const linkPath = href;

              // ë””ë²„ê¹…: ëª¨ë“  ë§í¬ ê²½ë¡œ ì¶œë ¥
              console.log('ë§í¬ ê²½ë¡œ:', linkPath, 'í…ìŠ¤íŠ¸:', link.textContent.trim());

              // ê²½ë¡œ ë¹„êµ (ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œì™¸)
              const currentPathWithoutQuery = currentPath.split('?')[0];
              const linkPathWithoutQuery = linkPath.split('?')[0];

              // ì •í™•í•œ ê²½ë¡œ ë§¤ì¹­ ë˜ëŠ” í˜„ì¬ ê²½ë¡œê°€ ë§í¬ ê²½ë¡œë¡œ ì‹œì‘í•˜ëŠ” ê²½ìš°
              if (currentPathWithoutQuery === linkPathWithoutQuery ||
                  (linkPathWithoutQuery !== '/' && currentPathWithoutQuery.startsWith(linkPathWithoutQuery))) {

                // ë§í¬ì— active í´ë˜ìŠ¤ ì¶”ê°€
                link.classList.add('active');
                foundActive = true;

                // ì„œë¸Œë©”ë‰´ í•­ëª©ì¸ ê²½ìš° ë¶€ëª¨ ë©”ë‰´ ì²˜ë¦¬
                const submenu = link.closest('.submenu');
                if (submenu) {
                  const parentLi = submenu.closest('li');
                  if (parentLi) {
                    // ë¶€ëª¨ ë©”ë‰´ë¥¼ ì—´ë¦° ìƒíƒœë¡œ ìœ ì§€
                    parentLi.classList.add('has-active-child', 'open');

                    const parentToggle = parentLi.querySelector(':scope > .link[data-toggle]');
                    if (parentToggle) {
                      parentToggle.setAttribute('aria-expanded', 'true');
                    }

                    console.log('í™œì„± ì„œë¸Œë©”ë‰´ì˜ ë¶€ëª¨ ë©”ë‰´ ì—´ê¸°:', parentToggle?.textContent.trim());
                  }
                }

                console.log('í™œì„± ë©”ë‰´ ì„¤ì •:', link.textContent.trim(), 'Path:', linkPath);
              }
            });

            // í™œì„± ë©”ë‰´ë¥¼ ì°¾ì§€ ëª»í•œ ê²½ìš° ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
            if (!foundActive) {
              // URL ì„¸ê·¸ë¨¼íŠ¸ë¡œ ë¶€ë¶„ ë§¤ì¹­
              const pathSegments = currentPath.split('/').filter(s => s);
              if (pathSegments.length > 0) {
                const primarySegment = '/' + pathSegments[0];

                allLinks.forEach(link => {
                  const href = link.getAttribute('href');
                  if (href && href.startsWith(primarySegment)) {
                    const submenu = link.closest('.submenu');
                    if (submenu) {
                      const parentLi = submenu.closest('li');
                      if (parentLi && !parentLi.classList.contains('open')) {
                        parentLi.classList.add('open');
                        const parentToggle = parentLi.querySelector(':scope > .link[data-toggle]');
                        if (parentToggle) {
                          parentToggle.setAttribute('aria-expanded', 'true');
                        }
                      }
                    }
                  }
                });
              }
            }
          }

          // ì•„ì½”ë””ì–¸ ê¸°ëŠ¥
          menu.addEventListener('click', (e) => {
            const btn = e.target.closest('.link[data-toggle]');
            if (!btn || !menu.contains(btn)) return;

            e.preventDefault();
            const li = btn.closest('li');
            const isOpen = li.classList.contains('open');

            // ë‹¤ë¥¸ ëª¨ë“  ë©”ë‰´ ë‹«ê¸° (í™œì„± ì„œë¸Œë©”ë‰´ê°€ ìˆì–´ë„ ë‹«ìŒ)
            menu.querySelectorAll(':scope > li.open').forEach((other) => {
              if (other !== li) {
                other.classList.remove('open');
                const hdr = other.querySelector(':scope > .link[data-toggle]');
                if (hdr) hdr.setAttribute('aria-expanded', 'false');
              }
            });

            // í˜„ì¬ í´ë¦­í•œ ë©”ë‰´ í† ê¸€
            li.classList.toggle('open', !isOpen);
            btn.setAttribute('aria-expanded', String(!isOpen));
          });

          // ì ‘ê·¼ì„± ì„¤ì •
          menu.querySelectorAll('.link[data-toggle]').forEach((hdr) => {
            hdr.setAttribute('aria-expanded', 'false');
            hdr.setAttribute('role', 'button');
            hdr.setAttribute('tabindex', '0');
          });

          // í‚¤ë³´ë“œ ì ‘ê·¼ì„±
          menu.addEventListener('keydown', (e) => {
            const isActivator = e.target.matches('.link[data-toggle]');
            if (!isActivator) return;
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              e.target.click();
            }
          });

          // í˜ì´ì§€ ë¡œë“œ ì‹œ í™œì„± ë©”ë‰´ ì„¤ì •
          setActiveMenu();

          // ë¸Œë¼ìš°ì € ë’¤ë¡œê°€ê¸°/ì•ìœ¼ë¡œê°€ê¸° ì‹œì—ë„ í™œì„± ë©”ë‰´ ì—…ë°ì´íŠ¸
          window.addEventListener('popstate', setActiveMenu);

          // Thymeleaf í˜ì´ì§€ ì „í™˜ í›„ì—ë„ ë™ì‘í•˜ë„ë¡
          document.addEventListener('DOMContentLoaded', setActiveMenu);
        })();
    </script>
</body>
</html>