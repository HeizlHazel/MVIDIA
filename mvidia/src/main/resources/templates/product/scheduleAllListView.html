<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>scheduleAllListView</title>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
</head>
<body>
<h1>ğŸ“‹ ì „ì²´ ì¼ì •</h1>
<a th:href="@{/clist.bo}">ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ê°€ê¸°</a>

<div class="chart-section">
    <h3>ëˆ„ì  ì§„í–‰ í˜„í™©</h3>
    <canvas id="statusChart"></canvas>
</div>

<!-- ë„ë„› ì°¨íŠ¸: ë¶ˆëŸ‰ ìœ í˜•ë³„ í•©ê³„ -->
<div class="chart-container">
    <canvas id="defectDonut"></canvas>
</div>

<!-- ëˆ„ì  ë§‰ëŒ€(ìƒíƒœë³„) script -->

<script th:inline="javascript">
    const schrList = /*[[${schrList}]]*/ [];
    const schrDefData = {
        labels: schrList.map(d => d.defType),
        datasets: [{
            label: 'ë¶ˆëŸ‰ìˆ˜',
            data: schrList.map(d => d.defCountType),
            backgroundColor: ['#FF6384', '#FF6384', '#FF6384', '#FF6384', '#FF6384']
        }]
    };

    const partnerName = /*[[${schrTop5[0].bpPartner}]]*/ 'ì—…ì²´ëª…ì—†ìŒ';
    const statusBar = document.getElementById('statusChart').getContext('2d');
    const statusChart = new Chart(statusBar, {
        type: 'bar',
        data: {
            labels: schrList.map(d => d.schName),
            datasets: [
                { label: 'ì™„ë£Œ(C)', data: schrList.map(d => d.doneCount), backgroundColor:'rgba(75,192,192,0.8)'},
                { label: 'ì§„í–‰ì¤‘(P)', data: schrList.map(d => d.ingCount), backgroundColor:'rgba(54,162,235,0.8)'},
                { label: 'ì§€ì—°(S)', data: schrList.map(d => d.delayCount), backgroundColor:'rgba(255,206,86,0.8)'},
                { label: 'ì˜ˆì •(W)', data: schrList.map(d => d.waitCount), backgroundColor:'rgba(201,203,207,0.8)'}
            ]
        },
        options: {
            indexAxis: 'y',
            responsive:true,
            plugins:{
                title:{ display:true, text: partnerName + ' ëˆ„ì  ê²€ì‚¬ í˜„í™©'},
                legend:{
                    position:'bottom',
                    labels:{
                        usePointStyle:true,
                        pointStyle:'circle',
                        boxWidth:8,
                        boxHeight:8,
                        padding:10,
                        textAlign:'center',
                        font:{size:11}
                    }
                },
                datalabels:{
                    color:'black',
                    anchor:'center',
                    align:'center',
                    offset:2,
                    formatter:(value, context)=>{
                        const idx = context.dataIndex;
                        const total = schrList[idx].totalCount;
                        const done = schrList[idx].doneCount;
                        const progRate = total>0?Math.round(done*100/total):0;
                        return progRate+'%';
                    }
                }
            },
            scales:{ x:{ stacked:true }, y:{ stacked:true, beginAtZero:true, ticks:{precision:0}}}
        },
        plugins:[ChartDataLabels]
    });
</script>

<!-- ë¶ˆëŸ‰ë¥  ë„ë„› ì°¨íŠ¸ script -->
<script>
    const schrDonutList = /*[[${schrDonutList}]]*/ [];
    const defData = {
      labels: schrDonutList.map(d => d.defType),
      datasets: [{
        data: schrDonutList.map(d => d.defCountType),
        backgroundColor: ['#FF6384', '#FF6384', '#FF6384', '#FF6384', '#FF6384'],
        hoverOffset: 4
      }]
    };

    const defCtx = document.getElementById('defDonut').getContext('2d');
    const defDonut = new Chart(defCtx, {
        type: 'doughnut',
        data: defData,
        options: {
            responsive: true,
            cutout: '60%',
            plugins: {
                legend: { position: 'bottom' },
                tooltip: { enabled: true }
            }
        }
    });

    const totalDef = schrDonutList.reduce((sum, d) => sum + d.defCountType, 0);
    const totalCheck = schrDonutList.reduce((sum, d) => sum + d.totalCount, 0);
    const defRate = totalCheck > 0 ? Math.round(totalDef * 100 / totalCheck) : 0;
    document.getElementById('donutLabel').innerText = defRate + '%';
</script>


<!--------------------------------------------------------------------------------------------------------------------->
<!-- ì¼ì • ì„ íƒ ë° ìƒíƒœ ì…ë ¥ -->
<!-- ë²„íŠ¼ -->
<button id="openModalBtn" class="submit-btn">ì„ì‹œ ì…ë ¥</button>
<!-- ëª¨ë‹¬ -->
<div id="inputModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>

        <h3>ì¼ì • ì„ íƒ ë° ìƒíƒœ ì…ë ¥</h3>
        <label for="schrSelect"><b>í’ˆì§ˆ ì ê²€ ì¼ì • ì„ íƒ:</b></label>
        <select id="schrSelect">
            <option value="">--------------------------- ì¼ì • ì„ íƒ ----------------------------</option>
            <option th:each="s: ${schrList}"
                    th:value="${s.schrId}"
                    th:data-total="${s.totalCount}"
                    th:data-def="${s.defCount}"
                    th:text="${s.schNo} + ' : (' + s.itemCode + ')'"></option>
        </select>

        <table>
            <tr>
                <th>ì „ì²´</th><th>ë¶ˆëŸ‰</th>
            </tr>
            <tr>
                <td id="totalCount">-</td>
                <td id="defCount">-</td>
            </tr>
        </table>

        <table>
            <tr>
                <th style="background-color: rgba(75,192,192,0.8)">ì™„ë£Œ(C)</th>
                <th style="background-color: rgba(54,162,235,0.8)">ì§„í–‰ì¤‘(P)</th><br>
                <th style="background-color: rgba(255,206,86,0.8)">ì§€ì—°(S)</th>
                <th style="background-color: rgba(201,203,207,0.8)">ëŒ€ê¸°(W)</th>
            </tr>
            <tr>
                <td><input type="number" id="doneInput" value="0" min="0"></td>
                <td><input type="number" id="ingInput" value="0" min="0"></td>
                <td><input type="number" id="delayInput" value="0" min="0"></td>
                <td><input type="number" id="waitInput" value="0" min="0"></td>
            </tr>
        </table>

        <button class="submit-btn" id="updateBtn">ê°’ ë„£ê¸°</button>
    </div>
</div>

<script>
    const modal = document.getElementById("inputModal");
    const openBtn = document.getElementById("openModalBtn");
    const closeBtn = document.querySelector(".close");

    openBtn.onclick = () => modal.style.display = "block";
    closeBtn.onclick = () => modal.style.display = "none";
    window.onclick = (e) => {
      if (e.target === modal) modal.style.display = "none";
    };

    //ì¼ì • ì„ íƒì‹œ total / def í‘œì‹œí•˜ëŠ” ì½”ë“œ
    document.getElementById('schrSelect').addEventListener('change', function(){
        const selected = this.selectedOptions[0];
        if(selected && selected.value){
            document.getElementById('totalCount').innerText = selected.dataset.total;
            document.getElementById('defCount').innerText = selected.dataset.def;
            // ê¸°ë³¸ ì…ë ¥ê°’ ì´ˆê¸°í™”
            document.getElementById('doneInput').value = 0;
            document.getElementById('ingInput').value = 0;
            document.getElementById('delayInput').value = 0;
            document.getElementById('waitInput').value = 0;
        }else{
            document.getElementById('totalCount').innerText = '-';
            document.getElementById('defCount').innerText = '-';
        }
    });

    // ê°’ ë„£ê¸° ë²„íŠ¼
    document.getElementById('updateBtn').addEventListener('click', ()=>{
        const schrId = document.getElementById('schrSelect').value;
        if(!schrId) return alert("ì¼ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

        const done = parseInt(document.getElementById('doneInput').value)||0;
        const ing = parseInt(document.getElementById('ingInput').value)||0;
        const delay = parseInt(document.getElementById('delayInput').value)||0;
        const wait = parseInt(document.getElementById('waitInput').value)||0;

        // ì„ íƒí•œ ì¼ì • ë°ì´í„° ì—…ë°ì´íŠ¸
        const idx = schrList.findIndex(d=>d.schrId===schrId);
        if(idx>=0){
        schrList[idx].doneCount = done;
        schrList[idx].ingCount = ing;
        schrList[idx].delayCount = delay;
        schrList[idx].waitCount = wait;
        } else {
        schrList.push({ schr_id: schrId, doneCount: done, ingCount: ing, delayCount: delay, waitCount: wait, totalCount: parseInt(document.getElementById('totalCount').innerText) });
        }

        // ì°¨íŠ¸ ë°ì´í„° ê°±ì‹ 
        statusChart.data.datasets[0].data = schrList.map(d=>d.doneCount);
        statusChart.data.datasets[1].data = schrList.map(d=>d.ingCount);
        statusChart.data.datasets[2].data = schrList.map(d=>d.delayCount);
        statusChart.data.datasets[3].data = schrList.map(d=>d.waitCount);
        statusChart.update();
    });
</script>
</body>
</html>