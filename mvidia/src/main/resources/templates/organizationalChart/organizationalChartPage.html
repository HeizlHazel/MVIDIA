<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA Â· ERP - ì¡°ì§ë„</title>
    <style>
        .organizationalChart{ grid-column: 2; grid-row: 2; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);  width: 1200px; margin: 0 auto; }
        .organizationalChart > .widget { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.1); }
        #deptSelect { padding:10px 12px; border-radius:12px; border:1px solid #dde6ec; }
        .stack { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        .mt8 { margin-top:8px; }
        .mt16 { margin-top:16px; display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:12px; }
        .muted { color: var(--muted); }
        .job-group { grid-column:1 / -1; margin-top:10px; }
        .job-group h3 { margin:0; padding-bottom:6px; border-bottom:2px solid #e9eef3; font-size:15px; color:#334e5a; }
        .job-group .card-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:12px; margin-top:12px; }

        /* ì¹´ë“œ */
        .emp-card { width:300px; position: relative; border-radius: 12px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,.06); border: 1px solid #e7eef3; padding: 12px; cursor: pointer; outline: none;}
        .emp-card:focus { box-shadow: 0 0 0 3px rgba(0,123,255,.25); }
        .emp-head { display:flex; gap:12px; align-items:center; }
        .emp-avatar { width:54px; height:54px; border-radius:50%; object-fit:cover; background:#e1e9ee; }
        .emp-meta { display:flex; flex-direction:column; min-width:0; }
        .emp-meta b { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .emp-meta .line { color:#698492; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .emp-meta .small { color:#9aaebe; font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .card-actions {display: none; margin-top: 10px; border-top: 1px dashed #e7eef3; padding-top: 8px; gap: 8px;}
        .card-actions.active { display:flex; flex-wrap:wrap; }
        .card-action {display:inline-flex; align-items:center; justify-content:center; padding:8px 12px; border-radius:10px; border:1px solid #dde6ec; background:#f8fbfd; color:#0d3d4c; text-decoration:none; font-size:13px; transition: transform .08s ease, background .15s ease, border-color .15s ease;}
        .card-action:hover { background:#eef6fb; border-color:#cfe2ee; transform: translateY(-1px); }
        .card-action:active { transform: translateY(0); }
        .card-action .dot { width:6px; height:6px; border-radius:50%; background:#9ac2d3; margin-right:8px; }
        .chief-badge {position:absolute; top:8px; right:8px; background:#002B39; color:#fff; font-size:11px; padding:4px 8px; border-radius:999px; box-shadow: 0 2px 6px rgba(0,0,0,.12);}
        @media (hover:none) {.emp-card { cursor: default; } }
        .hr-integrated {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 1250px;
            margin: 0 auto;
        }
    </style>
</head>
<body>

<div class="hr-integrated">
    <div class="widget" id="home">
        <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ ì¡°ì§ë„</h3>
        <br>
        <div class="stack mt8">
            <select id="deptSelect" aria-label="ë¶€ì„œ ì„ íƒ">
                <option value="ALL">ì „ì²´ ë¶€ì„œ</option>
            </select>
            <span id="allDeptMessage" class="muted">* ê° ë¶€ì„œë³„ <b>ë¶€ì¥ 1ëª…</b>ì”©ë§Œ í‘œì‹œë©ë‹ˆë‹¤. ì¹´ë“œë¥¼ í´ë¦­í•˜ë©´ ì•¡ì…˜ì´ í¼ì³ì§‘ë‹ˆë‹¤.</span>
        </div>
        <div id="integratedList" class="mt16" aria-live="polite"></div>
    </div>
</div>

<script>
    // === í”„ë¡œì íŠ¸ ë¼ìš°íŒ…ì— ë§ê²Œ ì¡°ì •í•˜ì„¸ìš” ===
    const NOTE_COMPOSE_URL = '/message/compose?toEmpNo=';     // ìª½ì§€
    const INFO_URL         = '/hr/accountDetail.hr?empNo='; // ì •ë³´ë³´ê¸°(ê¸°ì¡´)

    $(document).ready(function() {
      fetchDepartments();
      refreshIntegrated(); // ì´ˆê¸° ë Œë”ë§
    });

    // ë¶€ì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    function fetchDepartments() {
      $.ajax({
        url: '/hr/departments',
        type: 'GET',
        success: function(response) {
          const deptSelect = $('#deptSelect');
          response.forEach(dept => {
            deptSelect.append(`<option value="${escapeHtml(dept.deptName)}">${escapeHtml(dept.deptName)}</option>`);
          });
        },
        error: function(xhr) {
          console.error("ë¶€ì„œ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: ", xhr.responseText);
          alertify.error('ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    // ì„ íƒëœ ë¶€ì„œì— ë”°ë¥¸ êµ¬ì„±ì› ë Œë”ë§
    function refreshIntegrated() {
      const currentDept = $('#deptSelect').val();
      $('#allDeptMessage').toggle(currentDept === 'ALL');

      const url = currentDept === 'ALL' ? '/hr/integrated/all' : `/hr/integrated/dept/${encodeURIComponent(currentDept)}`;

      $.ajax({
        url,
        type: 'GET',
        success: function(employees) {
          const area = $('#integratedList');
          area.empty();

          const positionOrder = ['ë¶€ì¥', 'ì°¨ì¥', 'ê³¼ì¥', 'ëŒ€ë¦¬', 'ì‚¬ì›'];

          if (currentDept === 'ALL') {
            // ê° ë¶€ì„œë³„ ë¶€ì¥ë§Œ (ì„œë²„ì—ì„œ ì´ë¯¸ í•„í„°í•œ ë°ì´í„°ë¼ê³  ê°€ì •)
            employees
              .sort((a, b) => a.deptName.localeCompare(b.deptName) || a.empName.localeCompare(b.empName))
              .forEach(emp => area.append(createEmployeeCard(emp, {showChief:true})));
          } else {
            // ì§ê¸‰ ê·¸ë£¹ ë Œë”ë§
            const byPos = employees.reduce((acc, emp) => {
              (acc[emp.jobName] = acc[emp.jobName] || []).push(emp);
              return acc;
            }, {});
            positionOrder.forEach(job => {
              if (byPos[job]) area.append(createEmployeeGroup(job, byPos[job]));
            });
          }
        },
        error: function(xhr) {
          console.error("ì¸ì‚¬ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨: ", xhr.responseText);
          alertify.error('ì¸ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      });
    }

    // ì¹´ë“œ ìƒì„±
    function createEmployeeCard(emp, options = {}) {
      const defaultProfile = '/images/default_profile.png';
      const profileImg = emp.changeName ? `/uploadFiles/${encodeURIComponent(emp.changeName)}` : defaultProfile;

      const empNo   = escapeHtml(emp.empNo ?? '');
      const empName = escapeHtml(emp.empName ?? '');
      const dept    = escapeHtml(emp.deptName ?? '');
      const job     = escapeHtml(emp.jobName ?? '');
      const email   = escapeHtml(emp.email ?? '');

      const showChiefBadge = options.showChief && job === 'ë¶€ì¥';

      return `
        <div class="emp-card" role="button" tabindex="0"
             data-emp-no="${empNo}" data-emp-name="${empName}">
          ${showChiefBadge ? `<span class="chief-badge">ë¶€ì„œì¥</span>` : ``}
          <div class="emp-head">
            <img class="emp-avatar" src="${profileImg}" alt="${empName} í”„ë¡œí•„"/>
            <div class="emp-meta">
              <b>${empName} <span class="muted">(${empNo})</span></b>
              <span class="line">${dept} Â· ${job}</span>
              <span class="small">${email}</span>
            </div>
          </div>
          <div class="card-actions" aria-hidden="true">
            <a class="card-action action-info" href="${INFO_URL + encodeURIComponent(empNo)}" title="ì •ë³´ë³´ê¸°">
              <span class="dot"></span>ì •ë³´ë³´ê¸°
            </a>
            <a class="card-action action-note" href="${NOTE_COMPOSE_URL + encodeURIComponent(empNo)}" title="ìª½ì§€ ë³´ë‚´ê¸°">
              <span class="dot"></span>ìª½ì§€ ë³´ë‚´ê¸°
            </a>
          </div>
        </div>
      `;
    }

    // ì§ê¸‰ ê·¸ë£¹ ìƒì„±
    function createEmployeeGroup(jobName, employees) {
      let html = `<div class="job-group">
                    <h3>${escapeHtml(jobName)}</h3>
                    <div class="card-grid">`;
      employees
        .sort((a,b) => a.empName.localeCompare(b.empName))
        .forEach(emp => html += createEmployeeCard(emp));
      html += `</div></div>`;
      return html;
    }

    // ë¶€ì„œ ë³€ê²½ ì´ë²¤íŠ¸
    $('#deptSelect').on('change', refreshIntegrated);

    // ==== ì•¡ì…˜ í† ê¸€ & ì ‘ê·¼ì„± ====
    // í•˜ë‚˜ë§Œ ì—´ë¦¬ë„ë¡ ê´€ë¦¬
    function closeAllActions() {
      $('.card-actions').removeClass('active').attr('aria-hidden', 'true');
    }

    // ì¹´ë“œ í´ë¦­ ì‹œ ì•¡ì…˜ í† ê¸€ (ìœ„ì„)
    $(document).on('click', '.emp-card', function(e) {
      // ë§í¬ í´ë¦­ì€ í† ê¸€í•˜ì§€ ì•ŠìŒ
      if ($(e.target).closest('.card-action').length) return;

      const $actions = $(this).find('.card-actions');
      const active = $actions.hasClass('active');
      closeAllActions();
      if (!active) {
        $actions.addClass('active').attr('aria-hidden', 'false');
      }
    });

    // Enterë¡œ ì—´ê¸°/ë‹«ê¸°
    $(document).on('keydown', '.emp-card', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        $(this).trigger('click');
      } else if (e.key === 'Escape') {
        closeAllActions();
      }
    });

    // ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸°
    $(document).on('click', function(e) {
      if ($(e.target).closest('.emp-card').length === 0) closeAllActions();
    });

    // ì•¡ì…˜ í´ë¦­ ì‹œ ê°„ë‹¨ í† ìŠ¤íŠ¸ (ì›í•˜ë©´ ì œê±°í•˜ì„¸ìš”)
    $(document).on('click', '.card-action', function(e) {
      const $card = $(this).closest('.emp-card');
      const empName = $card.data('emp-name') || 'ì‚¬ì›';
      if ($(this).hasClass('action-note')) {
        alertify.message(`${empName} ë‹˜ì—ê²Œ ìª½ì§€ ì‘ì„±ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
      } else if ($(this).hasClass('action-chat')) {
        alertify.message(`${empName} ë‹˜ê³¼ ë©”ì‹ ì € ëŒ€í™”ë¡œ ì´ë™í•©ë‹ˆë‹¤.`);
      } else if ($(this).hasClass('action-info')) {
        // ì •ë³´ë³´ê¸°ëŠ” êµ³ì´ í† ìŠ¤íŠ¸ ì•ˆ ë„ì›Œë„ ë©ë‹ˆë‹¤.
      }
      // ë§í¬ ìì²´ë¡œ ì´ë™í•˜ë¯€ë¡œ e.preventDefault() í•˜ì§€ ì•ŠìŒ.
    });

    // XSS-safe í…ìŠ¤íŠ¸ ì¶œë ¥
    function escapeHtml(str) {
      return String(str ?? '')
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }
</script>
</body>
</html>
