<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ“… ìº˜ë¦°ë” ì¼ì • ì¡°íšŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {font-family: 'Inter', sans-serif; background-color: #f7fafc;}
        .container {max-width: 900px; margin: 2rem auto; padding: 2rem; background-color: #fff; border-radius: 1rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);}
        .controls-row {display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 1rem;}
        #calendar-container {border: 1px solid #e2e8f0; border-radius: 0.5rem; padding: 1rem;}
        .calendar-header {display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; text-align: center; font-weight: 600; }
        .calendar-grid {display: grid;  grid-template-columns: repeat(7, 1fr); gap: 2px;  text-align: center;}
        .day-header {padding: 0.5rem; font-weight: 700; color: #4a5568;}
        .day {min-height: 100px; padding: 0.5rem; background-color: #f7fafc; border-radius: 0.25rem; position: relative;}
        .day-number {font-weight: 600; color: #2d3748; margin-bottom: 0.5rem;}
        .event {font-size: 0.75rem; padding: 2px 4px; border-radius: 0.25rem; background: #edf2f7; color: #111827; margin-bottom: 2px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        .event.vacation { background-color: #ef4444; }
        .event.special-duty { background-color: #3b82f6; }
        .event.anniversary { background-color: #22c55e; }
        .event.holiday { background-color: #f59e0b; }
        .event-list-container {  margin-top: 1rem; border-top: 1px solid #e2e8f0; padding-top: 1rem;}
        .event-list-title { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5rem;}
        .event-list {list-style: none; padding: 0; margin: 0;}
        .event-item {display: flex; align-items: center; margin-bottom: 0.5rem;}
        .event-item .color-box {width: 12px; height: 12px; border-radius: 2px; margin-right: 0.5rem;}
        #loading-message {display: none; color: #6b7280; margin-top: 1rem; text-align: center;}
        .day.is-today {outline: 2px solid #3b82f6; background: rgba(59,130,246,.08);}
    </style>
</head>
<body class="bg-gray-100">

<div class="container">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“… ìº˜ë¦°ë” ì¼ì • ì¡°íšŒ</h2>
    <div class="controls-row">
        <div class="flex items-center space-x-2">
            <label for="month-picker" class="text-gray-700 font-medium">ì›” ì„ íƒ</label>
            <input type="month" id="month-picker" class="border border-gray-300 rounded-md p-2 text-sm" />
            <button type="button" id="reset-month-btn"
                    class="px-3 py-2 text-sm border border-gray-300 rounded-md hover:bg-gray-100">
                ì´ˆê¸°í™”
            </button>
        </div>
        <div class="flex items-center space-x-2">
            <span class="text-xs text-gray-500">íœ´ê°€/íŠ¹ê·¼/ì°½ë¦½ê¸°ë…/ê³µíœ´ì¼ í‘œì‹œ</span>
            <span class="w-3 h-3 rounded-sm bg-red-500"></span>
            <span class="w-3 h-3 rounded-sm bg-blue-500"></span>
            <span class="w-3 h-3 rounded-sm bg-green-500"></span>
            <span class="w-3 h-3 rounded-sm bg-amber-500"></span>
        </div>
    </div>

    <div id="loading-message">
        <svg class="animate-spin h-5 w-5 text-gray-500 inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        ìº˜ë¦°ë” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>

    <div id="calendar-container">
        <!-- Calendar will be rendered here by JavaScript -->
    </div>
</div>

<script>
    const calendarContainer = document.getElementById('calendar-container');
    const monthPicker = document.getElementById('month-picker');
    const loadingMessage = document.getElementById('loading-message');
    const resetBtn = document.getElementById('reset-month-btn');

    let eventsCache = [];

    // ì´ˆê¸°í™”
    function getCurrentMonthValue() {
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
    }

    function resetToCurrentMonth() {
      monthPicker.value = getCurrentMonthValue();
      fetchEvents(); // ë‹¬ë ¥ ë‹¤ì‹œ ë¡œë“œ(ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡° í¬í•¨)
    }

    resetBtn.addEventListener('click', resetToCurrentMonth);

    // ====== ìœ í‹¸ ======
    function extractDatePart(v) {
      if (!v) return null;
      if (typeof v === 'string') {
        const m = v.match(/^(\d{4}-\d{2}-\d{2})/);
        return m ? m[1] : null;
      }
      if (typeof v === 'object' && (v.date || v.dateTime)) {
        return extractDatePart(v.date || v.dateTime);
      }
      return null;
    }

    // ì„œë²„ ì‘ë‹µì„ ë‹¬ë ¥ì—ì„œ ì“°ê¸° ì‰½ê²Œ ì •ê·œí™”
    function normalizeEvents(raw) {
      return (raw || []).map(ev => {
        const startRaw = ev.start ?? ev.startDate ?? ev.start_time ?? ev.startTime ?? (ev.start && (ev.start.date || ev.start.dateTime));
        const date = extractDatePart(startRaw);  // YYYY-MM-DD
        const title = ev.title ?? ev.summary ?? ev.name ?? 'ì¼ì •';
        // ì„œë²„ê°€ íƒœê·¸/íƒ€ì…ì„ ì£¼ë©´ ì—¬ê¸°ì— ë¶™ì—¬ë„ ë¨: const type = ev.type ?? ev.category ?? null;
        return { date, title, raw: ev };
      }).filter(e => !!e.date);
    }

        const HOLIDAY_EXCEPTIONS = [
          /í¬ë¦¬ìŠ¤ë§ˆìŠ¤\s*ì´ë¸Œ/i,
          /ì„±íƒ„ì ˆ\s*ì´ë¸Œ/i,
          /christmas\s*eve/i
        ];
        const HOLIDAY_PATTERNS = [
          /ì‹ ì •/,
          /ì„¤(?:ë‚ | ì—°íœ´)?/,
          /ëŒ€ì²´ê³µíœ´ì¼/,
          /ì‚¼ì¼ì ˆ/,
          /ì–´ë¦°ì´ë‚ /,
          /ë¶€ì²˜ë‹˜ì˜¤ì‹ ë‚ |ì„ê°€íƒ„ì‹ ì¼/,
          /í˜„ì¶©ì¼/,
          /ê´‘ë³µì ˆ/,
          /ì¶”ì„(?: ì—°íœ´)?/,
          /ê°œì²œì ˆ/,
          /í•œê¸€ë‚ /,
          /ì„±íƒ„ì ˆ|í¬ë¦¬ìŠ¤ë§ˆìŠ¤(?!\s*ì´ë¸Œ)/i   // â† â€˜ì´ë¸Œâ€™ê°€ ë’¤ì— ì˜¤ë©´ ë§¤ì¹­ ì•ˆ í•¨
        ];

    // ê³µíœ´ì¼ íŒë³„ (ì „ì—­: ë Œë”/ëª¨ë‹¬ ì–‘ìª½ì—ì„œ ì‚¬ìš©)
    function isHoliday(title, ev) {
      const t = (title || '').trim();

      // 1) ì˜ˆì™¸ ë¨¼ì € ì²˜ë¦¬
      if (HOLIDAY_EXCEPTIONS.some(rx => rx.test(t))) return false;

      // 2) (ì„ íƒ) ì„œë²„ê°€ ëª…ì‹œì ìœ¼ë¡œ íƒœê·¸ë¥¼ ì£¼ë©´ ê·¸ê±¸ ìš°ì„ 
      if (ev?.category === 'holiday' || ev?.type === 'HOLIDAY' || ev?.isHoliday === true) return true;

      // 3) ì œëª© ê¸°ë°˜
      if (HOLIDAY_PATTERNS.some(rx => rx.test(t))) return true;

      // 4) (ì„ íƒ) í•œêµ­ ê³µíœ´ì¼ ìº˜ë¦°ë” ë©”íƒ€ë°ì´í„°ì¼ ë•Œë§Œ true
      const org = (ev?.organizer?.email || ev?.creator?.email || '').toLowerCase();
      const calId = (ev?.calendarId || '').toLowerCase();
      if (calId === 'ko.south_korea#holiday@group.v.calendar.google.com') return true;

      return false;
    }

    // ====== ë°ì´í„° ë¡œë“œ ======
    async function fetchEvents() {
      showLoading();
      const [year, month] = monthPicker.value.split('-').map(Number);

      try {
        const res = await fetch(`/api/calendar/events?year=${year}&month=${month}`);
        if (!res.ok) throw new Error('Network response was not ok');

        const raw = await res.json();
        eventsCache = normalizeEvents(raw);
        renderCalendar(year, month, eventsCache);
      } catch (e) {
        console.error('Error fetching calendar events:', e);
        calendarContainer.innerHTML = '<p class="text-red-500">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê¶Œí•œì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>';
      } finally {
        hideLoading();
      }
    }

    // ====== ë Œë”ë§ ======
    function renderCalendar(year, month, events) {
      const firstDayOfMonth = new Date(year, month - 1, 1).getDay();
      const daysInMonth = new Date(year, month, 0).getDate();

      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

      let html = '';

      // Header
      html += '<div class="calendar-header">';
      html += `<button onclick="prevMonth()" class="p-2 rounded-full hover:bg-gray-200">&lt;</button>`;
      html += `<span>${year}ë…„ ${month}ì›”</span>`;
      html += `<button onclick="nextMonth()" class="p-2 rounded-full hover:bg-gray-200">&gt;</button>`;
      html += '</div>';

      // Grid + ìš”ì¼ í—¤ë”
      html += '<div class="calendar-grid bg-white rounded-lg p-2">';
      const daysOfWeek = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
      daysOfWeek.forEach(day => { html += `<div class="day-header">${day}</div>`; });

      // ì•ìª½ ê³µë°±
      for (let i = 0; i < firstDayOfMonth; i++) {
        html += '<div class="day bg-gray-100"></div>';
      }

      // ë‚ ì§œë“¤
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        const dayEvents = events.filter(e => e.date === dateStr);
        const todayClass = (dateStr === todayStr) ? ' is-today' : '';

        html += `<div class="day hover:bg-gray-200 transition-colors cursor-pointer${todayClass}" onclick="showDayEvents('${dateStr}', this)">`;
        html += `<div class="day-number text-right">${day}</div>`;

        dayEvents.forEach(ev => {
          const title = ev.title ?? ev.summary ?? 'ì¼ì •';
          let eventClass = '';

          if (isHoliday(title, ev.raw ?? ev)) eventClass = 'holiday';
          else if (title.includes('íœ´ê°€'))     eventClass = 'vacation';
          else if (title.includes('íŠ¹ê·¼'))     eventClass = 'special-duty';
          else if (title.includes('ì°½ë¦½ê¸°ë…')) eventClass = 'anniversary';

          html += `<div class="event ${eventClass}">${title}</div>`;
        });

        html += '</div>';
      }

      html += '</div>'; // calendar-grid ë‹«ê¸°
      calendarContainer.innerHTML = html;
    }

    // ====== ëª¨ë‹¬ ======
    function showDayEvents(dateStr) {
      const dayEvents = eventsCache.filter(e => e.date === dateStr);

      const items = dayEvents.map(e => {
        let colorClass = '';
        const title = e.title || 'ì¼ì •';
        if (isHoliday(title, e.raw)) colorClass = 'bg-amber-500';
        else if (title.includes('íœ´ê°€')) colorClass = 'bg-red-500';
        else if (title.includes('íŠ¹ê·¼')) colorClass = 'bg-blue-500';
        else if (title.includes('ì°½ë¦½ê¸°ë…')) colorClass = 'bg-green-500';
        return `<li class="event-item"><span class="color-box ${colorClass}"></span>${title}</li>`;
      }).join('');

      const eventListHtml = `
        <div class="event-list-container">
          <h3 class="event-list-title">${dateStr}ì˜ ì¼ì •</h3>
          <ul class="event-list">${items || '<li class="text-sm text-gray-500">ì¼ì • ì—†ìŒ</li>'}</ul>
        </div>
      `;

      let modal = document.getElementById('event-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'event-modal';
        modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 flex justify-center items-center';
        modal.innerHTML = `
          <div class="bg-white p-6 rounded-lg shadow-xl relative max-w-sm w-full">
            <button onclick="document.getElementById('event-modal').remove()" class="absolute top-2 right-2 text-gray-500 hover:text-gray-800">&times;</button>
            <div id="modal-content"></div>
          </div>
        `;
        document.body.appendChild(modal);
      }
      document.getElementById('modal-content').innerHTML = eventListHtml;
    }

    // ====== ë„¤ë¹„ê²Œì´ì…˜ ======
    function prevMonth() {
      const [y, m] = monthPicker.value.split('-').map(Number);
      const prevDate = new Date(y, m - 2, 1);
      monthPicker.value = `${prevDate.getFullYear()}-${String(prevDate.getMonth() + 1).padStart(2, '0')}`;
      fetchEvents();
    }

    function nextMonth() {
      const [y, m] = monthPicker.value.split('-').map(Number);
      const nextDate = new Date(y, m, 1);
      monthPicker.value = `${nextDate.getFullYear()}-${String(nextDate.getMonth() + 1).padStart(2, '0')}`;
      fetchEvents();
    }

    // ====== ë¡œë”© ======
    function showLoading() {
      loadingMessage.style.display = 'block';
      calendarContainer.style.display = 'none';
    }
    function hideLoading() {
      loadingMessage.style.display = 'none';
      calendarContainer.style.display = 'block';
    }

    // ====== ì´ˆê¸°í™” ======
    document.addEventListener('DOMContentLoaded', () => {
      const d = new Date();
      monthPicker.value = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      fetchEvents();
    });
    monthPicker.addEventListener('change', fetchEvents);
</script>


</body>
</html>
