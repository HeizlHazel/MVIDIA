<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA Â· ERP - ì „ìê²°ì¬ Â· ì‹ ì²­</title>

    <style>
        /* ê°œë³„ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .innerOuter {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 1200px;
            margin: 0 auto;
        }

        .swtch {
            display: flex;
            border-bottom: 1px solid #dee0ea;
            padding-bottom: 15px;
            margin-bottom: 12px;
            justify-content: space-between;
        }

        .tab {
            flex: 1;
            text-align: center;
            padding: 8px 12px;
            cursor: pointer;
            border: 1px solid #dee0ea;
            background-color: #f8f9fa;
            color: #6c757d;
            transition: all 0.3s ease;
            margin-right: 5px;
            border-radius: 4px 4px 0 0;
            outline: none;
        }

        .tab:last-child {
            margin-right: 0;
        }

        .tab:hover {
            background-color: #e9ecef;
            color: #495057;
            outline: none;
        }

        .tab.active {
            background-color: #fff;
            color: #007bff;
            border-bottom: 1px solid #fff;
            font-weight: 600;
            box-shadow: 0 -2px 4px rgba(0,123,255,0.1);
            outline: none;
        }

        .form {
            padding: 20px;
            background: #fff;
            border: 1px solid #dee0ea;
            border-top: none;
            border-radius: 0 0 8px 8px;
        }

        .form label {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            margin-bottom: 6px;
            display: block;
        }

        .form input,
        .form textarea,
        .form select {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #dde6ec;
            background: #fff;
            outline: none;
            font-size: 14px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        .form input:focus,
        .form textarea:focus,
        .form select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }

        .form input[readonly] {
            background: #f1f5f8;
            color: #6f7c83;
        }

        .form textarea {
            resize: vertical;
            font-family: inherit;
        }

        /* ê²°ì¬ì ì„ íƒ ê´€ë ¨ ìŠ¤íƒ€ì¼ - ì œê±° */size: 14px;
            margin: 6px;
        }

        .approval-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dde6ec;
            border-top: none;
            border-radius: 0 0 6px 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .approval-options.show {
            display: block;
        }

        .approval-option {
            padding: 10px 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .approval-option:hover {
            background-color: #f8f9fa;
        }

        .approval-option.selected {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .approval-search {
            padding: 10px 12px;
            border: none;
            border-bottom: 1px solid #dee0ea;
            outline: none;
            width: 100%;
            font-size: 14px;
        }

        /* í–‰ê³¼ ì»¬ëŸ¼ ë ˆì´ì•„ì›ƒ */
        .row {
            display: flex;
            gap: 20px;
        }

        .col-4 {
            width: calc(50% - 10px);
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        /* í•„ìˆ˜ í‘œì‹œ */
        .required {
            color: #dc3545;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 0 5px;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
    </style>
</head>
<body>
<div class="content">
    <div class="innerOuter">
        <h3>ğŸ“ ê²°ì¬ ì‹ ì²­</h3>
        <br>

        <div class="swtch" name="swtch">
            <button class="tab active" data-value="expense">ì§€ì¶œ ê²°ì˜ì„œ</button>
            <button class="tab" data-value="purchase">êµ¬ë§¤ ìš”ì²­ì„œ</button>
            <button class="tab" data-value="overtime">ì´ˆê³¼ ê·¼ë¬´ ì‹ ì²­ì„œ</button>
            <button class="tab" data-value="access">ERP ê¶Œí•œ ì‹ ì²­</button>
            <button class="tab" data-value="etc">ê¸°íƒ€ ê²°ì¬</button>
        </div>

        <form id="notionAddForm" class="form">
            <div class="row">
                <div class="col-4">
                    <label for="applyWriter">ì‘ì„±ì <span class="required">*</span></label>
                    <input type="text" name="applyWriter" id="applyWriter" th:value="|${session.loginEmp.empLName}${session.loginEmp.empName}|" readonly>
                </div>

                <div class="col-4">
                    <label for="applyDept">ë¶€ì„œ ì •ë³´ <span class="required">*</span></label>
                    <input type="text" name="applyDept" id="applyDept" th:value="${session.loginEmp.jobName}" readonly>
                </div>
            </div>

            <div class="form-group">
                <label for="applyDate">ì‘ì„±ì¼ <span class="required">*</span></label>
                <input type="date" name="applyDate" id="applyDate" value="" readonly th:value="${#dates.format(#dates.createNow(),'yyyy-MM-dd')}">
            </div>

            <div class="form-group">
                <label for="applyTitle">ì œëª© <span class="required">*</span></label>
                <input type="text" name="applyTitle" id="applyTitle" placeholder="ì˜ˆ: ì‚¬ë¬´ìš©í’ˆ êµ¬ë§¤ ì‹ ì²­" required>
            </div>

            <div class="form-group">
                <label for="approval">ê²°ì¬ì <span class="required">*</span></label>
                <select name="approval" id="approval" required>
                    <option value="">ê²°ì¬ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                </select>
            </div>

            <div class="form-group">
                <label for="details">ìƒì„¸ ë‚´ìš© <span class="required">*</span></label>
                <textarea name="details" id="details" rows="6" required>
- ì§€ì¶œ í•­ëª©:êµí†µë¹„/ì¶œì¥ë¹„/ì‚¬ë¬´ìš©í’ˆ/íšŒì˜ë¹„/ê¸°íƒ€
- ê¸ˆì•¡:
- ì‚¬ìš©ì²˜/ì—…ì²´ëª…:</textarea>
            </div>
            <br>

            <div style="text-align: center; margin-top: 30px;">
                <button type="submit" class="btn btn-primary">ë“±ë¡</button>
                <button type="reset" class="btn btn-secondary">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    // íƒ­ ì „í™˜ ê¸°ëŠ¥
    const tabs = document.querySelectorAll(".tab");
    const details = document.getElementById("details");

    tabs.forEach(tab => {
        tab.addEventListener("click", () => {
            tabs.forEach(t => t.classList.remove("active"));
            tab.classList.add("active");

            switch (tab.dataset.value) {
                case "overtime":
                    details.value = "- ê·¼ë¬´ ì‹ ì²­ ì¼ì: 00ë…„ 00ì›” 00ì¼ 00ì‹œ ~ 00ì‹œ(0h)\n- ê·¼ë¬´ ì‚¬ìœ :";
                    break;
                case "purchase":
                    details.value = "- êµ¬ë§¤ í’ˆëª©:ex)ë…¸íŠ¸ë¶\n- ìˆ˜ëŸ‰:\n- ê¸ˆì•¡:\n- êµ¬ë§¤ ì‹ ì²­ ì‚¬ìœ :";
                    break;
                case "expense":
                    details.value = "- ì§€ì¶œ í•­ëª©:êµí†µë¹„/ì¶œì¥ë¹„/ì‚¬ë¬´ìš©í’ˆ/íšŒì˜ë¹„/ê¸°íƒ€\n- ê¸ˆì•¡:\n- ì‚¬ìš©ì²˜/ì—…ì²´ëª…:";
                    break;
                case "access":
                    details.value = "- ì´ë¦„/ë¶€ì„œ/ì§ê¸‰:\n- í•„ìš” ê¶Œí•œ:\n- ì‹ ì²­ ì‚¬ìœ :";
                    break;
                case "etc":
                    details.value = "- ì´ë¦„/ë¶€ì„œ/ì§ê¸‰:\n- ì‹ ì²­ ì‚¬ìœ :";
                    break;
            }
        });
    });

    // ë¶€ì¥ê¸‰ ì§ì› ëª©ë¡ ë¡œë“œ
    function loadManagers() {
        $.ajax({
            url: "/api/managers",
            method: "GET",
            success: function(data) {
                console.log("ë¶€ì¥ê¸‰ ì§ì› ë°ì´í„°:", data);
                renderManagerOptions(data);
            },
            error: function() {
                console.error("ë¶€ì¥ê¸‰ ì§ì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨", status, error);
                console.error("ì‘ë‹µ:", xhr.responseText);
            }
        });
    }

    // ë¶€ì¥ê¸‰ ì§ì› ì˜µì…˜ ë Œë”ë§
    function renderManagerOptions(managers) {
        const approvalSelect = document.getElementById("approval");

        // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ ê¸°ë³¸ ì˜µì…˜ ì œì™¸)
        while (approvalSelect.children.length > 1) {
            approvalSelect.removeChild(approvalSelect.lastChild);
        }

        managers.forEach(manager => {
            const option = document.createElement("option");
            option.value = manager.empNo;
            option.textContent = `${manager.empName}-${manager.jobName}(${manager.empNo})`; //
            approvalSelect.appendChild(option);
        });
    }


    // í¼ ì œì¶œ
    $("#notionAddForm").on("submit", function(e) {
        e.preventDefault();

        // ê²°ì¬ìê°€ ì„ íƒë˜ì—ˆëŠ”ì§€ í™•ì¸
        const approvalValue = $("#approval").val();
        if (!approvalValue) {
            alert("ê²°ì¬ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
            return;
        }

        let activeTab = $(".tab.active").data("value");
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit');

        let formData = {
            applyWriter: $(this).find("input[name='applyWriter']").val(),
            applyDept: $(this).find("input[name='applyDept']").val(),
            applyDate: $(this).find("input[name='applyDate']").val(),
            applyTitle: $(this).find("input[name='applyTitle']").val(),
            approval: approvalValue,
            details: $(this).find("textarea[name='details']").val(),
            swtch: activeTab
        };

        // ìˆ˜ì • ëª¨ë“œì¸ì§€ ì‹ ê·œ ì‘ì„±ì¸ì§€ êµ¬ë¶„
        const url = editId ? `update.notion/${editId}` : "add.notion";
        const method = editId ? "PUT" : "POST";

        $.ajax({
            url: url,
            method: method,
            contentType: "application/json",
            data: JSON.stringify(formData),
            success: function(app) {
                if (app === "success") {
                    alert(editId ? "ì „ìê²°ì¬ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì „ìê²°ì¬ ì‹ ì²­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.href = "approvalbox";
                } else {
                    alert(editId ? "ì „ìê²°ì¬ ìˆ˜ì •ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤." : "ì „ìê²°ì¬ ì‹ ì²­ì´ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.");
                }
            },
            error: function() {
                alert("ì „ìê²°ì¬ ajax í†µì‹  ì‹¤íŒ¨");
            }
        });
    });

    // í˜ì´ì§€ ë¡œë“œì‹œ ë¶€ì¥ê¸‰ ì§ì› ëª©ë¡ ë¡œë“œ
    $(document).ready(function() {
        loadManagers();

        // ìˆ˜ì • ëª¨ë“œ ì²´í¬
        const urlParams = new URLSearchParams(window.location.search);
        const editId = urlParams.get('edit');

            if (editId) {
                // ìˆ˜ì • ëª¨ë“œ - ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
                loadDocumentForEdit(editId);
                // ì œëª© ë³€ê²½
                $('h3').text('ğŸ“ ê²°ì¬ ìˆ˜ì •');
                // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½
                $('.btn-primary').text('ìˆ˜ì •');
            }

        // ìˆ˜ì •í•  ë¬¸ì„œ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ ì¶”ê°€
        function loadDocumentForEdit(id) {
            $.ajax({
                url: `/approval/detail/${id}`,
                method: "GET",
                success: function(data) {
                    console.log("ì„œë²„ì—ì„œ ë°›ì€ ë°ì´í„°:", data); // ë””ë²„ê¹…ìš©

                    // í¼ í•„ë“œì— ê¸°ì¡´ ë°ì´í„° ì±„ìš°ê¸°
                    $('#applyTitle').val(data.title);
                    $('#details').val(data.content);

                    // ê²°ì¬ì ì„¤ì • - approversì—ì„œ ì‚¬ë²ˆ ì¶”ì¶œ í•„ìš”
                    // ì¼ë‹¨ ì„ì‹œë¡œ ë¹„ì›Œë‘ê³  í™•ì¸
                    console.log("ê²°ì¬ì ì •ë³´:", data.approvers);

                    // ì¹´í…Œê³ ë¦¬ ë§¤í•‘ í™•ì¸
                    console.log("ì¹´í…Œê³ ë¦¬:", data.category);

                    // ì¹´í…Œê³ ë¦¬ì— ë”°ë¥¸ íƒ­ í™œì„±í™”
                    const categoryMap = {
                        'ì§€ì¶œê²°ì˜': 'expense',
                        'êµ¬ë§¤ìš”ì²­': 'purchase',
                        'ì´ˆê³¼ê·¼ë¬´ì„œ': 'overtime',
                        'ê¶Œí•œì‹ ì²­': 'access',
                        'ê¸°íƒ€ê²°ì¬': 'etc'
                    };

                    const tabValue = categoryMap[data.category] || 'etc';
                    console.log("ë§¤í•‘ëœ íƒ­:", tabValue);

                    $('.tab').removeClass('active');
                    $(`.tab[data-value="${tabValue}"]`).addClass('active');
                },
                error: function(xhr, status, error) {
                    console.error('ë¬¸ì„œ ë¡œë“œ ì‹¤íŒ¨:', status, error);
                    console.error('ì‘ë‹µ:', xhr.responseText);
                    alert('ë¬¸ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    });
</script>
</body>
</html>