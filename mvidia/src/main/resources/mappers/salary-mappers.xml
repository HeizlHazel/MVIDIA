<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="salaryMapper">

    <resultMap id="salaryResultSet" type="Salary">
        <result column="payDate" property="payDate"/>
        <result column="empNo" property="empNo"/>
        <result column="salary" property="salary"/>
        <result column="ovPrice" property="ovPrice"/>
        <result column="bonus" property="bonus"/>
        <result column="emp_name" property="empName"/>
        <result column="emp_lname" property="empLname"/>
        <result column="birthDay" property="birthDay"/>
        <result column="dept_code" property="deptCode"/>
        <result column="dept_name" property="deptName"/>
        <result column="job_code" property="jobCode"/>
        <result column="job_name" property="jobName"/>
        <result property="accountNo" column="accountNo"/>
        <result property="bankName" column="bankName"/>
        <result property="accountFormat" column="account_format"/>
    </resultMap>

    <resultMap id="attendanceResultSet" type="Attendance">
        <result column="attDate" property="attDate"/>
        <result column="leavingTime" property="leavingTime"/>
        <result column="att_status" property="attStatus"/>
        <result column="att_no" property="attNo"/>
        <result column="emp_no" property="empNo"/>
    </resultMap>

    <select id="selectSalary" parameterType="map" resultType="Salary">
        select
               to_char(s.pay_date, 'YYYY-MM') as payDate
             , s.emp_no                       as empNo
             , s.salary                       as salary
             , nvl(s.ov_price, 0)             as ovPrice
             , nvl(s.bonus, 0)                as bonus
             , (s.salary *
               nvl(s.bonus, 0) / 100)         as bonusAmt
             , nvl(s.deduct_amt, 0) as deductAmt
             , (s.salary + nvl(s.ov_price,0) + nvl(s.bonus,0)
               - nvl(s.deduct_amt,0))         as netPay
             , emp_Lname || e.emp_name         as empName
             , to_char(
               e.birthday, 'YYYY-MM-DD')      as birthDay
             , e.dept_code                    as deptCode
             , d.dept_name                    as deptName
             , e.job_code                     as jobCode
             , j.job_name                     as jobName
             , a.account_no                   as accountNo
             , b.bank_name                    as bankName
             , b.acct_format                  as accountFormat

             , nvl( (select amount from tb_salary_over
               where emp_no = s.emp_no and pay_date =
               s.pay_date and ov_code = 'OV0001'), 0) as extendOv

             , nvl( (select amount from tb_salary_over
               where emp_no = s.emp_no and pay_date =
               s.pay_date and ov_code = 'OV0002'), 0) as nightOv

             , nvl( (select amount from tb_salary_over
               where emp_no = s.emp_no and pay_date =
               s.pay_date and ov_code = 'OV0003'), 0) as weekendOv

             , nvl( (select amount from tb_salary_over
               where emp_no = s.emp_no and pay_date =
               s.pay_date and ov_code = 'OV0004'), 0) as tripOv

             , nvl( (select amount from tb_salary_tax
               where emp_no = s.emp_no and pay_date =
               s.pay_date and tax_code = 'TAX0001'), 0) as nationalPension

             , nvl( (select amount from tb_salary_tax
               where emp_no = s.emp_no and pay_date =
               s.pay_date and tax_code = 'TAX0002'), 0) as healthInsurance

             , nvl( (select amount from tb_salary_tax
               where emp_no = s.emp_no and pay_date =
               s.pay_date and tax_code = 'TAX0003'), 0) as employmentInsurance

             , nvl( (select amount from tb_salary_tax
               where emp_no = s.emp_no and pay_date =
               s.pay_date and tax_code = 'TAX0004'), 0) as incomeTax

             , nvl( (select amount from tb_salary_tax
               where emp_no = s.emp_no and pay_date =
               s.pay_date and tax_code = 'TAX0005'), 0) as localTax

             , nvl(s.deduct_amt, 0)                     as deductAmt

             , (s.salary + nvl(s.ov_price,0)
                + (s.salary * nvl(s.bonus,0) / 100))    as totalPay
          from tb_salary s
          join tb_employee e on s.emp_no = e.emp_no
          join tb_department d on e.dept_code = d.dept_code
          join tb_job j on e.job_code = j.job_code
          left join tb_account a on s.emp_no = a.emp_no
          left join tb_bank b on a.bank_id = b.bank_id

        <where>
            <if test="yearMonth != null and yearMonth != ''">
                and to_char(s.pay_date, 'YYYY-MM') = #{yearMonth}
            </if>
            <if test="empNo != null and empNo != ''">
                and s.emp_no = #{empNo}
            </if>
            <if test="deptCode != null and deptCode != ''">
                and e.dept_code = #{deptCode}
            </if>
            <if test="jobCode != null and jobCode != ''">
                and e.job_code = #{jobCode}
            </if>
            <if test="empName != null and empName != ''">
                e.emp_lname || e.emp_name LIKE '%' || #{empName} || '%'
            </if>
        </where>
    </select>


    <update id="upsertSalaryOver">
         merge into tb_salary_over t
         using
             (
            select #{empNo} as emp_no
                 , (select max(pay_date)
              from tb_salary
             where emp_no = #{empNo}
               and to_char(pay_date,'YYYY-MM') = #{yearMonth}
             ) as pay_date
             , #{ovCode} as ov_code
             , #{amount} as amount
          from dual
             ) d
            on (t.emp_no = d.emp_no
           and t.pay_date = d.pay_date
           and t.ov_code = d.ov_code)
          when matched then
        update set t.amount = d.amount
          when not matched then
        insert (emp_no, pay_date, ov_code, amount)
        values (d.emp_no, d.pay_date, d.ov_code, d.amount)
    </update>

    <update id="upsertSalaryTax">
         merge into tb_salary_tax t
         using
             (
               select #{empNo} as emp_no
             , (select max(pay_date)
                  from tb_salary
                 where emp_no = #{empNo}
                   and to_char(pay_date,'YYYY-MM') = #{yearMonth}
                ) as pay_date
             , #{taxCode} as tax_code
             , #{amount}  as amount
              from dual
             ) d
            on
             (
               t.emp_no = d.emp_no
           and t.pay_date = d.pay_date
           and t.tax_code = d.tax_code
             )
          when matched then
        update set t.amount = d.amount
          when not matched then
        insert
             (
               emp_no
             , pay_date
             , tax_code
             , amount
             )
        values
             (
               d.emp_no
             , d.pay_date
             , d.tax_code
             , d.amount
             )
    </update>

    <update id="updateDeductAmt" parameterType="map">
        update tb_salary
           set deduct_amt = #{deductAmt}
         where emp_no = #{empNo}
           and to_char(pay_date, 'YYYY-MM') = #{yearMonth}
    </update>

    <update id="updateOvPrice">
        update tb_salary
           set ov_price = #{ovPrice}
         where emp_no = #{empNo}
           and to_char(pay_date, 'YYYY-MM') = #{yearMonth}
    </update>

    <select id="selectTaxesByEmpAndMonth" parameterType="map" resultType="Tax">
        select tax_code                     as taxCode
             , emp_no                       as empNo
             , to_char(pay_date, 'YYYY-MM') as payDate
             , amount                       as amount
          from tb_salary_tax
         where emp_no = #{empNo}
           and to_char(pay_date, 'YYYY-MM') = #{payDate}
    </select>

    <select id="selectAttendanceByMonth" resultMap="attendanceResultSet">
        select att_no
        , emp_no
        , to_char(att_date,'YYYY-MM-DD') as attDate
        , to_char(leaving_time,'HH24:MI') as leavingTime
        , att_status
        from tb_attendance
        where to_char(att_date,'YYYY-MM') = #{yearMonth}
          and emp_no = #{empNo}
        order by emp_no, att_date
    </select>

</mapper>