<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="salaryMapper">

    <resultMap id="salaryResultSet" type="Salary">
        <result column="payDate" property="payDate"/>
        <result column="empNo" property="empNo"/>
        <result column="salary" property="salary"/>
        <result column="ovPrice" property="ovPrice"/>
        <result column="bonus" property="bonus"/>
        <result column="emp_name" property="empName"/>
        <result column="dept_code" property="deptCode"/>
        <result column="dept_name" property="deptName"/>
        <result column="job_code" property="jobCode"/>
        <result column="job_name" property="jobName"/>
    </resultMap>




    <resultMap id="attendanceResultSet" type="Attendance">
        <result column="ATT_NO" property="attNo"/>
        <result column="EMP_NO" property="empNo"/>
        <result column="ATT_DATE" property="attDate"/>
        <result column="LEAVING_TIME" property="leavingTime"/>
    </resultMap>

    <select id="selectSalaryByCondition" resultMap="salaryResultSet">
        SELECT TO_CHAR(s.PAY_DATE, 'YYYYMM') AS payDate,
        s.EMP_NO                      AS empNo,
        s.SALARY                      AS salary,
        NVL(s.OV_PRICE, 0)            AS ovPrice,
        NVL(s.BONUS, 0)               AS bonus,
        e.EMP_NAME,
        e.dept_code,
        d.dept_name,
        e.job_code,
        j.job_name
        FROM TB_SALARY s
        JOIN TB_EMPLOYEE e ON s.EMP_NO = e.EMP_NO
        JOIN TB_DEPARTMENT d ON e.DEPT_CODE = d.DEPT_CODE
        JOIN TB_JOB j ON e.JOB_CODE = j.JOB_CODE
        <where>
        <if test="yearMonth != null and yearMonth != ''">
            AND TO_CHAR(s.PAY_DATE, 'YYYYMM') = #{yearMonth}
        </if>
        <if test="deptCode != null and deptCode != ''">
            AND e.DEPT_CODE = #{deptCode}
        </if>
        <if test="jobCode != null and jobCode != ''">
            AND e.JOB_CODE = #{jobCode}
        </if>
        <if test="empName != null and empName != ''">
            AND e.EMP_NAME LIKE '%' || #{empName} || '%'
        </if>
        </where>
        ORDER BY s.EMP_NO
    </select>

    <select id="selectSalaryByEmpAndMonth" parameterType="map"
            resultType="Salary">
        SELECT
        TO_CHAR(s.PAY_DATE, 'YYYY-MM') AS payDate,
        s.EMP_NO                      AS empNo,
        s.SALARY                      AS salary,
        NVL(s.OV_PRICE, 0)            AS ovPrice,
        NVL(s.BONUS, 0)               AS bonus,
        (s.SALARY * NVL(s.BONUS, 0) / 100) AS bonusAmt,
        NVL(s.DEDUCT_AMT, 0)          AS deductAmt,
        (s.SALARY + NVL(s.OV_PRICE,0) + NVL(s.BONUS,0) - NVL(s.DEDUCT_AMT,0)) AS netPay,
        e.EMP_NAME                    AS empName,
        e.DEPT_CODE                   AS deptCode,
        d.DEPT_NAME                   AS deptName,
        e.JOB_CODE                    AS jobCode,
        j.JOB_NAME                    AS jobName,
        -- 추가수당
        NVL((SELECT AMOUNT FROM TB_SALARY_OVER
            WHERE EMP_NO = s.EMP_NO
            AND PAY_DATE = s.PAY_DATE
            AND OV_CODE = 'OV0001'), 0) AS extendOv,
        NVL((SELECT AMOUNT FROM TB_SALARY_OVER
            WHERE EMP_NO = s.EMP_NO
            AND PAY_DATE = s.PAY_DATE
            AND OV_CODE = 'OV0002'), 0) AS nightOv,
        NVL((SELECT AMOUNT FROM TB_SALARY_OVER
            WHERE EMP_NO = s.EMP_NO
            AND PAY_DATE = s.PAY_DATE
            AND OV_CODE = 'OV0003'), 0) AS weekendOv,
        NVL((SELECT AMOUNT FROM TB_SALARY_OVER
            WHERE EMP_NO = s.EMP_NO
            AND PAY_DATE = s.PAY_DATE
            AND OV_CODE = 'OV0004'), 0) AS tripOv
         FROM TB_SALARY s
         JOIN TB_EMPLOYEE e ON s.EMP_NO = e.EMP_NO
         JOIN TB_DEPARTMENT d ON e.DEPT_CODE = d.DEPT_CODE
         JOIN TB_JOB j ON e.JOB_CODE = j.JOB_CODE
        WHERE s.EMP_NO = #{empNo}
          AND TO_CHAR(s.PAY_DATE, 'YYYY-MM') = #{payDate}
    </select>

    <select id="selectAttendanceByMonth" resultMap="attendanceResultSet">
        SELECT ATT_NO,
               EMP_NO,
               TO_CHAR(ATT_DATE,'YYYYMMDD') AS attDate,
               TO_CHAR(LEAVING_TIME,'HH24:MI') AS leavingTime
          FROM TB_ATTENDANCE
         WHERE TO_CHAR(ATT_DATE,'YYYYMM') = #{yearMonth}
         ORDER BY EMP_NO, ATT_DATE
    </select>

    <select id="selectDeductByEmpMonth" resultType="int">
        select nvl(sum(amount), 0)
          from tb_salary_tax
         where emp_no = #{empNo}
           and to_char(pay_date, 'YYYYMM') = #{yearMonth}
    </select>

    <update id="updateOvPrice">
        UPDATE TB_SALARY
           SET OV_PRICE = #{ovPrice}
         WHERE EMP_NO = #{empNo}
           AND TO_CHAR(PAY_DATE, 'YYYYMM') = #{yearMonth}
    </update>

    <update id="upsertSalaryOver">
         MERGE INTO TB_SALARY_OVER t
         USING (
        SELECT #{empNo} AS emp_no,
               (SELECT MAX(PAY_DATE)
          FROM TB_SALARY
         WHERE EMP_NO = #{empNo}
               AND TO_CHAR(PAY_DATE,'YYYYMM') = #{yearMonth}
               ) AS pay_date,
               #{ovCode} AS ov_code,
               #{amount} AS amount
          FROM dual
                ) d
            ON (t.emp_no = d.emp_no
           AND t.pay_date = d.pay_date
           AND t.ov_code = d.ov_code)
          WHEN MATCHED THEN
        UPDATE SET t.amount = d.amount
          WHEN NOT MATCHED THEN
        INSERT (emp_no, pay_date, ov_code, amount)
         VALUES (d.emp_no, d.pay_date, d.ov_code, d.amount)
    </update>

    <update id="upsertSalaryTax">
         MERGE INTO TB_SALARY_TAX t
         USING (
             SELECT #{empNo} AS emp_no,
                    (SELECT MAX(PAY_DATE)
                       FROM TB_SALARY
                      WHERE EMP_NO = #{empNo}
                        AND TO_CHAR(PAY_DATE,'YYYYMM') = #{yearMonth}
                    ) AS pay_date,
                    #{taxCode} AS tax_code,
                    #{amount}  AS amount
             FROM dual
        ) d
        ON (t.emp_no = d.emp_no AND t.pay_date = d.pay_date AND t.tax_code = d.tax_code)
        WHEN MATCHED THEN
            UPDATE SET t.amount = d.amount
        WHEN NOT MATCHED THEN
            INSERT (emp_no, pay_date, tax_code, amount)
            VALUES (d.emp_no, d.pay_date, d.tax_code, d.amount)
    </update>

    <update id="updateDeductAmt" parameterType="map">
        UPDATE TB_SALARY
        SET DEDUCT_AMT = #{deductAmt}
        WHERE EMP_NO = #{empNo}
        AND PAY_DATE = #{payDate}
    </update>

    <select id="selectTaxesByEmpAndMonth" parameterType="map" resultType="Tax">
        SELECT TAX_CODE    AS taxCode,
               EMP_NO      AS empNo,
               TO_CHAR(PAY_DATE, 'YYYY-MM') AS payDate,
               AMOUNT      AS amount
          FROM TB_SALARY_TAX
         WHERE EMP_NO = #{empNo}
           AND TO_CHAR(PAY_DATE, 'YYYY-MM') = #{PayDate}
    </select>

    <select id="selectQuarterlySales" resultType="com.kh.mvidia.finance.model.vo.Sales">
        SELECT p.PROD_NAME AS prodName,
               EXTRACT(YEAR FROM s.PERIOD_ST) AS year,
               TO_NUMBER(TO_CHAR(s.PERIOD_ST, 'Q')) AS quarter,
               SUM(s.TOTAL_SALES) AS totalSales,
               SUM(s.OP_PROFIT) AS opProfit
          FROM TB_SALES s
          JOIN TB_PRODUCTION_QUALITY p
            ON s.PROD_CODE = p.PROD_CODE
         WHERE EXTRACT(YEAR FROM s.PERIOD_ST) = #{year}
         GROUP BY p.PROD_NAME, EXTRACT(YEAR FROM s.PERIOD_ST), TO_CHAR(s.PERIOD_ST, 'Q')
         ORDER BY p.PROD_NAME, quarter
    </select>

</mapper>