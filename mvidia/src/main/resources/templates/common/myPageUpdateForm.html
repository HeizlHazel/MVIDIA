<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>개인정보 수정</title>
    <style>
        .profileUpdatePage > .widget {background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, .1);}
        .profileUpdatePage .page-title {margin-bottom: 15px;}
        .form-group {margin-bottom: 15px;}
        .form-group label {display: block; margin-bottom: 6px; font-weight: 700;}
        .form-group input, .form-group select, .form-group textarea {width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;}
        .profile-section {display: flex; align-items: center; gap: 20px; margin-bottom: 15px;}
        .profile-pic {width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd;}
        .file-input-group {flex-grow: 1;}
        .error-message {color: #d9534f; font-size: 12px; margin-top: 5px; display: none;}
        .btn {display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; background-color: #0c197f; color: #fff; border: none; cursor: pointer; transition: background-color 0.2s;}
        .btn:hover {background: #0050be;}
        .btn:disabled {background-color: #cccccc; cursor: not-allowed;}
        .btn-secondary {background-color: #6c757d;}
        .btn-secondary:hover {background-color: #5a6268;}
    </style>
</head>
<body>
<div class="profileUpdatePage" id="profile-edit-request">
    <h2 class="page-title">✏️ 개인정보 수정 요청</h2>
    <div class="widget" id="home">
        <form id="editReqForm" action="/updateInfo.emp" method="post" enctype="multipart/form-data">

            <!-- 프로필 사진 섹션 -->
            <div class="profile-section">
                <div th:if="${atch == null}">
                    <img class="profile-pic" th:src="@{/images/default_profile.png}" alt="기본 프로필">
                </div>
                <div th:unless="${atch == null}">
                    <img th:src="@{/uploadFiles/{fileName}(fileName=${atch.changeName})}" alt="프로필 사진" class="profile-pic">
                </div>
                <div class="file-input-group">
                    <label style="margin-right:10px;" th:text="${atch != null ? atch.originName : '프로필 사진 미 첨부'}"></label>
                    <br>
                    <span>변경할 프로필 사진 : </span>
                    <input name="atchFile" type="file" accept="image/*" onchange="previewProfilePic(event)">

                </div>
            </div>

            <div class="form-group">
                <label>성</label>
                <input name="empLName" th:value="${session.loginEmp.empLName}" type="text" placeholder="변경할 성" oninput="validateName('korean')">
                <div class="error-message" id="korean-name-error">한글로 입력해주세요.</div>
            </div>
            <div class="form-group">
                <label>이름</label>
                <input name="empName" th:value="${session.loginEmp.empName}" type="text" placeholder="변경할 이름" oninput="validateName('korean')">
            </div>
            <div class="form-group">
                <label>영문성</label>
                <input name="empEngLName" th:value="${session.loginEmp.empEngLName}" type="text" placeholder="변경할 영문성" oninput="validateName('english')">
                <div class="error-message" id="english-name-error">영어로 입력해주세요.</div>
            </div>
            <div class="form-group">
                <label>영문이름</label>
                <input name="empEngName" th:value="${session.loginEmp.empEngName}" type="text" placeholder="변경할 영문이름" oninput="validateName('english')">
            </div>

            <div class="form-group"><label>생년월일</label><input name="birthday" th:value="${session.loginEmp.birthday}" type="date"></div>
            <div class="form-group"><label>주소</label><input name="address" th:value="${session.loginEmp.address}" type="text" placeholder="변경할 주소"></div>
            <div class="form-group"><label>전화번호</label><input name="phone" th:value="${session.loginEmp.phone}" type="tel" placeholder="변경할 전화번호"></div>
            <div class="form-group"><label>내선번호</label><input name="extNo" th:value="${session.loginEmp.extNo}" type="tel" placeholder="변경할 내선번호"></div>

            <button type="button" class="btn" id="submitBtn" onclick="submitProfileEditRequest()">수정 요청 제출</button>
            <button type="button" class="btn btn-secondary" onclick="window.location.href = '/myPage/profile'">취소</button>
        </form>
    </div>
</div>

<script th:inline="javascript">
    /* JavaScript로 유효성 검사 및 미리보기 기능 추가 */
    let initialFormState = {};

    // 필드명과 한글 레이블을 연결하는 객체
    const fieldLabels = {
        'empLName': '성',
        'empName': '이름',
        'empEngLName': '영문성',
        'empEngName': '영문이름',
        'birthday': '생년월일',
        'address': '주소',
        'phone': '전화번호',
        'extNo': '내선번호'
    };

    $(document).ready(function() {
        // 폼의 초기 상태 저장
        initialFormState = getFormValues();
    });

    function getFormValues() {
        const values = {};
        $('#editReqForm').find('input:not([type="file"])').each(function() {
            values[$(this).attr('name')] = $(this).val();
        });
        // 파일 입력은 별도로 처리
        values['atchFile'] = $('input[name="atchFile"]').val();
        return values;
    }

    function previewProfilePic(event) {
        const reader = new FileReader();
        reader.onload = function(){
            const output = document.getElementById('profile-preview');
            output.src = reader.result;
        };
        reader.readAsDataURL(event.target.files[0]);
    }

    function validateName(type) {
        const koreanLName = document.querySelector('input[name="empLName"]');
        const koreanName = document.querySelector('input[name="empName"]');
        const englishLName = document.querySelector('input[name="empEngLName"]');
        const englishName = document.querySelector('input[name="empEngName"]');
        const submitBtn = document.getElementById('submitBtn');

        const koreanRegex = /^[가-힣]+$/;
        const englishRegex = /^[a-zA-Z]+$/;

        let isKoreanValid = koreanRegex.test(koreanLName.value) && koreanRegex.test(koreanName.value);
        let isEnglishValid = englishRegex.test(englishLName.value) && englishRegex.test(englishName.value);

        if (type === 'korean') {
            const errorElement = document.getElementById('korean-name-error');
            if (koreanLName.value !== '' && koreanName.value !== '' && !isKoreanValid) {
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
        }

        if (type === 'english') {
            const errorElement = document.getElementById('english-name-error');
            if (englishLName.value !== '' && englishName.value !== '' && !isEnglishValid) {
                errorElement.style.display = 'block';
            } else {
                errorElement.style.display = 'none';
            }
        }

        submitBtn.disabled = !isKoreanValid || !isEnglishValid;
    }

    function submitProfileEditRequest() {
        const currentFormState = getFormValues();
        let changedFields = [];

        // 파일 변경 여부 확인
        const fileInput = $('input[name="atchFile"]')[0];
        const isFileChanged = fileInput.files.length > 0;

        // 다른 필드 변경 여부 확인
        for (const key in initialFormState) {
            if (key !== 'atchFile' && initialFormState[key] !== currentFormState[key]) {
                changedFields.push({
                    name: key,
                    from: initialFormState[key],
                    to: currentFormState[key]
                });
            }
        }

        if (changedFields.length === 0 && !isFileChanged) {
            // 변경 사항이 없을 경우
            alertify.alert('알림', '변경 사항이 없습니다.', function() {
                window.location.href = '/myPage/profile';
            });
        } else {
            // 변경 사항이 있을 경우
            let confirmMessage = '변경 내용을 전송하시겠습니까?<br><br>';
            changedFields.forEach(field => {
                const label = fieldLabels[field.name] || field.name; // 한글 레이블 사용
                confirmMessage += `${label}: ${field.from} => ${field.to}<br>`;
            });
            if (isFileChanged) {
                confirmMessage += `프로필 사진: 변경됨<br>`;
            }

            alertify.confirm('변경 내용 확인', confirmMessage,
                function() {
                    // 사용자가 "확인"을 누른 경우
                    document.getElementById('editReqForm').submit();
                },
                function() {
                    // 사용자가 "취소"를 누른 경우
                    alertify.error('요청이 취소되었습니다.');
                }
            );
        }
    }
</script>
</body>
</html>
