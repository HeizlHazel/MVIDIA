<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA Â· ERP - ì¸ì‚¬ê´€ë¦¬ Â· ì¸ì‚¬ í†µí•© ê´€ë¦¬</title>
    <style>
        .hr-integrated { grid-column: 2; grid-row: 2; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); width: 1200px; margin: 0 auto; }
        .hr-integrated > .widget { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, .1); }
        #deptSelect {padding:10px 12px;border-radius:12px;border:1px solid #dde6ec;}
        .stack { display: flex; gap: 10px; flex-wrap: wrap; }
        .mt8 { margin-top: 8px; }
        .mt16 { margin-top: 16px; display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;}
        .muted { color: var(--muted); }
        .table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        .table th { font-size: 12px; color: #698492; text-align: left; padding: 0 10px; }
        .table td { background: #fff; padding: 12px; border-top: 1px solid #e7eef3; border-bottom: 1px solid #e7eef3; }
        .job-group { grid-column: 1 / -1; margin-top: 10px; }
        .job-group h3 { margin: 0; padding-bottom: 5px; border-bottom: 2px solid #ddd; }
        .job-group .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; margin-top: 12px; }
        .card-footer-action:hover {color: #0056b3;}
    </style>
</head>
<body>

<div class="hr-integrated">
    <div class="widget" id="home">
        <h3>ğŸ“‹ ì¸ì‚¬ í†µí•© ê´€ë¦¬ Â· ë¶€ì„œë³„ ì¸ì‚¬ì •ë³´</h3>
        <br>
        <div class="stack mt8">
            <select id="deptSelect">
                <option value="ALL">ì „ì²´ ë¶€ì„œ</option>
            </select>
            <span id="allDeptMessage" class="muted">* ê° ë¶€ì„œë³„ ë¶€ì¥ 1ëª…ì”©ë§Œ í‘œì‹œë©ë‹ˆë‹¤.</span>
        </div>
        <div id="integratedList" class="mt16">
        </div>
    </div>
</div>

<script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¶€ì„œ ëª©ë¡ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ ì…€ë ‰íŠ¸ ë°•ìŠ¤ë¥¼ ì±„ì›ë‹ˆë‹¤.
    $(document).ready(function() {
        fetchDepartments();
        refreshIntegrated(); // ì´ˆê¸° í™”ë©´ ë Œë”ë§
    });

    // ë¶€ì„œ ëª©ë¡ì„ ì„œë²„ì—ì„œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
    function fetchDepartments() {
        $.ajax({
            url: '/hr/departments',
            type: 'GET',
            success: function(response) {
                const deptSelect = $('#deptSelect');
                response.forEach(dept => {
                    deptSelect.append(`<option value="${dept.deptName}">${dept.deptName}</option>`);
                });
            },
            error: function(xhr) {
                console.error("ë¶€ì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ", xhr.responseText);
            }
        });
    }

    // ì„ íƒëœ ë¶€ì„œì— ë”°ë¼ ì„œë²„ì—ì„œ ì¸ì‚¬ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ í™”ë©´ì„ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜
    function refreshIntegrated() {
        const currentDept = $('#deptSelect').val();

        if (currentDept === 'ALL') {
            $('#allDeptMessage').show();
        } else {
            $('#allDeptMessage').hide();
        }
        const url = currentDept === 'ALL' ? '/hr/integrated/all' : `/hr/integrated/dept/${currentDept}`;

        $.ajax({
            url: url,
            type: 'GET',
            success: function(employees) {
                const integratedListArea = $('#integratedList');
                integratedListArea.empty(); // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”

                const positionOrder = ['ë¶€ì¥', 'ì°¨ì¥', 'ê³¼ì¥', 'ëŒ€ë¦¬', 'ì‚¬ì›'];

                if (currentDept === 'ALL') {
                    // 'ì „ì²´ ë¶€ì„œ' ì„ íƒ ì‹œ, ê° ë¶€ì„œë³„ ë¶€ì¥ë§Œ í‘œì‹œ
                    employees.sort((a, b) => a.deptName.localeCompare(b.deptName)).forEach(emp => {
                        integratedListArea.append(createEmployeeCard(emp, ''));
                    });
                } else {
                    // íŠ¹ì • ë¶€ì„œ ì„ íƒ ì‹œ, ì§ê¸‰ë³„ íŠ¸ë¦¬ êµ¬ì¡°ë¡œ í‘œì‹œ
                    const employeesByPosition = employees.reduce((acc, emp) => {
                        acc[emp.jobName] = acc[emp.jobName] || [];
                        acc[emp.jobName].push(emp);
                        return acc;
                    }, {});

                    positionOrder.forEach(jobName => {
                        if (employeesByPosition[jobName]) {
                            integratedListArea.append(createEmployeeGroup(jobName, employeesByPosition[jobName]));
                        }
                    });
                }
            },
            error: function(xhr) {
                console.error("ì¸ì‚¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ", xhr.responseText);
            }
        });
    }

    // ì‚¬ì› ì¹´ë“œë¥¼ ìƒì„±í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function createEmployeeCard(emp) {
    const defaultProfile = '/images/default_profile.png';
    const profileImg = emp.changeName ? `/uploadFiles/${emp.changeName}` : defaultProfile;
        return `
            <div class="card" style="position: relative; border-radius:10px">
                <div style="display: flex; gap: 12px; align-items: center;">
                    <img src="${profileImg}" alt="profile" style="width: 54px; height: 54px; border-radius: 50%; object-fit: cover; background: #e1e9ee;" />
                    <div style="display: flex; flex-direction: column;">
                        <b>${emp.empName} <span class="muted">(${emp.empNo})</span></b>
                        <span class="muted">${emp.deptName} Â· ${emp.jobName}</span>
                        <span class="muted" style="font-size: 12px;">${emp.email || ''}</span>
                    </div>
                </div>
                <a class="btn card-footer-action" href="/hr/accountModifyDetail.hr?empNo=${emp.empNo}">ì •ë³´ì¡°íšŒ</a>
            </div>
        `;
    }

    // ì§ê¸‰ë³„ ê·¸ë£¹ì„ ìƒì„±í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function createEmployeeGroup(jobName, employees) {
        let groupHtml = `<div class="job-group">
                             <h3>${jobName}</h3>
                             <div class="card-grid">`;

        employees.sort((a, b) => a.empName.localeCompare(b.empName)).forEach(emp => {
            groupHtml += createEmployeeCard(emp);
        });

        groupHtml += `</div></div>`;
        return groupHtml;
    }

    // ë¶€ì„œ ì„ íƒ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    $('#deptSelect').on('change', refreshIntegrated);
</script>
</body>
</html>