<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}">
<head>
    <meta charset="UTF-8">
    <title>MVIDIA Â· ERP - ì¸ì‚¬ê´€ë¦¬ Â· ì‚¬ì› ì •ë³´ ë³€ê²½</title>
    <style>
        .accountCreate { grid-column: 2; grid-row: 2; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); width: 1200px; margin: 0 auto; }
        .accountCreate > .widget { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, .1); }
        .form { display: grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 14px; }
        .profile-section { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .profile-pic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }
        .file-input-group { flex-grow: 1; }
        .form .field { display: flex; flex-direction: column; gap: 8px; }
        .form label { font-size: 12px; color: var(--muted); }
        .form input, .form select, .form textarea { padding: 10px 12px; border-radius: 12px; border: 1px solid #dde6ec; background: #fff; outline: none; }
        .form input[readonly] { background: #f1f5f8; color: #6f7c83; }
        .form .full { grid-column: 1 / -1; }
        .form .actions { grid-column: 1 / -1; display: flex; gap: 8px; margin-top: 6px; }
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; background-color: #0c197f; color: #fff; }
        .btn.ghost { background: transparent; color: #002B39; border: 1px solid #002B39; }
        .badge { font-size: .7rem; color: #fff; padding: 2px 6px; border-radius: 8px; margin-left: 5px; vertical-align: middle; }
        .updated-badge { background: #28a745; }
        .rejected-badge { background: #dc3545; display: none; }
        .modal { display: none; position: fixed; z-index: 1000; inset: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, .4); }
        .modal-content { background: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 500px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0, 0, 0, .2); }
        .error-msg { color: #d9534f; font-size: 10px; display: none; }
    </style>
</head>
<body>
<div layout:fragment="content">
    <div class="accountCreate">
        <div class="widget" id="home">
            <h3>ğŸ– ì‚¬ì› ì •ë³´ ë³€ê²½</h3>
            <br>
            <form th:action="@{/hr/updateEmp.hr}" class="form" method="post" id="updateForm" enctype="multipart/form-data">

                <th:block th:with="profileReq=${reqList != null ? reqList.?[fieldName == 'profilePic'] : null}">
                    <div class="profile-section">
                        <img id="profile-preview" class="profile-pic"
                             th:src="${profileReq != null and !profileReq.isEmpty()} ? @{/uploadFiles/{fileName}(fileName=${profileReq[0].newValue})} : @{/images/default_profile.png}"
                             th:data-original-url="@{/images/default_profile.png}"
                             th:data-new-url="${profileReq != null and !profileReq.isEmpty()} ? @{/uploadFiles/{fileName}(fileName=${profileReq[0].newValue})} : @{/images/default_profile.png}"
                             alt="í”„ë¡œí•„"/>

                        <div class="file-input-group">
                            <div th:if="${profileReq != null}" style="margin-bottom:10px;">
                                <button type="button" class="btn ghost" id="originalPicBtn">ê¸°ì¡´ í”„ë¡œí•„</button>
                                <button type="button" class="btn ghost" id="newPicBtn">ë³€ê²½ë  í”„ë¡œí•„</button>
                            </div>
                            <label style="margin-right:10px;"
                                   th:text="${atch != null && atch.originName != null ? atch.originName : 'í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ ì²¨ë¶€'}">í”„ë¡œí•„ ì‚¬ì§„ ë¯¸ ì²¨ë¶€</label>
                            <br>
                            <span>ë³€ê²½í•  í”„ë¡œí•„ ì‚¬ì§„ : </span>
                            <input name="atchFile" type="file" accept="image/*" onchange="previewProfilePic(event)"
                                   th:data-req-id="${profileReq != null} ? 'profilePic' : null"/>
                            <span th:if="${profileReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                            <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                        </div>
                    </div>
                </th:block>

                <div class="field full"><label>ì‚¬ë²ˆ*</label><input name="empNo" th:value="${emp != null ? emp.empNo : ''}" readonly/></div>
                <div class="field full"><label>ì´ë©”ì¼*</label><input name="email" type="email" th:value="${emp != null ? emp.email : ''}" readonly/></div>

                <th:block th:with="lNameReq=${reqList != null ? reqList.?[fieldName == 'empLName'] : null}">
                    <div class="field">
                        <label>ì„±*</label>
                        <input name="empLName" required oninput="validateKorean(this)"
                               th:value="${lNameReq != null and !lNameReq.isEmpty() ? lNameReq[0].newValue : (emp != null ? emp.empLName : '')}"
                               th:data-req-id="${lNameReq != null} ? 'empLName' : null"
                               th:data-original-value="${emp != null ? emp.empLName : ''}"/>
                        <span class="error-msg">í•œê¸€ ì„±/ì´ë¦„ì€ í•œê¸€ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span th:if="${lNameReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="nameReq=${reqList != null ? reqList.?[fieldName == 'empName'] : null}">
                    <div class="field">
                        <label>ì´ë¦„*</label>
                        <input name="empName" required oninput="validateKorean(this)"
                               th:value="${nameReq != null and !nameReq.isEmpty() ? nameReq[0].newValue : (emp != null ? emp.empName : '')}"
                               th:data-req-id="${nameReq != null} ? 'empName' : null"
                               th:data-original-value="${emp != null ? emp.empName : ''}"/>
                        <span class="error-msg">í•œê¸€ ì„±/ì´ë¦„ì€ í•œê¸€ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span th:if="${nameReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="engLNameReq=${reqList != null and !reqList.isEmpty() ? reqList.?[fieldName == 'empEngLName'] : null}">
                    <div class="field">
                        <label>ì˜ë¬¸ ì„±*</label>
                        <input name="empEngLName" required oninput="validateEnglish(this)"
                               th:value="${engLNameReq != null and !engLNameReq.isEmpty() ? engLNameReq[0].newValue : (emp != null ? emp.empEngLName : '')}"
                               th:data-req-id="${engLNameReq != null} ? 'empEngLName' : null"
                               th:data-original-value="${emp != null ? emp.empEngLName : ''}"/>
                        <span class="error-msg">ì˜ë¬¸ ì„±/ì´ë¦„ì€ ì•ŒíŒŒë²³ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span th:if="${engLNameReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="engNameReq=${reqList != null and !reqList.isEmpty() ? reqList.?[fieldName == 'empEngName'] : null}">
                    <div class="field">
                        <label>ì˜ë¬¸ ì´ë¦„*</label>
                        <input name="empEngName" required oninput="validateEnglish(this)"
                               th:value="${engNameReq != null and !engNameReq.isEmpty() ? engNameReq[0].newValue : (emp != null ? emp.empEngName : '')}"
                               th:data-req-id="${engNameReq != null} ? 'empEngName' : null"
                               th:data-original-value="${emp != null ? emp.empEngName : ''}"/>
                        <span class="error-msg">ì˜ë¬¸ ì„±/ì´ë¦„ì€ ì•ŒíŒŒë²³ë§Œ ì…ë ¥í•˜ì„¸ìš”.</span>
                        <span th:if="${engNameReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="birthdayReq=${reqList != null ? reqList.?[fieldName == 'birthday'] : null}">
                    <div class="field">
                        <label>ìƒë…„ì›”ì¼*</label>
                        <input name="birthday" type="date" required
                               th:value="${birthdayReq != null  and !birthdayReq.isEmpty()? birthdayReq[0].newValue : (emp != null ? emp.birthday : '')}"
                               th:data-req-id="${birthdayReq != null} ? 'birthday' : null"
                               th:data-original-value="${emp != null ? emp.birthday : ''}"/>
                        <span th:if="${birthdayReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <div class="field"><label>ë¶€ì„œ*</label>
                    <select name="deptCode" required>
                        <option value="">ì„ íƒ</option>
                        <option value="D1" th:selected="${emp != null and emp.deptCode == 'D1'}">ì¸ì‚¬íŒ€</option>
                        <option value="D2" th:selected="${emp != null and emp.deptCode == 'D2'}">ê²½ì˜ê´€ë¦¬íŒ€</option>
                        <option value="D3" th:selected="${emp != null and emp.deptCode == 'D3'}">ìƒì‚°í’ˆì§ˆê´€ë¦¬íŒ€</option>
                        <option value="D4" th:selected="${emp != null and emp.deptCode == 'D4'}">ê¸°ìˆ ì§€ì›íŒ€</option>
                    </select>
                </div>

                <div class="field"><label>ì§ê¸‰*</label>
                    <select name="jobNo" required> <option value="">ì„ íƒ</option>
                        <option value="5" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ì‚¬ì›')}">ì‚¬ì›</option>
                        <option value="4" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ëŒ€ë¦¬')}">ëŒ€ë¦¬</option>
                        <option value="3" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ê³¼ì¥')}">ê³¼ì¥</option>
                        <option value="2" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ì°¨ì¥')}">ì°¨ì¥</option>
                        <option value="1" th:selected="${emp != null and emp.jobName != null and emp.jobName.endsWith('ë¶€ì¥')}">ë¶€ì¥</option>
                    </select>
                </div>

                <th:block th:with="addressReq=${reqList != null ? reqList.?[fieldName == 'address'] : null}">
                    <div class="field full">
                        <label>ì£¼ì†Œ*</label>
                        <input name="address" required
                               th:value="${addressReq != null and !addressReq.isEmpty() ? addressReq[0].newValue : (emp != null ? emp.address : '')}"
                               th:data-req-id="${addressReq != null} ? 'address' : null"
                               th:data-original-value="${emp != null ? emp.address : ''}"/>
                        <span th:if="${addressReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="phoneReq=${reqList != null ? reqList.?[fieldName == 'phone'] : null}">
                    <div class="field">
                        <label>ì „í™”ë²ˆí˜¸*</label>
                        <input name="phone" required placeholder="010-0000-0000" pattern="^01[016789]-?\d{3,4}-?\d{4}$"
                               th:value="${phoneReq != null and !phoneReq.isEmpty()? phoneReq[0].newValue : (emp != null ? emp.phone : '')}"
                               th:data-req-id="${phoneReq != null} ? 'phone' : null"
                               th:data-original-value="${emp != null ? emp.phone : ''}"/>
                        <span th:if="${phoneReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <th:block th:with="extNoReq=${reqList != null ? reqList.?[fieldName == 'extNo'] : null}">
                    <div class="field">
                        <label>ë‚´ì„ ë²ˆí˜¸</label>
                        <input name="extNo" placeholder="1234" pattern="^\d{3,5}$"
                               th:value="${extNoReq != null and !extNoReq.isEmpty()? extNoReq[0].newValue : (emp != null ? emp.extNo : '')}"
                               th:data-req-id="${extNoReq != null} ? 'extNo' : null"
                               th:data-original-value="${emp != null ? emp.extNo : ''}"/>
                        <span th:if="${extNoReq != null}" class="badge updated-badge">â­ ë³€ê²½ë¨</span>
                        <span class="badge rejected-badge">ê±°ì ˆë¨</span>
                    </div>
                </th:block>

                <div class="field"><label>ì…ì‚¬ì¼*</label><input name="hireDate" type="date" th:value="${emp != null ? emp.hireDate : ''}" readonly/></div>

                <input type="hidden" name="originAtchId" th:value="${(atch != null && atch.atchId != null) ? atch.atchId : ''}"/>
                <input type="hidden" name="originName" th:value="${(atch != null && atch.originName != null) ? atch.originName : ''}"/>
                <input type="hidden" name="changeName" th:value="${(atch != null && atch.changeName != null) ? atch.changeName : ''}"/>
                <input type="hidden" name="refType" th:value="${(atch != null && atch.refType != null) ? atch.refType : ''}"/>
                <input type="hidden" id="jobCode" name="jobCode">
                <th:block th:each="req : ${reqList}">
                    <input type="hidden" th:name="'reqIdMap[' + ${req.fieldName} + ']'" th:value="${req.reqId}"/>
                </th:block>

                <input type="hidden" name="managerId" th:value="${session != null and session.loginEmp != null ? session.loginEmp.empNo : ''}"/>

                <div class="actions">
                    <button class="btn" type="submit" id="submitBtn">ìˆ˜ì • ì‚¬í•­ ë°˜ì˜</button>
                    <button class="btn" id="resetAllBtn" type="button">ì´ˆê¸°í™”</button>
                    <a class="btn ghost" th:href="@{/hr/empAccount.hr}">ì·¨ì†Œ</a>
                </div>
            </form>

            <div id="rejectModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="rejTitle">
                <div class="modal-content">
                    <h3 id="rejTitle">ë³€ê²½ ì‚¬í•­ ê±°ì ˆ ì‚¬ìœ </h3>
                    <textarea id="rejectReason" rows="4" style="width:100%; margin-top:10px;"></textarea>
                    <div style="text-align:right; margin-top:10px;">
                        <button class="btn" id="confirmRejectBtn" type="button">í™•ì¸</button>
                        <button class="btn ghost" id="cancelRejectBtn" type="button">ì·¨ì†Œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('updateForm');
            const rejectModal = document.getElementById('rejectModal');
            const rejectReason = document.getElementById('rejectReason');
            const confirmRejectBtn = document.getElementById('confirmRejectBtn');
            const cancelRejectBtn = document.getElementById('cancelRejectBtn');
            const submitBtn = document.getElementById('submitBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');
            const profilePreview = document.getElementById('profile-preview');
            const fileInput = document.querySelector('input[name="atchFile"]');

            let lastEditedField = null;
            const pendingRejects = {};
            const originalValues = new Map();

            // Store original values on load
            form.querySelectorAll('[data-original-value]').forEach(el => {
                originalValues.set(el.name, el.dataset.originalValue);
            });

            function resolveFieldName(el) {
                if (el.name === 'atchFile') return 'profilePic';
                return el.dataset?.reqId || el.name;
            }

            // Input/change event listener for all relevant fields
            form.addEventListener('change', (e) => {
                const field = e.target;
                const fieldName = resolveFieldName(field);

                if (!fieldName || !field.dataset.reqId) return;

                if (field.type === 'file' && field.files.length > 0) {
                    lastEditedField = field;
                    rejectModal.style.display = 'block';
                } else if (field.type !== 'file' && field.value !== field.dataset.originalValue) {
                    lastEditedField = field;
                    rejectModal.style.display = 'block';
                }
            }, true);

            confirmRejectBtn.addEventListener('click', () => {
                const text = rejectReason.value.trim();
                if (!lastEditedField) {
                    rejectModal.style.display = 'none';
                    return;
                }
                const fieldName = resolveFieldName(lastEditedField);
                if (!fieldName || !text) {
                    alert('ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                pendingRejects[fieldName] = text;

                const container = lastEditedField.closest('.field, .profile-section');
                if (container) {
                    const updatedBadge = container.querySelector('.updated-badge');
                    const rejectedBadge = container.querySelector('.rejected-badge');
                    if (updatedBadge) updatedBadge.style.display = 'none';
                    if (rejectedBadge) rejectedBadge.style.display = 'inline';
                }

                rejectReason.value = '';
                rejectModal.style.display = 'none';
            });

            cancelRejectBtn.addEventListener('click', () => {
                if (lastEditedField) {
                    if (lastEditedField.type === 'file') {
                        lastEditedField.value = '';
                        profilePreview.src = profilePreview.dataset.newUrl;
                    }
                }
                rejectReason.value = '';
                rejectModal.style.display = 'none';
            });

            submitBtn.addEventListener('click', (e) => {
                e.preventDefault();
                const h = document.createElement('input');
                h.type = 'hidden';
                h.name = 'pendingRejects';
                h.value = JSON.stringify(pendingRejects);
                form.appendChild(h);
                form.submit();
            });

            resetAllBtn.addEventListener('click', () => {
                Object.keys(pendingRejects).forEach(k => delete pendingRejects[k]);

                form.querySelectorAll('[data-req-id]').forEach(field => {
                    const container = field.closest('.field, .profile-section');
                    const updatedBadge = container.querySelector('.updated-badge');
                    const rejectedBadge = container.querySelector('.rejected-badge');

                    if (field.name === 'atchFile') {
                        field.value = '';
                        profilePreview.src = profilePreview.dataset.newUrl;
                    } else {
                        field.value = field.dataset.originalValue;
                    }
                    if (updatedBadge) updatedBadge.style.display = 'inline';
                    if (rejectedBadge) rejectedBadge.style.display = 'none';
                });
            });

            document.getElementById('originalPicBtn')?.addEventListener('click', () => {
                lastEditedField = fileInput;
                rejectModal.style.display = 'block';
                profilePreview.src = profilePreview.dataset.originalUrl;
            });

            document.getElementById('newPicBtn')?.addEventListener('click', () => {
                profilePreview.src = profilePreview.dataset.newUrl;
                const container = document.querySelector('.profile-section');
                const updatedBadge = container.querySelector('.updated-badge');
                const rejectedBadge = container.querySelector('.rejected-badge');
                if (updatedBadge) updatedBadge.style.display = 'inline';
                if (rejectedBadge) rejectedBadge.style.display = 'none';
                delete pendingRejects['profilePic'];
            });
        });

        function previewProfilePic(event) {
            const reader = new FileReader();
            const output = document.getElementById('profile-preview');
            const file = event.target.files[0];
            if (file) {
                reader.onload = function(){
                    output.src = reader.result;
                };
                reader.readAsDataURL(file);
            } else {
                output.src = output.dataset.newUrl;
            }
        }

        function validateKorean(input) {
            const korean = /^[ê°€-í£]+$/;
            const errorMsg = input.parentNode.querySelector('.error-msg');
            if (input.value && !korean.test(input.value)) {
                errorMsg.style.display = 'block';
            } else {
                errorMsg.style.display = 'none';
            }
        }

        function validateEnglish(input) {
            const english = /^[a-zA-Z]+$/;
            const errorMsg = input.parentNode.querySelector('.error-msg');
            if (input.value && !english.test(input.value)) {
                errorMsg.style.display = 'block';
            } else {
                errorMsg.style.display = 'none';
            }
        }

        $(document).ready(function() {
            $('select[name="deptCode"], select[name="jobNo"]').on('change', function() {
                updateJobCode();
            });

            // í˜ì´ì§€ ë¡œë“œ ì‹œì—ë„ ì´ˆê¸°ê°’ ì„¤ì •
            updateJobCode();

            function updateJobCode() {
                const deptCode = $('select[name="deptCode"]').val();
                const jobNo = $('select[name="jobNo"]').val();
                let deptInitial = "";

                // ë¶€ì„œ ì½”ë“œì— ë”°ë¼ ì´ˆê¸°ê°’ì„ ì„¤ì •
                switch(deptCode) {
                    case 'D1': deptInitial = 'J1'; break;
                    case 'D2': deptInitial = 'J2'; break;
                    case 'D3': deptInitial = 'J3'; break;
                    case 'D4': deptInitial = 'J4'; break;
                }

                // ë¶€ì„œ ì½”ë“œì™€ ì§ê¸‰ ë²ˆí˜¸ê°€ ëª¨ë‘ ìˆì„ ë•Œë§Œ jobCode ì„¤ì •
                if (deptInitial && jobNo) {
                    const combinedCode = deptInitial + jobNo;
                    $('#jobCode').val(combinedCode);
                } else {
                    // ë‘˜ ì¤‘ í•˜ë‚˜ë¼ë„ ì—†ìœ¼ë©´ jobCodeë¥¼ ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì • (ì„œë²„ ë¡œì§ì—ì„œ ì´ ê°’ì„ ì²˜ë¦¬í•´ì•¼ í•¨)
                    // í˜¹ì€ ê¸°ì¡´ì˜ jobCode ê°’ì„ ìœ ì§€í•˜ë„ë¡ ì„¤ì •
                    // ì—¬ê¸°ì„œëŠ” ê¸°ì¡´ ê°’ì„ ìœ ì§€í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•œ ë°©ë²•ì…ë‹ˆë‹¤.
                    const originalJobCode = "[[${emp.jobCode}]]" || "";
                    $('#jobCode').val(originalJobCode);
                }
            }
        });
    </script>

    <script th:if="${alertMsg}">
        const alertMsg = '[[${alertMsg}]]';
        alertify.alert('ê³„ì • ìˆ˜ì •', alertMsg);
    </script>
</div>
</body>
</html>