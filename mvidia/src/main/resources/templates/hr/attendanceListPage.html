<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>ê·¼íƒœ ëª©ë¡</title>
    <style>
        .hr-Attendance { grid-column: 2; grid-row: 2; background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow); }
        .hr-Attendance > .widget { background: #fff; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0, 0, 0, .1); }
        .page-title { font-size: 20px; margin: 0 0 12px 0; }
        .search-container { display: flex; align-items: center; margin-bottom: 15px; }
        .search-container input, .search-container select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; margin-right: 10px; }
        .search-container button { padding: 8px 12px; border: none; border-radius: 5px; background-color: #0c197f; color: #fff; cursor: pointer; }
        .action-buttons { display: none; }
        .hr-Attendance .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; background-color: #0c197f; color: #fff; }
        .hr-Attendance .btn:hover { background: #0050be; color: #fff; }
        .hr-Attendance .ghost {display: inline-flex; align-items: center; gap: 8px; padding: 5px 14px; margin-bottom:5px; border-radius: 12px; background: transparent; color: #002B39; border: 1px solid #002B39; text-decoration:none; }
        .hr-Attendance .ghost:hover { background: #e7f3f7; }
        .hr-Attendance .att-cancel-btn {display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px; margin-left: 5px; }
        .hr-Attendance .att-cancel-btn:hover { background: #e7f3f7; }
        .time-input { width: 120px; padding: 4px; border: 1px solid #ccc; border-radius: 5px; min-width: 116px; font-size: 13px;}
        .time-input::-webkit-datetime-edit-fields-wrapper { padding: 0 2px; }
        .time-input::-webkit-datetime-edit-hour-field,
        .time-input::-webkit-datetime-edit-minute-field,
        .time-input::-webkit-datetime-edit-ampm-field { padding: 0 1px; }
    </style>
</head>
<body>
<div class="hr-Attendance">
    <h2 class="page-title">ğŸ“‘ ê·¼íƒœ ëª©ë¡</h2>
    <div class="widget" id="home">
        <div class="stack">
            <a class="ghost" href="/hr/integratedAttendance.hr"><i class="bi bi-arrow-return-left"></i> í†µí•© ê´€ë¦¬í˜ì´ì§€ë¡œ</a>
        </div>

        <div class="search-container">
            <input type="text" id="attendanceSearchKeyword" placeholder="ì‚¬ë²ˆ, ì´ë¦„">
            <select id="attendanceSearchStatus">
                <option value="">ìƒíƒœ ì „ì²´</option>
                <option value="N">ì •ìƒ</option>
                <option value="T">ì§€ê°</option>
                <option value="B">ê²°ê·¼</option>
                <option value="E">ì¡°í‡´</option>
                <option value="V">íœ´ê°€</option>
                <option value="O">ì•¼ê·¼</option>
            </select>
            <button id="attendanceSearchBtn">ê²€ìƒ‰</button>
        </div>

        <table class="table mt16">
            <thead><tr><th>#</th><th>ì‚¬ë²ˆ</th><th>ì´ë¦„</th><th>ì¼ì</th><th>ì¶œê·¼</th><th>í‡´ê·¼</th><th>ìƒíƒœ</th><th>ì¡°ì¹˜</th></tr></thead>
            <tbody id="attendList">
            <tr th:if="${#lists.isEmpty(attList)}">
                <td colspan="8" style="text-align: center;">ì¡°íšŒëœ ê·¼íƒœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td>
            </tr>
            <tr th:unless="${#lists.isEmpty(attList)}" th:each="att : ${attList}">
                <td th:text="${attStat.count}"></td>
                <td th:text="${att.empNo}"></td>
                <td th:text="${att.empName}"></td>
                <td th:text="${att.attDate}"></td>
                <td>
                    <input type="time" class="att-arriving-input time-input"
                           th:value="${att.arrivingTime}" th:data-original-arriving="${att.arrivingTime}">
                </td>
                <td>
                    <input type="time" class="att-leaving-input time-input"
                           th:value="${att.leavingTime}" th:data-original-leaving="${att.leavingTime}">
                </td>
                <td>
                    <select class="att-status-select" th:data-original-status="${att.attStatus}">
                        <option value="N" th:selected="${att.attStatus eq 'N'}">ì •ìƒ</option>
                        <option value="T" th:selected="${att.attStatus eq 'T'}">ì§€ê°</option>
                        <option value="B" th:selected="${att.attStatus eq 'B'}">ê²°ê·¼</option>
                        <option value="E" th:selected="${att.attStatus eq 'E'}">ì¡°í‡´</option>
                        <option value="V" th:selected="${att.attStatus eq 'V'}">íœ´ê°€</option>
                        <option value="O" th:selected="${att.attStatus eq 'O'}">ì•¼ê·¼</option>
                    </select>
                </td>
                <td>
                    <div class="action-buttons">
                        <button class="att-update-btn btn" th:data-id="${att.attNo}">ë³€ê²½</button>
                        <button class="att-cancel-btn" th:data-id="${att.attNo}">ì·¨ì†Œ</button>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="stack mt8" id="attendancePager" th:if="${pi.listCount > 0}" align="center">
            <a th:href="@{/hr/attendanceList.hr(cpage=${pi.currentPage-1})}" th:if="${pi.currentPage > 1}">&lt;</a>
            <span th:each="p : ${#numbers.sequence(pi.startPage, pi.endPage)}">
                <a th:href="@{/hr/attendanceList.hr(cpage=${p})}" th:text="${p}" th:class="${pi.currentPage eq p ? 'active' : ''}"></a>
            </span>
            <a th:href="@{/hr/attendanceList.hr(cpage=${pi.currentPage+1})}" th:if="${pi.currentPage < pi.maxPage}">&gt;</a>
        </div>
    </div>
</div>
<script th:inline="javascript">
    const contextPath = [[@{/}]];

    // ê°’ ë³€ê²½ ê°ì§€ ë° ë²„íŠ¼ í‘œì‹œ
    $(document).on('change', '.att-status-select, .att-arriving-input, .att-leaving-input', function() {
        const row = $(this).closest('tr');
        const statusSelect = row.find('.att-status-select');
        const arrivingInput = row.find('.att-arriving-input');
        const leavingInput = row.find('.att-leaving-input');

        // ì›ë³¸ ê°’ê³¼ í˜„ì¬ ê°’ì´ ë‹¤ë¥´ë©´ ë²„íŠ¼ í‘œì‹œ
        if (statusSelect.val() !== statusSelect.data('original-status') ||
            arrivingInput.val() !== arrivingInput.data('original-arriving') ||
            leavingInput.val() !== leavingInput.data('original-leaving')) {
            row.find('.action-buttons').css('display', 'flex');
        } else {
            row.find('.action-buttons').css('display', 'none');
        }
    });

    // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
    $(document).on('click', '.att-cancel-btn', function() {
        const row = $(this).closest('tr');
        const statusSelect = row.find('.att-status-select');
        const arrivingInput = row.find('.att-arriving-input');
        const leavingInput = row.find('.att-leaving-input');

        // ì›ë˜ ê°’ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
        statusSelect.val(statusSelect.data('original-status'));
        arrivingInput.val(arrivingInput.data('original-arriving'));
        leavingInput.val(leavingInput.data('original-leaving'));

        // ë²„íŠ¼ ìˆ¨ê¸°ê¸°
        row.find('.action-buttons').css('display', 'none');
    });

    // ë³€ê²½ ë²„íŠ¼ í´ë¦­ ì‹œ
    $(document).on('click', '.att-update-btn', function() {
        const attNo = $(this).data('id');
        const row = $(this).closest('tr');
        const newStatus = row.find('.att-status-select').val();
        const newArriving = row.find('.att-arriving-input').val();
        const newLeaving = row.find('.att-leaving-input').val();

        // ì¶œê·¼ ì‹œê°„, í‡´ê·¼ ì‹œê°„, ìƒíƒœ ê°’ì„ í•¨ê»˜ ì „ë‹¬
        $.ajax({
            url: contextPath + 'hr/attendances/update',
            type: 'POST',
            data: {
                attNo: attNo,
                attStatus: newStatus,
                arrivingTime: newArriving,
                leavingTime: newLeaving
            },
            success: function(response) {
                if (response.success) {
                    alert('ê·¼íƒœ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // ì›ë³¸ ë°ì´í„° ì—…ë°ì´íŠ¸
                    row.find('.att-status-select').data('original-status', newStatus);
                    row.find('.att-arriving-input').data('original-arriving', newArriving);
                    row.find('.att-leaving-input').data('original-leaving', newLeaving);
                    row.find('.action-buttons').css('display', 'none');
                } else {
                    alertify.alert('ê·¼íƒœ ì •ë³´ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + response.message);
                }
            },
            error: function(xhr) {
                console.error("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ", xhr.responseText);
                alert('ì„œë²„ ì˜¤ë¥˜ë¡œ ì—…ë°ì´íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });
    });

    // ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ
    $('#attendanceSearchBtn').on('click', function() {
        const keyword = $('#attendanceSearchKeyword').val();
        const status = $('#attendanceSearchStatus').val();

        window.location.href = contextPath + 'hr/attendanceList.hr?cpage=1&keyword=' + encodeURIComponent(keyword) + '&status=' + encodeURIComponent(status);
    });
</script>
</body>
</html>