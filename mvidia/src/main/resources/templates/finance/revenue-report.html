<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}"
      layout:fragment="content">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <style>
        .table-wrapper {
            margin: 20px auto;
            width: 95%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #0050be;
            color: white;
        }
    </style>
</head>
<body>
    <h2 th:text="${year} + '년 분기별 수익조회'"></h2>
    <div class="table-wrapper">
        <table>
            <thead>
            <tr>
                <th>제품군</th>
                <th>1분기 매출</th>
                <th>2분기 매출</th>
                <th>3분기 매출</th>
                <th>4분기 매출</th>
                <th>합계</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="p : ${profitList}">
                <td th:text="${p.prodName}"></td>
                <td th:text="${p.quarter == '1' ? p.totalSales : ''}"></td>
                <td th:text="${p.quarter == '2' ? p.totalSales : ''}"></td>
                <td th:text="${p.quarter == '3' ? p.totalSales : ''}"></td>
                <td th:text="${p.quarter == '4' ? p.totalSales : ''}"></td>
                <td th:text="${p.totalSales}"></td>
            </tr>
            </tbody>
        </table>
    </div>
    <div style="width:90%; margin:30px auto;">
        <canvas id="profitChart"></canvas>
    </div>

    <script th:inline="javascript">
        const profitList = /*[[${profitList}]]*/ [];

        const quarters = ["1분기", "2분기", "3분기", "4분기"];
        const totalSales = [0, 0, 0, 0];
        const totalProfit = [0, 0, 0, 0];

        profitList.forEach(p => {
            const q = parseInt(p.quarter) - 1;
            totalSales[q] += parseInt(p.totalSales);
            totalProfit[q] += parseInt(p.opProfit);
        });

        new Chart(document.getElementById("profitChart"), {
            type: "bar",
            data: {
                labels: quarters,
                datasets: [
                    {
                        label: "총매출",
                        data: totalSales,
                        backgroundColor: "rgba(0, 80, 190, 0.7)",
                        yAxisID: 'y',
                    },
                    {
                        label: "영업이익",
                        data: totalProfit,
                        type: "line",
                        borderColor: "orange",
                        borderWidth: 2,
                        fill: false,
                        yAxisID: 'y1',
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: { display: true, text: '매출 (억원)' }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: { display: true, text: '영업이익 (억원)' }
                    }
                }
            }
        });
    </script>

</body>
</html>